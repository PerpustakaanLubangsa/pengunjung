<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Log Kunjungan Perpustakaan</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <script>
      // üí° Palet Warna Baru: Indigo & Cyan
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Poppins', 'sans-serif'],
            },
            colors: {
              'primary-indigo': '#4F46E5', // Indigo 600
              'light-bg': '#F9FAFB',      // Gray 50 (Background)
              'card-bg': '#FFFFFF',       // Card Background
              'accent-cyan': '#06B6D4',   // Cyan 500 (Aksen/Pencarian)
            }
          }
        }
      }
    </script>

    <style>
        body {
            background-color: theme('colors.light-bg'); 
            font-family: 'Poppins', sans-serif;
        }
        .container {
            max-width: 1280px;
        }
        /* --- Gaya Tabel Kustom --- */
        .table-container {
            max-height: 60vh; 
            overflow-y: auto;
            border: 1px solid theme('colors.gray.200');
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); /* Shadow lebih lembut */
            background-color: theme('colors.card-bg');
        }
        th {
            background-color: theme('colors.gray.50'); /* Header Background */
            color: theme('colors.gray.600'); 
            position: sticky; 
            top: 0;
            z-index: 20;
            border-bottom: 2px solid theme('colors.indigo.100');
            font-weight: 600;
            letter-spacing: 0.05em;
        }
        td {
            padding: 12px 16px;
        }
        .data-row:nth-child(even) {
            background-color: theme('colors.gray.50'); /* Stripe/Garis selang-seling */
        }
        .data-row:hover {
            background-color: theme('colors.indigo.50'); /* Efek hover yang lebih jelas */
        }
        .btn-action {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .input-style {
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid theme('colors.gray.300');
            transition: all 0.2s;
        }
        .input-style:focus {
            border-color: theme('colors.primary-indigo');
            box-shadow: 0 0 0 3px theme('colors.primary-indigo', 0.1);
        }
    </style>
</head>
<body class="p-6 sm:p-10">

    <div class="container mx-auto">
        <header class="p-6 rounded-xl text-white mb-8 bg-primary-indigo shadow-2xl">
            <h1 class="text-3xl sm:text-4xl font-extrabold flex items-center">
                <svg class="w-8 h-8 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                Dashboard Log Kunjungan
            </h1>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div id="totalAllTime" class="p-6 bg-card-bg border border-gray-200 rounded-xl shadow-lg flex flex-col items-start">
                <p class="text-sm font-medium text-gray-500">Total Kunjungan (Semua)</p>
                <span class="text-4xl font-extrabold text-primary-indigo mt-1">0</span>
            </div>
            <div id="totalToday" class="p-6 bg-card-bg border border-gray-200 rounded-xl shadow-lg flex flex-col items-start">
                <p class="text-sm font-medium text-gray-500">Kunjungan Hari Ini</p>
                <span class="text-4xl font-extrabold text-green-600 mt-1">0</span>
            </div>
            <div id="dataStatus" class="p-6 bg-yellow-50 border border-yellow-300 rounded-xl shadow-lg text-sm flex flex-col justify-center">
                <p class="font-medium text-yellow-800">Status Data:</p>
                <span class="text-yellow-600 mt-1">Memuat data log dari Firebase...</span>
            </div>
        </div>

        <div class="flex flex-col lg:flex-row gap-4 mb-8 items-stretch">
            <input type="text" id="searchInput" placeholder="Cari Nama, NIS, Judul Buku..." class="input-style flex-grow focus:ring-accent-cyan focus:border-accent-cyan shadow-md">
            
            <div class="flex gap-4">
                <button id="btnCopyAll" class="btn-action bg-accent-cyan hover:bg-cyan-600 text-white flex-shrink-0">
                    <svg class="w-5 h-5 inline-block mr-1 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7z"></path></svg>
                    Salin Semua
                </button>
                <button id="btnDeleteAll" class="btn-action bg-red-500 hover:bg-red-600 text-white flex-shrink-0">
                    <svg class="w-5 h-5 inline-block mr-1 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    Hapus Semua
                </button>
            </div>
        </div>

        <div class="table-container">
            <table class="min-w-full divide-y divide-gray-200">
                <thead>
                    <tr>
                        <th class="px-4 py-3 text-left text-xs uppercase tracking-wider">Tanggal</th>
                        <th class="px-4 py-3 text-left text-xs uppercase tracking-wider">Nama Santri</th>
                        <th class="px-4 py-3 text-left text-xs uppercase tracking-wider">Blok</th>
                        <th class="px-4 py-3 text-left text-xs uppercase tracking-wider">Jenjang</th>
                        <th class="px-4 py-3 text-left text-xs uppercase tracking-wider">Judul Buku</th>
                        <th class="px-4 py-3 text-left text-xs uppercase tracking-wider">Kategori</th>
                        <th class="px-4 py-3 text-left text-xs uppercase tracking-wider">Aktivitas</th>
                        <th class="px-4 py-3 text-left text-xs uppercase tracking-wider">Aksi</th>
                    </tr>
                </thead>
                <tbody id="dataTable" class="bg-white divide-y divide-gray-100 text-sm">
                    </tbody>
            </table>
        </div>
        
        <div id="noResults" class="hidden text-center text-gray-500 mt-12 text-xl font-medium p-10 bg-card-bg rounded-xl shadow-lg border border-gray-200">
            <svg class="w-12 h-12 mx-auto mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            Tidak ada data log yang cocok dengan kriteria pencarian atau filter saat ini.
        </div>

    </div>

    <script type="module">
        // --- FIREBASE IMPORTS & CONFIG ---
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
        import { getDatabase, ref, onValue, remove } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';

        // !!! KRITIS: GANTI DENGAN CONFIG FIREBASE ASLI PROYEK TRAYING-29BF4 !!!
        const firebaseConfig = {
            apiKey: "AIzaSy_GANTI_INI_DENGAN_KUNCI_API_ASLI", 
            authDomain: "traying-29bf4.firebaseapp.com", 
            projectId: "traying-29bf4", 
            storageBucket: "traying-29bf4.appspot.com", 
            messagingSenderId: "GANTI_DENGAN_SENDER_ID_ASLI", 
            appId: "1:GANTI_DENGAN_APP_ID_ASLI", 
            databaseURL: "https://traying-29bf4-default-rtdb.firebaseio.com" 
        };

        const DATA_PATH = 'log_kunjungan_2025';

        try {
            const app = initializeApp(firebaseConfig);
            const db = getDatabase(app);

            const $ = id => document.getElementById(id);
            const dataTable = $('dataTable');
            const dataStatus = $('dataStatus');
            const searchInput = $('searchInput');
            const noResults = $('noResults');
            const btnCopyAll = $('btnCopyAll');
            const btnDeleteAll = $('btnDeleteAll');
            const totalAllTimeSpan = $('totalAllTime').querySelector('span');
            const totalTodaySpan = $('totalToday').querySelector('span');

            let logData = []; 

            const getTodayDateString = () => {
                const today = new Date();
                return `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`;
            };
            const todayDateString = getTodayDateString();

            // --- FUNGSI TAMPIL DATA KE TABEL ---
            function renderTable(dataToRender) {
                dataTable.innerHTML = '';
                
                if (dataToRender.length === 0) {
                    noResults.classList.remove('hidden');
                    return;
                }
                noResults.classList.add('hidden');

                dataToRender.sort((a, b) => b.timestamp - a.timestamp);

                dataToRender.forEach(item => {
                    const row = document.createElement('tr');
                    row.classList.add('data-row'); // Tambahkan class data-row untuk styling stripe/hover
                    row.setAttribute('data-id', item.id); 

                    const tanggalKunjungan = `${item.tanggal}/${item.bulan}/${item.tahun}`;

                    let keteranganColor = 'text-gray-900 bg-gray-100';
                    if (item.keterangan === 'Pinjam') {
                        keteranganColor = 'text-indigo-700 bg-indigo-100 font-semibold';
                    } else if (item.keterangan === 'Baca') {
                        keteranganColor = 'text-green-700 bg-green-100 font-semibold';
                    }

                    row.innerHTML = `
                        <td class="px-4 py-3 whitespace-nowrap text-gray-700">${tanggalKunjungan}</td>
                        <td class="px-4 py-3 whitespace-nowrap font-medium text-gray-800">${item.nama}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-gray-600">${item.blok}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-gray-600">${item.jenjang}</td>
                        <td class="px-4 py-3 text-gray-800">${item.judulBuku}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-gray-600">${item.kategoriBuku}</td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold ${keteranganColor}">${item.keterangan}</span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <button data-id="${item.id}" class="btn-delete-row text-red-500 hover:text-red-700 font-semibold text-sm transition duration-150">Hapus</button>
                        </td>
                    `;
                    dataTable.appendChild(row);
                });
            }

            // --- FUNGSI PENCARIAN ---
            function handleSearch() {
                const searchTerm = searchInput.value.toLowerCase().trim();

                if (!searchTerm) {
                    renderTable(logData); 
                    return;
                }

                const filteredData = logData.filter(item => {
                    return (
                        item.nama.toLowerCase().includes(searchTerm) ||
                        item.nis.toLowerCase().includes(searchTerm) || 
                        item.judulBuku.toLowerCase().includes(searchTerm) ||
                        item.kodeBuku.toLowerCase().includes(searchTerm) || 
                        item.keterangan.toLowerCase().includes(searchTerm) ||
                        item.blok.toLowerCase().includes(searchTerm)
                    );
                });

                renderTable(filteredData);
            }
            
            // --- FUNGSI HAPUS SATU ENTRI ---
            function deleteEntry(id) {
                remove(ref(db, `${DATA_PATH}/${id}`))
                    .then(() => {
                        console.log("Log berhasil dihapus:", id);
                    })
                    .catch((error) => {
                        alert("Gagal menghapus log: " + error.message);
                        console.error("Gagal menghapus log:", error);
                    });
            }

            // --- FUNGSI HAPUS SEMUA ENTRI ---
            function deleteAllEntries() {
                remove(ref(db, DATA_PATH))
                    .then(() => {
                        alert("‚úÖ Semua log kunjungan berhasil dihapus.");
                    })
                    .catch((error) => {
                        alert("Gagal menghapus semua log: " + error.message);
                        console.error("Gagal menghapus semua log:", error);
                    });
            }
            
            // --- FUNGSI SALIN SEMUA DATA ---
            function copyTableData() {
                const table = dataTable.closest('table');
                if (!table) return;

                let textToCopy = '';
                
                // 1. Dapatkan Header (Kecuali kolom terakhir "Aksi")
                const headerRow = table.querySelector('thead tr');
                const headers = Array.from(headerRow.querySelectorAll('th:not(:last-child)')).map(th => th.textContent.trim());
                textToCopy += headers.join('\t') + '\n'; 

                // 2. Dapatkan Data Baris (Kecuali kolom terakhir "Aksi")
                const rows = dataTable.querySelectorAll('tr');
                rows.forEach(row => {
                    // Ambil teks dari setiap sel, kecuali sel terakhir (Aksi)
                    const cells = Array.from(row.querySelectorAll('td:not(:last-child)')).map(td => {
                        // Untuk kolom Keterangan/Aktivitas, ambil teks murni, bukan dengan styling div
                        if (td.querySelector('span')) {
                            return td.querySelector('span').textContent.trim();
                        }
                        return td.textContent.trim();
                    });
                    textToCopy += cells.join('\t') + '\n'; 
                });

                // 3. Salin ke Clipboard
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(textToCopy)
                        .then(() => {
                            const originalText = btnCopyAll.textContent;
                            btnCopyAll.textContent = '‚úÖ Berhasil Disalin!';
                            setTimeout(() => { btnCopyAll.textContent = originalText; }, 2000);
                        })
                        .catch(err => {
                            console.error('Gagal menyalin:', err);
                            alert('Gagal menyalin data. Cek konsol (F12) untuk detail.');
                        });
                } else {
                    alert("Browser Anda tidak mendukung Clipboard API. Silakan salin manual data di konsol.");
                    console.log(textToCopy);
                }
            }


            // --- DATA LISTENER DARI FIREBASE ---
            onValue(ref(db, DATA_PATH), (snapshot) => {
                const data = snapshot.val();
                
                if (data) {
                    logData = Object.keys(data).map(key => ({ 
                        id: key, 
                        ...data[key] 
                    }));
                    
                    // UPDATE STATISTIK
                    const todayVisitors = logData.filter(item => {
                        const itemDateString = `${item.tanggal}/${item.bulan}/${item.tahun}`;
                        return itemDateString === todayDateString;
                    });

                    totalAllTimeSpan.textContent = logData.length;
                    totalTodaySpan.textContent = todayVisitors.length;

                    dataStatus.innerHTML = `<p class="font-medium text-green-800">Status Data:</p><span class="text-green-600 mt-1">‚úÖ ${logData.length} entri log berhasil dimuat.</span>`;
                    dataStatus.classList.remove('bg-yellow-50', 'bg-red-50', 'border-yellow-300', 'border-red-300');
                    dataStatus.classList.add('bg-green-50', 'border-green-300');
                } else {
                    logData = [];
                    totalAllTimeSpan.textContent = 0;
                    totalTodaySpan.textContent = 0;
                    dataStatus.innerHTML = `<p class="font-medium text-red-800">Status Data:</p><span class="text-red-600 mt-1">‚ö†Ô∏è Data log kunjungan masih kosong.</span>`;
                    dataStatus.classList.remove('bg-yellow-50', 'bg-green-50', 'border-yellow-300', 'border-green-300');
                    dataStatus.classList.add('bg-red-50', 'border-red-300');
                }

                renderTable(logData); 
            }, (error) => {
                console.error("FIREBASE ERROR (log_kunjungan_2025):", error);
                dataStatus.innerHTML = `<p class="font-medium text-red-800">Status Data:</p><span class="text-red-600 mt-1">‚ùå KRITIS: GAGAL memuat data. Cek Konsol (F12).</span>`;
                dataStatus.classList.remove('bg-yellow-50', 'bg-green-50', 'border-yellow-300', 'border-green-300');
                dataStatus.classList.add('bg-red-50', 'border-red-300');
            });

            // --- EVENT LISTENERS ---
            searchInput.addEventListener('input', handleSearch);

            btnDeleteAll.addEventListener('click', () => {
                if (confirm("‚ö†Ô∏è PERINGATAN KRITIS: Anda yakin ingin MENGHAPUS SEMUA data log kunjungan? Tindakan ini TIDAK dapat dibatalkan!")) {
                    deleteAllEntries();
                }
            });

            btnCopyAll.addEventListener('click', copyTableData);

            dataTable.addEventListener('click', (e) => {
                const deleteButton = e.target.closest('.btn-delete-row');
                if (deleteButton) {
                    const id = deleteButton.getAttribute('data-id');
                    const row = deleteButton.closest('tr');
                    const nama = row.cells[1].textContent.trim(); 
                    if (confirm(`Yakin ingin menghapus log kunjungan dari: ${nama}?`)) {
                        deleteEntry(id);
                    }
                }
            });

        } catch (e) {
            console.error("FIREBASE INITIALIZATION ERROR:", e);
            dataStatus.innerHTML = `<p class="font-medium text-red-800">Status Data:</p><span class="text-red-600 mt-1">‚ùå KRITIS: Gagal menginisialisasi Firebase. Cek konfigurasi Anda.</span>`;
            dataStatus.classList.remove('bg-yellow-50', 'bg-green-50', 'border-yellow-300', 'border-green-300');
            dataStatus.classList.add('bg-red-50', 'border-red-300');
        }
    </script>
</body>
</html>
