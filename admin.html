<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard Lengkap</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <style>
    /* Custom Tailwind Colors */
    .bg-gradient-to-br-main {
      /* Gradasi gelap ke cyan (Latar Belakang Utama) */
      background-image: linear-gradient(to bottom right, #0F172A, #06B6D4); 
    }
    .bg-sidebar-gradient {
        /* Gradasi biru gelap (Sidebar) */
        background-image: linear-gradient(to bottom, #1E3A8A, #0C4A6E); 
    }

    /* Keterbacaan Maksimal: Header tabel solid putih dengan teks gelap/terang yang sesuai */
    #tableSantri thead th, #tableBuku thead th, #tablePengunjung thead th {
        @apply sticky top-0 bg-white text-gray-800 p-3 text-sm; 
        border-bottom: 2px solid #06B6D4; /* Border Cyan */
        font-weight: 700; /* Bold header */
    }
    /* Khusus untuk Pengunjung, latar belakang header gelap agar kontras dengan latar utama yang gelap */
    #sectionPengunjung #tablePengunjung thead th {
        @apply bg-gray-800 text-white;
        border-bottom-color: #06B6D4;
    }
    /* Baris ganjil/genap untuk semua tabel */
    #tableSantri tbody tr:nth-child(even), #tableBuku tbody tr:nth-child(even), #tablePengunjung tbody tr:nth-child(even) {
        @apply bg-gray-50;
    }

    #log {
      min-height: 20px;
      transition: color 0.3s ease;
    }
    html, body {
        padding: 0;
        margin: 0;
        font-family: 'Inter', sans-serif;
    }
  </style>
</head>
<body class="bg-gradient-to-br-main text-gray-100 flex min-h-screen">
  
  <aside id="sidebar" class="w-20 bg-sidebar-gradient shadow-2xl flex flex-col items-center py-6 space-y-6 fixed top-0 left-0 h-full border-r border-cyan-800 z-10">
    
    <div class="text-cyan-300 text-3xl mb-6 p-1">
        <i class="fa-solid fa-cloud"></i> 
    </div>
    
    <button id="tabPengunjung" title="Pengunjung" class="w-14 h-14 flex items-center justify-center rounded-2xl text-2xl bg-cyan-500 text-white shadow-lg hover:bg-cyan-600 transition-all duration-300 ease-in-out transform hover:scale-105">
        <i class="fa-solid fa-users"></i> 
    </button>
    <button id="tabSantri" title="Santri" class="w-14 h-14 flex items-center justify-center rounded-2xl text-2xl text-cyan-200 hover:bg-cyan-700/50 hover:text-white transition-all duration-300 ease-in-out transform hover:scale-105">
        <i class="fa-solid fa-book-open"></i>
    </button>
    <button id="tabBuku" title="Buku" class="w-14 h-14 flex items-center justify-center rounded-2xl text-2xl text-cyan-200 hover:bg-cyan-700/50 hover:text-white transition-all duration-300 ease-in-out transform hover:scale-105">
        <i class="fa-solid fa-book"></i>
    </button>
  </aside>

  <div class="flex-grow ml-20 p-8 w-full max-w-7xl mx-auto"> 
    <header class="mb-8">
      <h1 class="text-3xl font-extrabold text-white leading-tight">Admin Dashboard</h1>
      <p class="text-md text-cyan-200 opacity-90 mt-1">Kelola data santri, buku, dan pantau pengunjung perpustakaan dengan mudah.</p>
    </header>

    <div class="bg-white/10 rounded-3xl shadow-2xl p-7 border border-cyan-700/50">
      
      <section id="sectionPengunjung" class="text-gray-100">
        <h3 class="font-semibold text-xl mb-3 text-white">Data Pengunjung</h3>
        <p class="text-sm text-cyan-200 opacity-80 mb-4">Data kunjungan dengan Tanggal diformat menjadi DD/MM/YYYY.</p>
        
        <div class="overflow-auto max-h-[520px] rounded-xl border border-cyan-700/30 bg-white p-2 shadow-inner">
          <table id="tablePengunjung" class="min-w-full text-sm text-gray-800">
            <tbody>
                <tr><td colspan="7" class="text-center p-4 text-gray-500">Data sedang dimuat...</td></tr>
            </tbody>
          </table>
        </div>
        
        <div class="mt-4 flex flex-wrap gap-3">
          <button type="button" id="copyPengunjung" class="px-5 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition duration-200">
            <i class="fa-solid fa-copy mr-2"></i> Salin Semua Data
          </button>

          <button type="button" id="exportPengunjung" class="px-5 py-2 bg-cyan-600 text-white rounded-lg shadow-md hover:bg-cyan-700 transition duration-200">
            <i class="fa-solid fa-download mr-2"></i> Ekspor CSV
          </button>
          
          <button type="button" id="deleteAllPengunjung" class="px-5 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition duration-200 ml-auto">
            <i class="fa-solid fa-trash-alt mr-2"></i> Hapus Semua Data
          </button>
        </div>
      </section>

      <section id="sectionSantri" class="hidden text-gray-100">
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <h3 class="font-semibold text-xl mb-3 text-white">Tambah / Edit Santri</h3>
            <div class="space-y-3">
              <input type="text" id="s_nis" placeholder="NIS" class="w-full px-4 py-2 bg-white/20 border border-cyan-700/50 rounded-lg text-white placeholder-gray-300 focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition" data-mode="add" />
              <input type="text" id="s_nama" placeholder="Nama" class="w-full px-4 py-2 bg-white/20 border border-cyan-700/50 rounded-lg text-white placeholder-gray-300 focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition" />
              <input type="text" id="s_blok" placeholder="Blok / Kamar" class="w-full px-4 py-2 bg-white/20 border border-cyan-700/50 rounded-lg text-white placeholder-gray-300 focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition" />
              <input type="text" id="s_jenjang" placeholder="Jenjang (SLTP/SLTA/PT)" class="w-full px-4 py-2 bg-white/20 border border-cyan-700/50 rounded-lg text-white placeholder-gray-300 focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition" />
              <div class="flex gap-3">
                <button type="button" id="btnAddSantri" class="px-5 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition duration-200">
                  <i class="fa-solid fa-save mr-2"></i> Simpan Data
                </button>
                <button type="button" id="btnClearSantri" class="px-5 py-2 bg-gray-600 text-white rounded-lg shadow-md hover:bg-gray-700 transition duration-200">
                  <i class="fa-solid fa-eraser mr-2"></i> Bersihkan Form
                </button>
              </div>
              <p id="s_edit_status" class="text-sm text-yellow-400 hidden">Mode Edit: NIS tidak dapat diubah.</p>
            </div>

            <hr class="my-6 border-cyan-700/50" />

            <label class="block mb-3 font-semibold text-white">Upload Excel (Santri) — kolom: <code>NIS, Nama, Blok, Jenjang</code></label>
            <div class="flex gap-4 items-center mb-4">
              <input id="fileSantri" type="file" accept=".xlsx,.xls" class="block w-full text-sm text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cyan-500 file:text-white hover:file:bg-cyan-600 cursor-pointer"/>
              <button type="button" id="previewSantri" class="px-5 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition duration-200">
                <i class="fa-solid fa-eye mr-2"></i> Pratinjau
              </button>
              <button type="button" id="uploadSantri" class="px-5 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition duration-200">
                <i class="fa-solid fa-upload mr-2"></i> Upload ke Firebase
              </button>
            </div>
            <div id="previewAreaSantri" class="overflow-auto max-h-48 rounded-xl border border-cyan-700/30 bg-white p-3 shadow-inner text-gray-800"></div>
          </div>

          <div>
            <h3 class="font-semibold text-xl mb-3 text-white">Daftar Santri</h3>
            <div class="overflow-auto max-h-[480px] rounded-xl border border-cyan-700/30 bg-white shadow-inner">
              <table id="tableSantri" class="min-w-full text-sm text-gray-800"></table>
            </div>
          </div>
        </div>
      </section>

      <section id="sectionBuku" class="hidden text-gray-100">
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <h3 class="font-semibold text-xl mb-3 text-white">Tambah / Edit Buku</h3>
            <div class="space-y-3">
              <input type="text" id="b_kode" placeholder="Kode" class="w-full px-4 py-2 bg-white/20 border border-cyan-700/50 rounded-lg text-white placeholder-gray-300 focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition" data-mode="add" />
              <input type="text" id="b_judul" placeholder="Judul" class="w-full px-4 py-2 bg-white/20 border border-cyan-700/50 rounded-lg text-white placeholder-gray-300 focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition" />
              <input type="text" id="b_kategori" placeholder="Kategori" class="w-full px-4 py-2 bg-white/20 border border-cyan-700/50 rounded-lg text-white placeholder-gray-300 focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition" />
              <div class="flex gap-3">
                <button type="button" id="btnAddBuku" class="px-5 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition duration-200">
                  <i class="fa-solid fa-save mr-2"></i> Simpan Data
                </button>
                <button type="button" id="btnClearBuku" class="px-5 py-2 bg-gray-600 text-white rounded-lg shadow-md hover:bg-gray-700 transition duration-200">
                  <i class="fa-solid fa-eraser mr-2"></i> Bersihkan Form
                </button>
              </div>
              <p id="b_edit_status" class="text-sm text-yellow-400 hidden">Mode Edit: Kode tidak dapat diubah.</p>
            </div>

            <hr class="my-6 border-cyan-700/50" />

            <label class="block mb-3 font-semibold text-white">Upload Excel (Buku) — kolom: <code>Kode, Judul, Kategori</code></label>
            <div class="flex gap-4 items-center mb-4">
              <input id="fileBuku" type="file" accept=".xlsx,.xls" class="block w-full text-sm text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cyan-500 file:text-white hover:file:bg-cyan-600 cursor-pointer"/>
              <button type="button" id="previewBuku" class="px-5 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition duration-200">
                <i class="fa-solid fa-eye mr-2"></i> Pratinjau
              </button>
              <button type="button" id="uploadBuku" class="px-5 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition duration-200">
                <i class="fa-solid fa-upload mr-2"></i> Upload ke Firebase
              </button>
            </div>
            <div id="previewAreaBuku" class="overflow-auto max-h-48 rounded-xl border border-cyan-700/30 bg-white p-3 shadow-inner text-gray-800"></div>
          </div>

          <div>
            <h3 class="font-semibold text-xl mb-3 text-white">Daftar Buku</h3>
            <div class="overflow-auto max-h-[480px] rounded-xl border border-cyan-700/30 bg-white shadow-inner">
              <table id="tableBuku" class="min-w-full text-sm text-gray-800"></table>
            </div>
          </div>
        </div>
      </section>

      <hr class="my-6 border-cyan-700/50" />
      <div id="log" class="text-sm text-gray-300 font-medium">Siap.</div>
    </div>

    <footer class="mt-8 text-xs text-cyan-200 opacity-70 text-center">Admin Dashboard v1.0 | Pastikan Realtime Database mengizinkan akses/penulisan dari client untuk pengujian awal.</footer>
  </div>
  
  <div id="customModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50 transition-opacity duration-300">
    <div class="bg-white rounded-xl shadow-2xl overflow-hidden w-full max-w-md m-4 transform transition-all duration-300 scale-95 opacity-0" id="modalContent">
      <div class="p-6 text-gray-800">
        <h4 id="modalTitle" class="text-xl font-bold mb-4">Konfirmasi Tindakan</h4>
        <p id="modalMessage" class="text-gray-600 mb-6">Apakah Anda yakin ingin melanjutkan tindakan ini?</p>
        <div class="flex justify-end space-x-3">
          <button id="modalCancel" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition duration-200">
            Tutup
          </button>
          <button id="modalConfirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-200">
            Ya, Hapus
          </button>
        </div>
      </div>
    </div>
  </div>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getDatabase, ref, set, get, child, remove, onValue } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';

    // =========================================================
    // KONFIGURASI FIREBASE (DARI INPUT TERAKHIR ANDA)
    // =========================================================
    const firebaseConfig = {
      apiKey: "AIzaSyB6gaVW3ye680YylqzSebZugmQepYRA4g4",
      authDomain: "pengunjung-4489b.firebaseapp.com",
      projectId: "pengunjung-4489b",
      storageBucket: "pengunjung-4489b.firebasestorage.app",
      messagingSenderId: "233634425303",
      appId: "1:233634425303:web:9d45d775e703b94843c392",
      databaseURL: "https://pengunjung-4489b-default-rtdb.firebaseio.com" 
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const logEl = document.getElementById('log');
    let currentPengunjungData = null; 

    function showLog(message, isError = false) {
        logEl.classList.remove('text-green-400', 'text-red-400', 'text-gray-300');
        logEl.classList.add(isError ? 'text-red-400' : 'text-green-400');
        logEl.innerText = message;
    }
    
    // =========================================================
    // MODAL LOGIC (PENGGANTI confirm() )
    // =========================================================
    const customModal = document.getElementById('customModal');
    const modalContent = document.getElementById('modalContent');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const modalCancel = document.getElementById('modalCancel');
    const modalConfirm = document.getElementById('modalConfirm');

    let confirmCallback = null;

    function showCustomConfirm(title, message, callback) {
        modalTitle.textContent = title;
        // Gunakan innerHTML agar tag <strong> atau <b> bisa terbaca
        modalMessage.innerHTML = message; 
        confirmCallback = callback;
        
        // Setup confirmation button text and color based on title
        if (title.toLowerCase().includes('hapus') || title.toLowerCase().includes('peringatan')) {
            modalConfirm.textContent = 'Ya, Hapus';
            modalConfirm.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            modalConfirm.classList.add('bg-red-600', 'hover:bg-red-700');
        } else {
            modalConfirm.textContent = 'Ya, Lanjutkan';
            modalConfirm.classList.remove('bg-red-600', 'hover:bg-red-700');
            modalConfirm.classList.add('bg-blue-600', 'hover:bg-blue-700');
        }
        
        // Show modal with animation
        customModal.classList.remove('hidden');
        customModal.classList.add('flex');
        setTimeout(() => {
            modalContent.classList.remove('scale-95', 'opacity-0');
            modalContent.classList.add('scale-100', 'opacity-100');
            modalConfirm.focus(); // Fokuskan ke tombol konfirmasi
        }, 10);
    }

    function hideCustomConfirm() {
        modalContent.classList.remove('scale-100', 'opacity-100');
        modalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            customModal.classList.add('hidden');
            customModal.classList.remove('flex');
            confirmCallback = null;
        }, 300);
    }

    // Modal listeners
    modalCancel.addEventListener('click', hideCustomConfirm);
    modalConfirm.addEventListener('click', () => {
        if (confirmCallback) {
            confirmCallback(true); // Panggil callback dengan true (dikonfirmasi)
        }
        hideCustomConfirm();
    });
    
    // ======== Keydown Listener untuk ENTER dan ESCAPE (Perubahan Baru) ========
    document.addEventListener('keydown', (e) => {
        // Cek apakah modal terlihat
        if (customModal.classList.contains('flex')) { 
            if (e.key === 'Enter') {
                e.preventDefault(); 
                // Picu aksi konfirmasi (Ya, Hapus/Lanjutkan)
                modalConfirm.click();
            } else if (e.key === 'Escape') {
                e.preventDefault();
                // Picu aksi batal (Tutup)
                modalCancel.click();
            }
        }
    });
    // =========================================================================


    // --- Excel Utilities (Dipertahankan) ---
    function readExcelFile(file) { /* ... (fungsi sama) ... */
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const json = XLSX.utils.sheet_to_json(worksheet, { defval: '', header: 1 });
            const headers = json[0];
            const rows = json.slice(1).map(row => {
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = row[index] || '';
                });
                return obj;
            });
            resolve(rows);
          } catch (err) { reject(err); }
        };
        reader.onerror = (err) => reject(err);
        reader.readAsArrayBuffer(file);
      });
    }

    function getExcelValue(row, keys) { /* ... (fungsi sama) ... */
        for (const key of keys) {
            if (row.hasOwnProperty(key)) {
                return row[key] ? row[key].toString().trim() : '';
            }
        }
        const rowKeys = Object.keys(row);
        for (const rk of rowKeys) {
            if (keys.some(k => k.toLowerCase() === rk.toLowerCase())) {
                return row[rk] ? row[rk].toString().trim() : '';
            }
        }
        return '';
    }

    function renderPreview(container, data, requiredCols){ /* ... (fungsi sama) ... */
      if(!data || data.length===0){ container.innerHTML = '<p class="text-gray-500">Tidak ada data untuk ditampilkan.</p>'; return; }
      
      const cols = Object.keys(data[0]);
      const table = document.createElement('table'); table.className='min-w-full text-sm';
      
      const thead = document.createElement('thead'); thead.innerHTML = '<tr>' + cols.map(c=>`<th class="px-3 py-2 text-left border-b border-cyan-500 bg-gray-200 text-gray-800">${c}</th>`).join('') + '</tr>';
      table.appendChild(thead);
      
      const tbody = document.createElement('tbody'); 
      data.slice(0, 5).forEach((row,idx)=>{ 
          const tr=document.createElement('tr'); 
          tr.className = idx%2===0?'bg-gray-50 text-gray-800':'bg-white text-gray-800'; 
          tr.innerHTML = cols.map(c=>`<td class="px-3 py-2 border-b border-gray-200">${row[c]??'-'}</td>`).join(''); 
          tbody.appendChild(tr); 
      });
      table.appendChild(tbody);
      
      const missing = requiredCols.filter(rc=>!cols.some(c=>c.toLowerCase() === rc.toLowerCase())); 
      const note = document.createElement('div'); note.className='my-3 text-sm'; 
      if(missing.length) {
          note.innerHTML=`<div class="text-red-600 font-bold mb-2">⚠️ Kolom wajib TIDAK ditemukan: ${missing.join(', ')}</div>`;
      } else {
          note.innerHTML=`<div class="text-green-600 font-bold mb-2">✅ Semua kolom wajib ditemukan.</div>`;
      }
      container.innerHTML=''; 
      container.appendChild(note); 
      container.appendChild(document.createTextNode(`Menampilkan ${data.slice(0, 5).length} dari ${data.length} baris.`));
      container.appendChild(table);
    }
    // --- End Excel Utilities ---


    // ======= SANTRI CRUD & LOGIC (Modified: deleteSantri) =======
    const tableSantri = document.getElementById('tableSantri');
    const sNis = document.getElementById('s_nis');
    const sNama = document.getElementById('s_nama');
    const sBlok = document.getElementById('s_blok');
    const sJenjang = document.getElementById('s_jenjang');
    const btnAddSantri = document.getElementById('btnAddSantri');
    const btnClearSantri = document.getElementById('btnClearSantri');
    const sEditStatus = document.getElementById('s_edit_status');
    const sectionSantri = document.getElementById('sectionSantri');

    async function addOrUpdateSantri() { /* ... (fungsi sama) ... */
      const nis = sNis.value.trim();
      const nama = sNama.value.trim();
      const blok = sBlok.value.trim();
      const jenjang = sJenjang.value.trim();

      if (!nis || !nama || !blok || !jenjang) {
          return showLog('Semua kolom Santri (NIS, Nama, Blok, Jenjang) wajib diisi!', true);
      }

      const payload = { nama, blok, jenjang };
      
      try {
        await set(ref(db, `siswa/${nis}`), payload);
        showLog(`Santri ${nis} (${payload.nama}) **berhasil** tersimpan/diperbarui.`, false);
        clearSantriForm();
      } catch (err) { 
        console.error("Firebase Santri Error:", err); 
        showLog('Gagal menyimpan santri. Pastikan **Firebase Rules** (/siswa/) mengizinkan penulisan.', true); 
      }
    }

    function clearSantriForm() { /* ... (fungsi sama) ... */
      sNis.value=''; sNama.value=''; sBlok.value=''; sJenjang.value=''; 
      sNis.removeAttribute('disabled');
      sNis.dataset.mode = 'add';
      btnAddSantri.textContent = 'Simpan Data';
      sEditStatus.classList.add('hidden');
      sNis.focus();
    }

    function startEditSantri(nis, val) { /* ... (fungsi sama) ... */
      clearSantriForm();
      sNis.value = nis;
      sNama.value = val.nama || '';
      sBlok.value = val.blok || '';
      sJenjang.value = val.jenjang || '';

      sNis.setAttribute('disabled', 'true'); // NIS tidak bisa diubah saat edit
      sNis.dataset.mode = 'edit';
      btnAddSantri.textContent = 'Perbarui Data';
      sEditStatus.classList.remove('hidden');
      sNama.focus();
      showLog(`Mode Edit: Data Santri ${nis}`, false);
    }
    
    btnAddSantri.addEventListener('click', addOrUpdateSantri);
    btnClearSantri.addEventListener('click', clearSantriForm);

    document.getElementById('previewSantri').addEventListener('click', async ()=>{ /* ... (fungsi sama) ... */
      const file = document.getElementById('fileSantri').files[0];
      if(!file) return showLog('Pilih file Excel terlebih dahulu.', true);
      try{
        const rows = await readExcelFile(file);
        sectionSantri._previewRows = rows;
        renderPreview(document.getElementById('previewAreaSantri'), rows, ['NIS', 'Nama', 'Blok', 'Jenjang']);
        showLog(`Pratinjau data Santri dimuat. ${rows.length} baris.`, false);
      } catch(e){
        showLog(`Gagal membaca file Excel: ${e.message}`, true);
        console.error(e);
      }
    });

    document.getElementById('uploadSantri').addEventListener('click', async ()=>{ /* ... (fungsi sama) ... */
      const rows = sectionSantri._previewRows || [];
      if (!rows.length) return showLog('Klik Pratinjau terlebih dahulu.', true);
      showLog(`Mengupload ${rows.length} baris...`, false);
      
      let ok=0, fail=0;
      for (const r of rows) {
        const nis = getExcelValue(r, ['NIS', 'nis', 'Nomor']);
        const nama = getExcelValue(r, ['Nama', 'nama']);
        const blok = getExcelValue(r, ['Blok', 'blok']);
        const jenjang = getExcelValue(r, ['Jenjang', 'jenjang']);
        
        if (!nis || !nama || !blok || !jenjang) { 
            fail++; continue; // Lewati jika data kunci tidak lengkap
        }
        
        const payload = { nama, blok, jenjang };
        
        try { 
            await set(ref(db, `siswa/${nis}`), payload); 
            ok++; 
        } catch(e){ 
            fail++; 
        }
      }
      showLog(`Upload selesai. Sukses: ${ok}, Gagal: ${fail}`, fail > 0);
    });

    function renderSantriTable(dataObj) { /* ... (fungsi sama) ... */
        if (!dataObj) { tableSantri.innerHTML = '<thead><tr><th class="p-3 text-gray-800" colspan="5">Belum ada data.</th></tr></thead>'; return; }
        const rows = Object.entries(dataObj);
        let html = '<thead><tr>' + ['NIS','Nama','Blok','Jenjang','Aksi'].map(h=>`<th class="px-3 py-2 text-left">${h}</th>`).join('') + '</tr></thead><tbody>';
        const allSantri = {};
        
        for (const [nis, val] of rows) {
            allSantri[nis] = val;
            html += `<tr class="odd:bg-gray-50 even:bg-white text-gray-800" data-nis="${nis}">`;
            html += `<td class="border-b border-gray-200 px-3 py-2">${nis}</td>`;
            html += `<td class="border-b border-gray-200 px-3 py-2">${val.nama||'-'}</td>`;
            html += `<td class="border-b border-gray-200 px-3 py-2">${val.blok||'-'}</td>`;
            html += `<td class="border-b border-gray-200 px-3 py-2">${val.jenjang||'-'}</td>`;
            html += `<td class="border-b border-gray-200 px-3 py-2 space-x-2"><button data-action="edit" class="px-3 py-1 text-xs bg-yellow-500 text-gray-900 rounded-md hover:bg-yellow-600 transition">Edit</button> <button data-action="delete" class="px-3 py-1 text-xs bg-red-600 text-white rounded-md hover:bg-red-700 transition">Hapus</button></td>`;
            html += `</tr>`;
        }
        html += '</tbody>';
        tableSantri.innerHTML = html;
        
        tableSantri.querySelectorAll('button[data-action]').forEach(btn=>{
            btn.addEventListener('click', (e)=>{
                const tr = e.target.closest('tr');
                const nis = tr.dataset.nis;
                const act = e.target.dataset.action;
                
                if (act==='delete') deleteSantri(nis);
                if (act==='edit') startEditSantri(nis, allSantri[nis]);
            });
        });
    }

    async function deleteSantri(nis) {
      // MENGGANTI confirm() DENGAN MODAL KUSTOM
      showCustomConfirm('Konfirmasi Hapus Santri', `Yakin hapus data santri dengan **NIS ${nis}**?`, async (confirmed) => {
          if (!confirmed) return;
          try { 
            await remove(ref(db, `siswa/${nis}`)); 
            showLog(`Santri ${nis} berhasil dihapus.`, false); 
            clearSantriForm();
          } catch(e){ 
            showLog(`Gagal menghapus santri ${nis}: ${e.message}`, true); 
            console.error(e);
          }
      });
    }

    function loadSiswa(){ /* ... (fungsi sama) ... */
      onValue(ref(db,'siswa'), (snap)=>{ 
        renderSantriTable(snap.val()); 
        showLog('Data Santri diperbarui.', false);
      }, (error) => {
        showLog('Gagal memuat data Santri: '+error.message, true);
      });
    }


    // ======= BUKU CRUD & LOGIC (Modified: deleteBuku) =======
    const tableBuku = document.getElementById('tableBuku');
    const bKode = document.getElementById('b_kode');
    const bJudul = document.getElementById('b_judul');
    const bKategori = document.getElementById('b_kategori');
    const btnAddBuku = document.getElementById('btnAddBuku');
    const btnClearBuku = document.getElementById('btnClearBuku');
    const bEditStatus = document.getElementById('b_edit_status');
    const sectionBuku = document.getElementById('sectionBuku');

    async function addOrUpdateBuku(){ /* ... (fungsi sama) ... */
      const kode = bKode.value.trim(); 
      const judul = bJudul.value.trim();
      const kategori = bKategori.value.trim();
      
      if(!kode || !judul || !kategori) {
          return showLog('Semua kolom Buku (Kode, Judul, Kategori) wajib diisi!', true);
      }
      
      const payload = { judul, kategori };
      
      try { 
        await set(ref(db, `buku/${kode}`), payload); 
        showLog(`Buku ${kode} **berhasil** tersimpan/diperbarui.`, false); 
        clearBukuForm(); 
      } catch(e){ 
        console.error("Firebase Buku Error:", e);
        showLog('Gagal menyimpan buku. Pastikan **Firebase Rules** (/buku/) mengizinkan penulisan.', true); 
      }
    }

    function clearBukuForm(){ /* ... (fungsi sama) ... */
      bKode.value=''; bJudul.value=''; bKategori.value=''; 
      bKode.removeAttribute('disabled');
      bKode.dataset.mode = 'add';
      btnAddBuku.textContent = 'Simpan Data';
      bEditStatus.classList.add('hidden');
      bKode.focus();
    }

    function startEditBuku(kode, val) { /* ... (fungsi sama) ... */
      clearBukuForm();
      bKode.value = kode;
      bJudul.value = val.judul || '';
      bKategori.value = val.kategori || '';

      bKode.setAttribute('disabled', 'true'); // Kode tidak bisa diubah saat edit
      bKode.dataset.mode = 'edit';
      btnAddBuku.textContent = 'Perbarui Data';
      bEditStatus.classList.remove('hidden');
      bJudul.focus();
      showLog(`Mode Edit: Data Buku ${kode}`, false);
    }

    btnAddBuku.addEventListener('click', addOrUpdateBuku);
    btnClearBuku.addEventListener('click', clearBukuForm);

    document.getElementById('previewBuku').addEventListener('click', async ()=>{ /* ... (fungsi sama) ... */
      const file = document.getElementById('fileBuku').files[0];
      if(!file) return showLog('Pilih file Excel terlebih dahulu.', true);
      try{
        const rows = await readExcelFile(file);
        sectionBuku._previewRows = rows;
        renderPreview(document.getElementById('previewAreaBuku'), rows, ['Kode', 'Judul', 'Kategori']);
        showLog(`Pratinjau data Buku dimuat. ${rows.length} baris.`, false);
      } catch(e){
        showLog(`Gagal membaca file Excel: ${e.message}`, true);
        console.error(e);
      }
    });

    document.getElementById('uploadBuku').addEventListener('click', async ()=>{ /* ... (fungsi sama) ... */
      const rows = sectionBuku._previewRows || []; 
      if(!rows.length) return showLog('Klik Pratinjau terlebih dahulu.', true);
      showLog(`Mengupload ${rows.length} baris...`, false);
      
      let ok=0, fail=0;
      for(const r of rows){
        const kode = getExcelValue(r, ['Kode', 'kode', 'Code']); 
        const judul = getExcelValue(r, ['Judul', 'judul']);
        const kategori = getExcelValue(r, ['Kategori', 'kategori']);

        if(!kode || !judul || !kategori){ 
            fail++; continue; // Lewati jika data kunci tidak lengkap
        }
        
        const payload = { judul, kategori };
        try{ 
            await set(ref(db, `buku/${kode}`), payload); 
            ok++; 
        } catch(e){ 
            fail++; 
        }
      }
      showLog(`Upload selesai. Sukses: ${ok}, Gagal: ${fail}`, fail > 0);
    });

    function renderBukuTable(dataObj){ /* ... (fungsi sama) ... */
        if(!dataObj){ tableBuku.innerHTML = '<thead><tr><th class="p-3 text-gray-800" colspan="4">Belum ada data.</th></tr></thead>'; return; }
        const rows = Object.entries(dataObj);
        let html = '<thead><tr>' + ['Kode','Judul','Kategori','Aksi'].map(h=>`<th class="px-3 py-2 text-left">${h}</th>`).join('') + '</tr></thead><tbody>';
        const allBuku = {};

        for(const [kode, val] of rows){
            allBuku[kode] = val;
            html += `<tr class="odd:bg-gray-50 even:bg-white text-gray-800" data-kode="${kode}">`;
            html += `<td class="border-b border-gray-200 px-3 py-2">${kode}</td>`;
            html += `<td class="border-b border-gray-200 px-3 py-2">${val.judul||'-'}</td>`;
            html += `<td class="border-b border-gray-200 px-3 py-2">${val.kategori||'-'}</td>`;
            html += `<td class="border-b border-gray-200 px-3 py-2 space-x-2"><button data-action="edit" class="px-3 py-1 text-xs bg-yellow-500 text-gray-900 rounded-md hover:bg-yellow-600 transition">Edit</button> <button data-action="delete" class="px-3 py-1 text-xs bg-red-600 text-white rounded-md hover:bg-red-700 transition">Hapus</button></td>`;
            html += `</tr>`;
        }
        html += '</tbody>';
        tableBuku.innerHTML = html;

        tableBuku.querySelectorAll('button[data-action]').forEach(btn=>{
            btn.addEventListener('click',(e)=>{
                const tr = e.target.closest('tr'); 
                const kode = tr.dataset.kode; 
                const act = e.target.dataset.action;
                if(act==='delete') deleteBuku(kode); 
                if(act==='edit') startEditBuku(kode, allBuku[kode]);
            });
        });
    }

    async function deleteBuku(kode){ 
      // MENGGANTI confirm() DENGAN MODAL KUSTOM
      showCustomConfirm('Konfirmasi Hapus Buku', `Yakin hapus data buku dengan **Kode ${kode}**?`, async (confirmed) => {
          if (!confirmed) return;
          try{ 
              await remove(ref(db, `buku/${kode}`)); 
              showLog(`Buku ${kode} berhasil dihapus.`, false); 
              clearBukuForm();
          } catch(e){ 
              showLog(`Gagal menghapus buku ${kode}: ${e.message}`, true); 
              console.error(e);
          } 
      });
    }

    function loadBuku(){ /* ... (fungsi sama) ... */
        onValue(ref(db,'buku'), (snap)=>{ 
            renderBukuTable(snap.val()); 
            showLog('Data Buku diperbarui.', false);
        }, (error) => {
            showLog('Gagal memuat data Buku: '+error.message, true);
        });
    }


    // ======= PENGUNJUNG VIEW & LOGIC (Modified: renderPengunjungTable, deleteAllPengunjung) =======
    const tablePengunjung = document.getElementById('tablePengunjung');
    const tablePengunjungHeader = `<thead><tr><th class="text-left">Tanggal</th><th class="text-left">Nama Lengkap</th><th class="text-left">Blok</th><th class="text-left">Jenjang</th><th class="text-left">Judul Buku</th><th class="text-left">Kategori</th><th class="text-left">Keterangan</th><th class="text-left">Aksi</th></tr></thead>`;

    function renderPengunjungTable(dataObj){
        currentPengunjungData = dataObj; // Simpan data ke variabel global

        if(!dataObj){ 
            tablePengunjung.innerHTML = tablePengunjungHeader + '<tbody><tr><td colspan="8" class="text-center p-4 text-gray-500">Belum ada data pengunjung.</td></tr></tbody>'; 
            return; 
        }
        
        const rows = Object.entries(dataObj); 
        let html = '';
        
        const dataKeys = [
            'nama', 'blok', 'jenjang', 
            'judulBuku', 'kategoriBuku', 'keterangan'
        ];
        
        for(const [key, val] of rows){
            const tanggal = val.tanggal || '??';
            const bulan = val.bulan || '??';
            const tahun = val.tahun || '????';
            const tanggalStr = `${tanggal}/${bulan}/${tahun}`;

            html += `<tr class="odd:bg-gray-50 even:bg-white text-gray-800" data-key="${key}">`;
            
            // KOLOM 1: Tanggal
            html += `<td class="border-b border-gray-200 px-3 py-2 font-semibold">${tanggalStr}</td>`;
            
            // Kolom Data Lain
            dataKeys.forEach(k => {
                const data = val[k] || '-';
                html += `<td class="border-b border-gray-200 px-3 py-2">${data}</td>`; 
            });
            
            // Kolom Aksi
            html += `<td class="border-b border-gray-200 px-3 py-2"><button data-action="delete" class="px-3 py-1 text-xs bg-red-600 text-white rounded-md hover:bg-red-700 transition">Hapus</button></td>`;
            html += `</tr>`;
        }
        
        tablePengunjung.innerHTML = tablePengunjungHeader + `<tbody>${html}</tbody>`;
        
        // Logic Hapus Per Baris
        tablePengunjung.querySelectorAll('button[data-action="delete"]').forEach(btn=>{
            btn.addEventListener('click', async (e)=>{
                const tr = e.target.closest('tr'); 
                const key = tr.dataset.key; 
                
                // MENGGANTI confirm() DENGAN MODAL KUSTOM
                showCustomConfirm('Konfirmasi Hapus Pengunjung', `Yakin hapus record pengunjung dengan **ID ${key.substring(0, 8)}...**?`, async (confirmed) => {
                    if (!confirmed) return;
                    try{ 
                        await remove(ref(db, `pengunjung/${key}`)); 
                        showLog(`Record ${key.substring(0, 8)}... dihapus.`, false); 
                    } catch(e){ 
                        showLog(`Gagal menghapus record: ${e.message}`, true); 
                        console.error(e);
                    }
                });
            });
        });
    }

    function loadPengunjung(){ /* ... (fungsi sama) ... */
        onValue(ref(db,'pengunjung'), (snap)=>{ 
            renderPengunjungTable(snap.val()); 
            const count = snap.val() ? Object.keys(snap.val()).length : 0;
            showLog(`Data Pengunjung terbaru dimuat. (${count} entri)`);
        }, (error) => {
            showLog('Gagal memuat data Pengunjung: '+error.message, true);
        });
    }
    
    // --- FUNGSI HAPUS SEMUA (Modified: deleteAllPengunjung) ---
    document.getElementById('deleteAllPengunjung').addEventListener('click', async () => {
        if (!currentPengunjungData || Object.keys(currentPengunjungData).length === 0) {
            return showLog('Tidak ada data pengunjung untuk dihapus.', true);
        }
        
        const count = Object.keys(currentPengunjungData).length;
        
        // MENGGANTI confirm() DENGAN MODAL KUSTOM
        showCustomConfirm('PERINGATAN KERAS: Hapus Semua Data Pengunjung', `Anda akan menghapus **SEMUA** data pengunjung (${count} entri). Tindakan ini **TIDAK DAPAT DIBATALKAN**. Lanjutkan?`, async (confirmed) => {
            if (!confirmed) return;
            
            try {
                await remove(ref(db, 'pengunjung'));
                showLog('✅ Semua data pengunjung berhasil dihapus.', false);
            } catch (e) {
                showLog(`Gagal menghapus semua data: ${e.message}. Cek Firebase Rules /pengunjung/`, true);
                console.error(e);
            }
        });
    });

    // --- FUNGSI SALIN DATA (Dipertahankan) ---
    document.getElementById('copyPengunjung').addEventListener('click', async () => { /* ... (fungsi sama) ... */
        if (!currentPengunjungData || Object.keys(currentPengunjungData).length === 0) {
            return showLog('Tidak ada data pengunjung untuk disalin.', true);
        }
        
        const rows = Object.entries(currentPengunjungData).map(([k,v])=> ({ id: k, ...v }));

        // 1. Tentukan header yang SESUAI DENGAN TABEL
        const headers = ['Tanggal', 'Nama Lengkap', 'Blok', 'Jenjang', 'Judul Buku', 'Kategori', 'Keterangan'];
        
        // 2. Format setiap baris agar sesuai dengan tampilan tabel
        const formattedRows = rows.map(r => {
            // Format Tanggal: DD/MM/YYYY
            const tanggalStr = `${r.tanggal || '??'}/${r.bulan || '??'}/${r.tahun || '????'}`;
            
            return [
                tanggalStr,
                r.nama || '-',
                r.blok || '-',
                r.jenjang || '-',
                r.judulBuku || '-',
                r.kategoriBuku || '-',
                r.keterangan || '-'
            ];
        });

        // 3. Gabungkan menjadi string TSV (Tab-Separated Values)
        const tsvString = [
            headers.map(h => `"${h}"`).join('\t') // Header row
        ].concat(formattedRows.map(row => 
            row.map(cell => `"${(cell || '').toString().replace(/"/g,'""')}"`).join('\t')
        )).join('\n');

        try {
            await navigator.clipboard.writeText(tsvString);
            showLog('✅ Semua data pengunjung berhasil disalin ke clipboard, sesuai tampilan tabel.', false);
        } catch (err) {
            showLog('Gagal menyalin data ke clipboard. Coba fungsi "Ekspor CSV".', true);
            console.error('Copy to clipboard failed:', err);
        }
    });

    // --- FUNGSI EKSPOR CSV (Dipertahankan) ---
    document.getElementById('exportPengunjung').addEventListener('click', ()=>{ /* ... (fungsi sama) ... */
        get(child(ref(db), 'pengunjung')).then(snap=>{
            const data = snap.val(); 
            if(!data) return showLog('Tidak ada data pengunjung untuk diekspor.', true);
            
            const rows = Object.entries(data).map(([k,v])=> ({ id: k, ...v }));
            
            const colsSet = new Set(['id']); rows.forEach(r=> Object.keys(r).forEach(c=>colsSet.add(c)));
            
            const cols = Array.from(colsSet).sort((a, b) => { 
                if (a.toLowerCase() === 'tanggal') return -1;
                if (b.toLowerCase() === 'bulan') return 1;
                if (a.toLowerCase() === 'tahun') return 1;
                if (a === 'id') return -1;
                if (b === 'id') return 1;
                return a.localeCompare(b);
            });

            const csv = [cols.join(';')].concat(rows.map(r=> 
                cols.map(c=>`"${(r[c]||'').toString().replace(/"/g,'""')}"`).join(';')
            )).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'pengunjung_perpustakaan.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
            showLog('Data Pengunjung berhasil diekspor ke CSV.', false);
        }).catch(e=>{
            showLog('Gagal ekspor data: '+e.message, true);
            console.error(e);
        });
    });

    // ======= TAB LOGIC (Dipertahankan) =======
    const tabSantri = document.getElementById('tabSantri');
    const tabBuku = document.getElementById('tabBuku');
    const tabPengunjung = document.getElementById('tabPengunjung');
    
    const allTabs = [tabPengunjung, tabSantri, tabBuku];

    function setActiveTabStyle(activeTab) { /* ... (fungsi sama) ... */
        allTabs.forEach(tab => {
            if (tab === activeTab) {
                tab.classList.add('bg-cyan-500', 'text-white', 'shadow-lg');
                tab.classList.remove('text-cyan-200', 'hover:bg-cyan-700/50');
            } else {
                tab.classList.remove('bg-cyan-500', 'text-white', 'shadow-lg');
                tab.classList.add('text-cyan-200', 'hover:bg-cyan-700/50');
            }
        });
    }

    function showTab(name){ /* ... (fungsi sama) ... */
      const sectionSantri = document.getElementById('sectionSantri');
      const sectionBuku = document.getElementById('sectionBuku');
      const sectionPengunjung = document.getElementById('sectionPengunjung');

      sectionSantri.classList.toggle('hidden', name!=='Santri');
      sectionBuku.classList.toggle('hidden', name!=='Buku');
      sectionPengunjung.classList.toggle('hidden', name!=='Pengunjung');
      
      let activeTabElement;
      if (name === 'Pengunjung') { 
          loadPengunjung(); 
          activeTabElement = tabPengunjung;
      } else if (name === 'Santri') {
          loadSiswa();
          clearSantriForm();
          activeTabElement = tabSantri;
      } else if (name === 'Buku') {
          loadBuku();
          clearBukuForm();
          activeTabElement = tabBuku;
      }
      
      setActiveTabStyle(activeTabElement);
    }
    
    tabPengunjung.onclick = ()=>showTab('Pengunjung');
    tabSantri.onclick = ()=>showTab('Santri'); 
    tabBuku.onclick = ()=>showTab('Buku'); 

    // initial load
    showTab('Pengunjung'); 
    showLog('Sistem siap. Memuat data Pengunjung...', false);
    
  </script>
</body>
</html>