<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard Lengkap</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <style>
    /* Custom Tailwind Colors */
    .bg-gradient-to-br-main {
      /* Gradasi gelap ke cyan (Latar Belakang Utama) */
      background-image: linear-gradient(to bottom right, #0F172A, #06B6D4); 
    }
    .bg-sidebar-gradient {
        /* Gradasi biru gelap (Sidebar) */
        background-image: linear-gradient(to bottom, #1E3A8A, #0C4A6E); 
    }

    /* Keterbacaan Maksimal: Header tabel solid putih dengan teks gelap/terang yang sesuai */
    #tableSantri thead th, #tableBuku thead th, #tablePengunjung thead th {
        @apply sticky top-0 bg-white text-gray-800 p-3 text-sm; 
        border-bottom: 2px solid #06B6D4; /* Border Cyan */
        font-weight: 700; /* Bold header */
    }
    /* Khusus untuk Pengunjung, latar belakang header gelap agar kontras dengan latar utama yang gelap */
    #sectionPengunjung #tablePengunjung thead th {
        @apply bg-gray-800 text-white;
        border-bottom-color: #06B6D4;
    }
    /* Baris ganjil/genap untuk semua tabel */
    #tableSantri tbody tr:nth-child(even), #tableBuku tbody tr:nth-child(even), #tablePengunjung tbody tr:nth-child(even) {
        @apply bg-gray-50;
    }

    #log {
      min-height: 20px;
      transition: color 0.3s ease;
    }
    html, body {
        padding: 0;
        margin: 0;
        font-family: 'Inter', sans-serif;
    }
  </style>
</head>
<body class="bg-gradient-to-br-main text-gray-100 flex min-h-screen">
  
  <aside id="sidebar" class="w-20 bg-sidebar-gradient shadow-2xl flex flex-col items-center py-6 space-y-6 fixed top-0 left-0 h-full border-r border-cyan-800 z-10">
    
    <div class="text-cyan-300 text-3xl mb-6 p-1">
        <i class="fa-solid fa-cloud"></i> 
    </div>
    
    <button id="tabPengunjung" title="Pengunjung" class="w-14 h-14 flex items-center justify-center rounded-2xl text-2xl bg-cyan-500 text-white shadow-lg hover:bg-cyan-600 transition-all duration-300 ease-in-out transform hover:scale-105">
        <i class="fa-solid fa-users"></i> 
    </button>
    <button id="tabSantri" title="Santri" class="w-14 h-14 flex items-center justify-center rounded-2xl text-2xl text-cyan-200 hover:bg-cyan-700/50 hover:text-white transition-all duration-300 ease-in-out transform hover:scale-105">
        <i class="fa-solid fa-book-open"></i>
    </button>
    <button id="tabBuku" title="Buku" class="w-14 h-14 flex items-center justify-center rounded-2xl text-2xl text-cyan-200 hover:bg-cyan-700/50 hover:text-white transition-all duration-300 ease-in-out transform hover:scale-105">
        <i class="fa-solid fa-book"></i>
    </button>
  </aside>

  <div class="flex-grow ml-20 p-8 w-full max-w-7xl mx-auto"> 
    <header class="mb-8">
      <h1 class="text-3xl font-extrabold text-white leading-tight">Admin Dashboard</h1>
      <p class="text-md text-cyan-200 opacity-90 mt-1">Kelola data santri, buku, dan pantau pengunjung perpustakaan dengan mudah.</p>
    </header>

    <div class="bg-white/10 rounded-3xl shadow-2xl p-7 border border-cyan-700/50">
      
      <section id="sectionPengunjung" class="text-gray-100">
        <h3 class="font-semibold text-xl mb-3 text-white">Data Pengunjung</h3>
        <p class="text-sm text-cyan-200 opacity-80 mb-4">Data kunjungan dengan Tanggal diformat menjadi DD/MM/YYYY.</p>

        <div class="mb-4">
            <input type="text" id="searchPengunjung" placeholder="Cari Tanggal (DD/MM/YYYY), Nama/Judul Buku/Blok Pengunjung..." class="w-full px-4 py-2 bg-white/20 border border-cyan-700/50 rounded-lg text-white placeholder-gray-300 focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition" />
        </div>
        
        <div class="overflow-auto max-h-[520px] rounded-xl border border-cyan-700/30 bg-white p-2 shadow-inner">
          <table id="tablePengunjung" class="min-w-full text-sm text-gray-800">
            <tbody>
                <tr><td colspan="7" class="text-center p-4 text-gray-500">Data sedang dimuat...</td></tr>
            </tbody>
          </table>
        </div>
        
        <div class="mt-4 flex flex-wrap gap-3">
          <button type="button" id="exportPengunjung" class="px-5 py-2 bg-cyan-600 text-white rounded-lg shadow-md hover:bg-cyan-700 transition duration-200">
            <i class="fa-solid fa-download mr-2"></i> Ekspor CSV
          </button>
          <button type="button" id="copyPengunjung" class="px-5 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition duration-200">
            <i class="fa-solid fa-copy mr-2"></i> Salin Data
          </button>
          <button type="button" id="deleteAllPengunjung" class="ml-auto px-5 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition duration-200">
              <i class="fa-solid fa-trash-can mr-2"></i> Hapus SEMUA Data
          </button>
          </div>
      </section>

      <section id="sectionSantri" class="hidden text-gray-100">
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <h3 class="font-semibold text-xl mb-3 text-white">Tambah / Edit Santri</h3>
            <div class="space-y-3">
              <input type="text" id="s_nis" placeholder="NIS" class="w-full px-4 py-2 bg-white/20 border border-cyan-700/50 rounded-lg text-white placeholder-gray-300 focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition" data-mode="add" />
              <input type="text" id="s_nama" placeholder="Nama" class="w-full px-4 py-2 bg-white/20 border border-cyan-700/50 rounded-lg text-white placeholder-gray-300 focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition" />
              <input type="text" id="s_blok" placeholder="Blok / Kamar" class="w-full px-4 py-2 bg-white/20 border border-cyan-700/50 rounded-lg text-white placeholder-gray-300 focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition" />
              <input type="text" id="s_jenjang" placeholder="Jenjang (SLTP/SLTA/PT)" class="w-full px-4 py-2 bg-white/20 border border-cyan-700/50 rounded-lg text-white placeholder-gray-300 focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition" />
              <div class="flex gap-3">
                <button type="button" id="btnAddSantri" class="px-5 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition duration-200">
                  <i class="fa-solid fa-save mr-2"></i> Simpan Data
                </button>
                <button type="button" id="btnClearSantri" class="px-5 py-2 bg-gray-600 text-white rounded-lg shadow-md hover:bg-gray-700 transition duration-200">
                  <i class="fa-solid fa-eraser mr-2"></i> Bersihkan Form
                </button>
              </div>
              <p id="s_edit_status" class="text-sm text-yellow-400 hidden">Mode Edit: NIS tidak dapat diubah.</p>
            </div>

            <hr class="my-6 border-cyan-700/50" />

            <label class="block mb-3 font-semibold text-white">Upload Excel (Santri) — kolom: <code>NIS, Nama, Blok, Jenjang</code></label>
            <div class="flex gap-4 items-center mb-4">
              <input id="fileSantri" type="file" accept=".xlsx,.xls" class="block w-full text-sm text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cyan-500 file:text-white hover:file:bg-cyan-600 cursor-pointer"/>
              <button type="button" id="uploadSantri" class="px-5 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition duration-200">
                <i class="fa-solid fa-upload mr-2"></i> Upload ke Firebase
              </button>
            </div>
            <div id="uploadProgressSantri" class="h-2 bg-gray-600 rounded-full hidden">
                <div id="progressBarSantri" class="h-2 bg-yellow-400 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            
            <div class="flex mt-6">
                <button type="button" id="deleteAllSantri" class="w-full px-5 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition duration-200">
                    <i class="fa-solid fa-trash-can mr-2"></i> Hapus SEMUA Data Santri
                </button>
            </div>
            </div>

          <div>
            <h3 class="font-semibold text-xl mb-3 text-white">Daftar Santri</h3>
            <div class="mb-3">
                <input type="text" id="searchSantri" placeholder="Cari NIS, Nama, Blok, atau Jenjang..." class="w-full px-4 py-2 bg-white/20 border border-cyan-700/50 rounded-lg text-white placeholder-gray-300 focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition" />
            </div>

            <div class="overflow-auto max-h-[480px] rounded-xl border border-cyan-700/30 bg-white shadow-inner">
              <table id="tableSantri" class="min-w-full text-sm text-gray-800"></table>
            </div>
          </div>
        </div>
      </section>

      <section id="sectionBuku" class="hidden text-gray-100">
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <h3 class="font-semibold text-xl mb-3 text-white">Tambah / Edit Buku</h3>
            <div class="space-y-3">
              <input type="text" id="b_kode" placeholder="Kode" class="w-full px-4 py-2 bg-white/20 border border-cyan-700/50 rounded-lg text-white placeholder-gray-300 focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition" data-mode="add" />
              <input type="text" id="b_judul" placeholder="Judul" class="w-full px-4 py-2 bg-white/20 border border-cyan-700/50 rounded-lg text-white placeholder-gray-300 focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition" />
              <input type="text" id="b_kategori" placeholder="Kategori" class="w-full px-4 py-2 bg-white/20 border border-cyan-700/50 rounded-lg text-white placeholder-gray-300 focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition" />
              <div class="flex gap-3">
                <button type="button" id="btnAddBuku" class="px-5 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition duration-200">
                  <i class="fa-solid fa-save mr-2"></i> Simpan Data
                </button>
                <button type="button" id="btnClearBuku" class="px-5 py-2 bg-gray-600 text-white rounded-lg shadow-md hover:bg-gray-700 transition duration-200">
                  <i class="fa-solid fa-eraser mr-2"></i> Bersihkan Form
                </button>
              </div>
              <p id="b_edit_status" class="text-sm text-yellow-400 hidden">Mode Edit: Kode tidak dapat diubah.</p>
            </div>

            <hr class="my-6 border-cyan-700/50" />

            <label class="block mb-3 font-semibold text-white">Upload Excel (Buku) — kolom: <code>Kode, Judul, Kategori</code></label>
            <div class="flex gap-4 items-center mb-4">
              <input id="fileBuku" type="file" accept=".xlsx,.xls" class="block w-full text-sm text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cyan-500 file:text-white hover:file:bg-cyan-600 cursor-pointer"/>
              <button type="button" id="uploadBuku" class="px-5 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition duration-200">
                <i class="fa-solid fa-upload mr-2"></i> Upload ke Firebase
              </button>
            </div>
            <div id="uploadProgressBuku" class="h-2 bg-gray-600 rounded-full hidden">
                <div id="progressBarBuku" class="h-2 bg-yellow-400 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>

            <div class="flex mt-6">
                <button type="button" id="deleteAllBuku" class="w-full px-5 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition duration-200">
                    <i class="fa-solid fa-trash-can mr-2"></i> Hapus SEMUA Data Buku
                </button>
            </div>
            </div>

          <div>
            <h3 class="font-semibold text-xl mb-3 text-white">Daftar Buku</h3>
            <div class="mb-3">
                <input type="text" id="searchBuku" placeholder="Cari Kode, Judul, atau Kategori..." class="w-full px-4 py-2 bg-white/20 border border-cyan-700/50 rounded-lg text-white placeholder-gray-300 focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition" />
            </div>

            <div class="overflow-auto max-h-[480px] rounded-xl border border-cyan-700/30 bg-white shadow-inner">
              <table id="tableBuku" class="min-w-full text-sm text-gray-800"></table>
            </div>
          </div>
        </div>
      </section>

      <hr class="my-6 border-cyan-700/50" />
      <div id="log" class="text-sm text-gray-300 font-medium">Siap.</div>
    </div>

    <footer class="mt-8 text-xs text-cyan-200 opacity-70 text-center">Admin Dashboard v1.0 | Pastikan Realtime Database mengizinkan akses/penulisan dari client untuk pengujian awal.</footer>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getDatabase, ref, set, get, child, remove, onValue } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';

    // =========================================================
    // KONFIGURASI FIREBASE (DARI INPUT TERAKHIR ANDA)
    // =========================================================
    const firebaseConfig = {
      apiKey: "AIzaSyB6gaVW3ye680YylqzSebZugmQepYRA4g4",
      authDomain: "pengunjung-4489b.firebaseapp.com",
      projectId: "pengunjung-4489b",
      storageBucket: "pengunjung-4489b.firebasestorage.app",
      messagingSenderId: "233634425303",
      appId: "1:233634425303:web:9d45d775e703b94843c392",
      databaseURL: "https://pengunjung-4489b-default-rtdb.firebaseio.com" 
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const logEl = document.getElementById('log');

    // Global Data Storage for Search
    let allSantriData = null;
    let allBukuData = null;
    let allPengunjungData = null;
    
    // Search Inputs
    const searchSantri = document.getElementById('searchSantri');
    const searchBuku = document.getElementById('searchBuku');
    const searchPengunjung = document.getElementById('searchPengunjung');
    
    // Delete All Buttons
    const deleteAllSantriBtn = document.getElementById('deleteAllSantri');
    const deleteAllBukuBtn = document.getElementById('deleteAllBuku');
    const deleteAllPengunjungBtn = document.getElementById('deleteAllPengunjung');


    function showLog(message, isError = false) {
        logEl.classList.remove('text-green-400', 'text-red-400', 'text-gray-300');
        logEl.classList.add(isError ? 'text-red-400' : 'text-green-400');
        logEl.innerText = message;
    }
    
    // --- Excel Utilities (Dipertahankan) ---
    function readExcelFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            // Tambahkan {raw: true} untuk menjaga NIS/Kode sebagai angka jika memang begitu di Excel
            const json = XLSX.utils.sheet_to_json(worksheet, { defval: '', header: 1, raw: true });
            const headers = json[0];
            const rows = json.slice(1).map(row => {
                const obj = {};
                headers.forEach((header, index) => {
                    // Konversi semua nilai ke string saat mapping
                    obj[header] = row[index] !== undefined && row[index] !== null ? row[index].toString() : '';
                });
                return obj;
            });
            resolve(rows);
          } catch (err) { reject(err); }
        };
        reader.onerror = (err) => reject(err);
        reader.readAsArrayBuffer(file);
      });
    }

    function getExcelValue(row, keys) {
        for (const key of keys) {
            if (row.hasOwnProperty(key)) {
                return row[key] ? row[key].toString().trim() : '';
            }
        }
        const rowKeys = Object.keys(row);
        for (const rk of rowKeys) {
            if (keys.some(k => k.toLowerCase() === rk.toLowerCase())) {
                return row[rk] ? row[rk].toString().trim() : '';
            }
        }
        return '';
    }
    // --- End Excel Utilities ---


    // =========================================================
    // SANTRI CRUD & LOGIC
    // =========================================================
    const tableSantri = document.getElementById('tableSantri');
    const sNis = document.getElementById('s_nis');
    const sNama = document.getElementById('s_nama');
    const sBlok = document.getElementById('s_blok');
    const sJenjang = document.getElementById('s_jenjang');
    const btnAddSantri = document.getElementById('btnAddSantri');
    const btnClearSantri = document.getElementById('btnClearSantri');
    const sEditStatus = document.getElementById('s_edit_status');
    const sectionSantri = document.getElementById('sectionSantri');

    async function addOrUpdateSantri() {
      const nis = sNis.value.trim();
      const nama = sNama.value.trim();
      const blok = sBlok.value.trim();
      const jenjang = sJenjang.value.trim();

      if (!nis || !nama || !blok || !jenjang) {
          return showLog('Semua kolom Santri (NIS, Nama, Blok, Jenjang) wajib diisi!', true);
      }

      const payload = { nama, blok, jenjang };
      
      try {
        await set(ref(db, `siswa/${nis}`), payload);
        showLog(`Santri ${nis} (${payload.nama}) **berhasil** tersimpan/diperbarui.`, false);
        clearSantriForm();
      } catch (err) { 
        console.error("Firebase Santri Error:", err); 
        showLog('Gagal menyimpan santri. Pastikan **Firebase Rules** (/siswa/) mengizinkan penulisan.', true); 
      }
    }
    
    // NEW LOGIC: Hapus Semua Santri
    async function deleteAllSantri() {
        if (!confirm("PERINGATAN KERAS! Anda yakin ingin menghapus SEMUA data Santri? Tindakan ini TIDAK dapat dibatalkan.")) return;
        showLog('⏳ Menghapus SEMUA data Santri...', false);
        try {
            await remove(ref(db, `siswa`));
            showLog('✅ SEMUA data Santri berhasil dihapus.', false);
            clearSantriForm();
        } catch (e) {
            showLog('❌ Gagal menghapus SEMUA data Santri: ' + e.message, true);
            console.error(e);
        }
    }


    function clearSantriForm() { 
      sNis.value=''; sNama.value=''; sBlok.value=''; sJenjang.value=''; 
      sNis.removeAttribute('disabled');
      sNis.dataset.mode = 'add';
      btnAddSantri.textContent = 'Simpan Data';
      sEditStatus.classList.add('hidden');
      sNis.focus();
    }

    function startEditSantri(nis, val) {
      clearSantriForm();
      sNis.value = nis;
      sNama.value = val.nama || '';
      sBlok.value = val.blok || '';
      sJenjang.value = val.jenjang || '';

      sNis.setAttribute('disabled', 'true'); 
      sNis.dataset.mode = 'edit';
      btnAddSantri.textContent = 'Perbarui Data';
      sEditStatus.classList.remove('hidden');
      sNama.focus();
      showLog(`Mode Edit: Data Santri ${nis}`, false);
    }
    
    // Logika Upload Santri DENGAN Progress Bar (Dipertahankan)
    document.getElementById('uploadSantri').addEventListener('click', async ()=>{
      const fileInput = document.getElementById('fileSantri');
      const file = fileInput.files[0];
      const progressBarContainer = document.getElementById('uploadProgressSantri');
      const progressBar = document.getElementById('progressBarSantri');
      const uploadButton = document.getElementById('uploadSantri');

      if (!file) return showLog('Pilih file Excel terlebih dahulu.', true);

      progressBarContainer.classList.remove('hidden');
      progressBar.style.width = '0%';
      uploadButton.setAttribute('disabled', 'true');
      showLog('⏳ Membaca file Excel...', false);

      try {
        const rows = await readExcelFile(file);
        if (!rows.length) {
            throw new Error("File kosong atau tidak dapat dibaca.");
        }
        
        showLog(`⏳ Mulai mengupload ${rows.length} baris Santri...`, false);
        
        let ok=0, fail=0;
        const totalRows = rows.length;

        for (let i = 0; i < totalRows; i++) {
            const r = rows[i];
            const nis = getExcelValue(r, ['NIS', 'nis', 'Nomor']);
            const nama = getExcelValue(r, ['Nama', 'nama']);
            const blok = getExcelValue(r, ['Blok', 'blok']);
            const jenjang = getExcelValue(r, ['Jenjang', 'jenjang']);
            
            if (!nis) { 
                fail++; 
                continue; 
            }
            
            const payload = { 
                nama: nama, 
                blok: blok, 
                jenjang: jenjang 
            }; 
            
            try { 
                await set(ref(db, `siswa/${nis}`), payload); 
                ok++; 
            } catch(e){ 
                fail++; 
            }

            const progress = Math.round(((i + 1) / totalRows) * 100);
            progressBar.style.width = `${progress}%`;
            
            if (i % 50 === 0 || i === totalRows - 1) { 
                showLog(`⏳ Mengupload: ${ok} sukses, ${fail} gagal dari ${totalRows} baris. (${progress}%)`, false);
            }
        }
        
        showLog(`✅ Upload Santri selesai. Total Sukses: ${ok}, Total Gagal (NIS kosong/error): ${fail}`, fail > 0);

      } catch (error) {
        showLog(`❌ Gagal membaca atau mengupload file Santri: ${error.message}`, true);
        console.error(error);
      } finally {
        uploadButton.removeAttribute('disabled');
        await new Promise(resolve => setTimeout(resolve, 500));
        progressBarContainer.classList.add('hidden');
        fileInput.value = ''; 
      }
    });

    function deleteSantri(nis) {
      if (!confirm(`Yakin hapus data santri dengan NIS ${nis}?`)) return;
      try { 
        remove(ref(db, `siswa/${nis}`)); 
        showLog(`Santri ${nis} berhasil dihapus.`, false); 
        clearSantriForm();
      } catch(e){ 
        showLog(`Gagal menghapus santri ${nis}: ${e.message}`, true); 
        console.error(e);
      }
    }

    // Memastikan Event Listener terpasang
    btnAddSantri.addEventListener('click', addOrUpdateSantri);
    btnClearSantri.addEventListener('click', clearSantriForm);
    deleteAllSantriBtn.addEventListener('click', deleteAllSantri); // NEW DELETE ALL LISTENER
    searchSantri.addEventListener('input', () => {
        renderSantriTable(allSantriData, searchSantri.value);
    });

    function renderSantriTable(dataObj, query = '') {
        if (!dataObj) { tableSantri.innerHTML = '<thead><tr><th class="p-3 text-gray-800" colspan="5">Belum ada data.</th></tr></thead>'; return; }
        
        let filteredRows = Object.entries(dataObj);
        const lowerQuery = query.toLowerCase().trim();

        if (lowerQuery) {
            filteredRows = filteredRows.filter(([nis, val]) => {
                return nis.toLowerCase().includes(lowerQuery) ||
                       (val.nama || '').toLowerCase().includes(lowerQuery) ||
                       (val.blok || '').toLowerCase().includes(lowerQuery) ||
                       (val.jenjang || '').toLowerCase().includes(lowerQuery);
            });
        }

        let html = '<thead><tr>' + ['NIS','Nama','Blok','Jenjang','Aksi'].map(h=>`<th class="px-3 py-2 text-left">${h}</th>`).join('') + '</tr></thead><tbody>';
        
        if (filteredRows.length === 0) {
             html += `<tr><td colspan="5" class="text-center p-4 text-gray-500">Tidak ada hasil ditemukan untuk "${query}".</td></tr>`;
        } else {
            for (const [nis, val] of filteredRows) { 
                html += `<tr class="odd:bg-gray-50 even:bg-white text-gray-800" data-nis="${nis}">`;
                html += `<td class="border-b border-gray-200 px-3 py-2">${nis}</td>`;
                html += `<td class="border-b border-gray-200 px-3 py-2">${val.nama||'-'}</td>`;
                html += `<td class="border-b border-gray-200 px-3 py-2">${val.blok||'-'}</td>`;
                html += `<td class="border-b border-gray-200 px-3 py-2">${val.jenjang||'-'}</td>`;
                html += `<td class="border-b border-gray-200 px-3 py-2 space-x-2"><button data-action="edit" class="px-3 py-1 text-xs bg-yellow-500 text-gray-900 rounded-md hover:bg-yellow-600 transition">Edit</button> <button data-action="delete" class="px-3 py-1 text-xs bg-red-600 text-white rounded-md hover:bg-red-700 transition">Hapus</button></td>`;
                html += `</tr>`;
            }
        }
        html += '</tbody>';
        tableSantri.innerHTML = html;
        
        tableSantri.querySelectorAll('button[data-action]').forEach(btn=>{
            btn.addEventListener('click', (e)=>{
                const tr = e.target.closest('tr');
                const nis = tr.dataset.nis;
                const act = e.target.dataset.action;
                
                if (act==='delete') deleteSantri(nis);
                if (act==='edit') startEditSantri(nis, allSantriData[nis]);
            });
        });
    }

    function loadSiswa(){
      onValue(ref(db,'siswa'), (snap)=>{ 
        allSantriData = snap.val(); 
        renderSantriTable(allSantriData, searchSantri.value); 
        showLog('Data Santri diperbarui.', false);
      }, (error) => {
        showLog('Gagal memuat data Santri: '+error.message, true);
      });
    }


    // =========================================================
    // BUKU CRUD & LOGIC
    // =========================================================
    const tableBuku = document.getElementById('tableBuku');
    const bKode = document.getElementById('b_kode');
    const bJudul = document.getElementById('b_judul');
    const bKategori = document.getElementById('b_kategori');
    const btnAddBuku = document.getElementById('btnAddBuku');
    const btnClearBuku = document.getElementById('btnClearBuku');
    const bEditStatus = document.getElementById('b_edit_status');
    const sectionBuku = document.getElementById('sectionBuku');

    async function addOrUpdateBuku(){
      const kode = bKode.value.trim(); 
      const judul = bJudul.value.trim();
      const kategori = bKategori.value.trim();
      
      if(!kode || !judul || !kategori) {
          return showLog('Semua kolom Buku (Kode, Judul, Kategori) wajib diisi!', true);
      }
      
      const payload = { judul, kategori };
      
      try { 
        await set(ref(db, `buku/${kode}`), payload); 
        showLog(`Buku ${kode} **berhasil** tersimpan/diperbarui.`, false); 
        clearBukuForm(); 
      } catch(e){ 
        console.error("Firebase Buku Error:", e);
        showLog('Gagal menyimpan buku. Pastikan **Firebase Rules** (/buku/) mengizinkan penulisan.', true); 
      }
    }
    
    // NEW LOGIC: Hapus Semua Buku
    async function deleteAllBuku() {
        if (!confirm("PERINGATAN KERAS! Anda yakin ingin menghapus SEMUA data Buku? Tindakan ini TIDAK dapat dibatalkan.")) return;
        showLog('⏳ Menghapus SEMUA data Buku...', false);
        try {
            await remove(ref(db, `buku`));
            showLog('✅ SEMUA data Buku berhasil dihapus.', false);
            clearBukuForm();
        } catch (e) {
            showLog('❌ Gagal menghapus SEMUA data Buku: ' + e.message, true);
            console.error(e);
        }
    }

    function clearBukuForm(){ 
      bKode.value=''; bJudul.value=''; bKategori.value=''; 
      bKode.removeAttribute('disabled');
      bKode.dataset.mode = 'add';
      btnAddBuku.textContent = 'Simpan Data';
      bEditStatus.classList.add('hidden');
      bKode.focus();
    }

    function startEditBuku(kode, val) {
      clearBukuForm();
      bKode.value = kode;
      bJudul.value = val.judul || '';
      bKategori.value = val.kategori || '';

      bKode.setAttribute('disabled', 'true'); 
      bKode.dataset.mode = 'edit';
      btnAddBuku.textContent = 'Perbarui Data';
      bEditStatus.classList.remove('hidden');
      bJudul.focus();
      showLog(`Mode Edit: Data Buku ${kode}`, false);
    }

    // Event Listener Buku
    btnAddBuku.addEventListener('click', addOrUpdateBuku);
    btnClearBuku.addEventListener('click', clearBukuForm);
    deleteAllBukuBtn.addEventListener('click', deleteAllBuku); // NEW DELETE ALL LISTENER
    searchBuku.addEventListener('input', () => {
        renderBukuTable(allBukuData, searchBuku.value);
    });

    // Logika Upload Buku DENGAN Progress Bar (Dipertahankan)
    document.getElementById('uploadBuku').addEventListener('click', async ()=>{
      const fileInput = document.getElementById('fileBuku');
      const file = fileInput.files[0];
      const progressBarContainer = document.getElementById('uploadProgressBuku');
      const progressBar = document.getElementById('progressBarBuku');
      const uploadButton = document.getElementById('uploadBuku');
      
      if(!file) return showLog('Pilih file Excel terlebih dahulu.', true);

      progressBarContainer.classList.remove('hidden');
      progressBar.style.width = '0%';
      uploadButton.setAttribute('disabled', 'true');
      showLog('⏳ Membaca file Excel...', false);

      try {
        const rows = await readExcelFile(file);
        if (!rows.length) {
            throw new Error("File kosong atau tidak dapat dibaca.");
        }
        
        showLog(`⏳ Mulai mengupload ${rows.length} baris Buku...`, false);
      
        let ok=0, fail=0;
        const totalRows = rows.length;

        for(let i = 0; i < totalRows; i++){
            const r = rows[i];
            const kode = getExcelValue(r, ['Kode', 'kode', 'Code']); 
            const judul = getExcelValue(r, ['Judul', 'judul']);
            const kategori = getExcelValue(r, ['Kategori', 'kategori']);

            if(!kode){ 
                fail++; 
                continue; 
            }
            
            const payload = { 
                judul: judul, 
                kategori: kategori 
            }; 
            try{ 
                await set(ref(db, `buku/${kode}`), payload); 
                ok++; 
            } catch(e){ 
                fail++; 
            }
            
            const progress = Math.round(((i + 1) / totalRows) * 100);
            progressBar.style.width = `${progress}%`;

            if (i % 50 === 0 || i === totalRows - 1) { 
                showLog(`⏳ Mengupload: ${ok} sukses, ${fail} gagal dari ${totalRows} baris. (${progress}%)`, false);
            }
        }
        
        showLog(`✅ Upload Buku selesai. Total Sukses: ${ok}, Total Gagal (Kode kosong/error): ${fail}`, fail > 0);

      } catch (error) {
        showLog(`❌ Gagal membaca atau mengupload file Buku: ${error.message}`, true);
        console.error(error);
      } finally {
        uploadButton.removeAttribute('disabled');
        await new Promise(resolve => setTimeout(resolve, 500));
        progressBarContainer.classList.add('hidden');
        fileInput.value = ''; 
      }
    });

    
    function renderBukuTable(dataObj, query = ''){
        if(!dataObj){ tableBuku.innerHTML = '<thead><tr><th class="p-3 text-gray-800" colspan="4">Belum ada data.</th></tr></thead>'; return; }
        
        let filteredRows = Object.entries(dataObj);
        const lowerQuery = query.toLowerCase().trim();

        if (lowerQuery) {
            filteredRows = filteredRows.filter(([kode, val]) => {
                // Search across Kode, Judul, Kategori
                return kode.toLowerCase().includes(lowerQuery) ||
                       (val.judul || '').toLowerCase().includes(lowerQuery) ||
                       (val.kategori || '').toLowerCase().includes(lowerQuery);
            });
        }

        let html = '<thead><tr>' + ['Kode','Judul','Kategori','Aksi'].map(h=>`<th class="px-3 py-2 text-left">${h}</th>`).join('') + '</tr></thead><tbody>';
        
        if (filteredRows.length === 0) {
             html += `<tr><td colspan="4" class="text-center p-4 text-gray-500">Tidak ada hasil ditemukan untuk "${query}".</td></tr>`;
        } else {
            for(const [kode, val] of filteredRows){
                html += `<tr class="odd:bg-gray-50 even:bg-white text-gray-800" data-kode="${kode}">`;
                html += `<td class="border-b border-gray-200 px-3 py-2">${kode}</td>`;
                html += `<td class="border-b border-gray-200 px-3 py-2">${val.judul||'-'}</td>`;
                html += `<td class="border-b border-gray-200 px-3 py-2">${val.kategori||'-'}</td>`;
                html += `<td class="border-b border-gray-200 px-3 py-2 space-x-2"><button data-action="edit" class="px-3 py-1 text-xs bg-yellow-500 text-gray-900 rounded-md hover:bg-yellow-600 transition">Edit</button> <button data-action="delete" class="px-3 py-1 text-xs bg-red-600 text-white rounded-md hover:bg-red-700 transition">Hapus</button></td>`;
                html += `</tr>`;
            }
        }
        html += '</tbody>';
        tableBuku.innerHTML = html;

        tableBuku.querySelectorAll('button[data-action]').forEach(btn=>{
            btn.addEventListener('click',(e)=>{
                const tr = e.target.closest('tr'); 
                const kode = tr.dataset.kode; 
                const act = e.target.dataset.action;
                if(act==='delete') deleteBuku(kode); 
                if(act==='edit') startEditBuku(kode, allBukuData[kode]);
            });
        });
    }

    async function deleteBuku(kode){ 
        if(!confirm(`Yakin hapus data buku dengan Kode ${kode}?`)) return; 
        try{ 
            await remove(ref(db, `buku/${kode}`)); 
            showLog(`Buku ${kode} berhasil dihapus.`, false); 
            clearBukuForm();
        } catch(e){ 
            showLog(`Gagal menghapus buku ${kode}: ${e.message}`, true); 
            console.error(e);
        } 
    }

    function loadBuku(){ 
        onValue(ref(db,'buku'), (snap)=>{ 
            allBukuData = snap.val(); 
            renderBukuTable(allBukuData, searchBuku.value); 
            showLog('Data Buku diperbarui.', false);
        }, (error) => {
            showLog('Gagal memuat data Buku: '+error.message, true);
        });
    }


    // =========================================================
    // PENGUNJUNG VIEW & LOGIC
    // =========================================================
    const tablePengunjung = document.getElementById('tablePengunjung');
    const tablePengunjungHeader = `<thead><tr><th class="text-left">Tanggal</th><th class="text-left">Nama Lengkap</th><th class="text-left">Blok</th><th class="text-left">Jenjang</th><th class="text-left">Judul Buku</th><th class="text-left">Kategori</th><th class="text-left">Keterangan</th><th class="text-left">Aksi</th></tr></thead>`;
    const copyPengunjungBtn = document.getElementById('copyPengunjung');

    // NEW LOGIC: Hapus Semua Pengunjung
    async function deleteAllPengunjung() {
        if (!confirm("PERINGATAN KERAS! Anda yakin ingin menghapus SEMUA data Pengunjung? Tindakan ini TIDAK dapat dibatalkan.")) return;
        showLog('⏳ Menghapus SEMUA data Pengunjung...', false);
        try {
            await remove(ref(db, `pengunjung`));
            showLog('✅ SEMUA data Pengunjung berhasil dihapus.', false);
        } catch (e) {
            showLog('❌ Gagal menghapus SEMUA data Pengunjung: ' + e.message, true);
            console.error(e);
        }
    }

    // MODIFIKASI: Salin Data Pengunjung (Dipertahankan)
    function copyPengunjungData() {
        const table = document.getElementById('tablePengunjung');
        const rows = table.querySelectorAll('tbody tr');

        if (rows.length === 0 || (rows.length === 1 && rows[0].querySelector('td').textContent.includes('Belum ada data'))) {
            return showLog('Tidak ada data pengunjung di tabel untuk disalin.', true);
        }
        
        const headerCells = table.querySelectorAll('thead th');
        const header = Array.from(headerCells).slice(0, 7).map(th => th.textContent.trim()).join('\t');
        
        let tsv = '';
        
        rows.forEach(tr => {
            const cells = tr.querySelectorAll('td');
            if (cells.length > 1) { 
                const rowData = Array.from(cells)
                    .slice(0, 7)
                    .map(td => td.textContent.trim().replace(/\t/g, ' ')) 
                    .join('\t');
                tsv += rowData + '\n';
            }
        });

        const finalContent = header + '\n' + tsv;

        navigator.clipboard.writeText(finalContent).then(() => {
            showLog('✅ Data Pengunjung di tabel berhasil disalin ke clipboard (format tab-separated). Paste ke Excel/Sheets).', false);
        }).catch(err => {
            showLog('❌ Gagal menyalin data. Pastikan browser Anda mengizinkan akses clipboard (gunakan HTTPS): ' + err, true);
            console.error(err);
        });
    }

    // EVENT LISTENER BARU UNTUK SALIN DATA DAN HAPUS SEMUA
    copyPengunjungBtn.addEventListener('click', copyPengunjungData);
    deleteAllPengunjungBtn.addEventListener('click', deleteAllPengunjung); // NEW DELETE ALL LISTENER
    searchPengunjung.addEventListener('input', () => {
        renderPengunjungTable(allPengunjungData, searchPengunjung.value);
    });

    function renderPengunjungTable(dataObj, query = ''){
        if(!dataObj){ 
            tablePengunjung.innerHTML = tablePengunjungHeader + '<tbody><tr><td colspan="8" class="text-center p-4 text-gray-500">Belum ada data pengunjung.</td></tr></tbody>'; 
            return; 
        }
        
        let filteredRows = Object.entries(dataObj); 
        const lowerQuery = query.toLowerCase().trim();
        
        const dataKeys = [
            'nama', 'blok', 'jenjang', 
            'judulBuku', 'kategoriBuku', 'keterangan'
        ];
        
        if (lowerQuery) {
            filteredRows = filteredRows.filter(([key, val]) => {
                const dateStr = `${val.tanggal||''}/${val.bulan||''}/${val.tahun||''}`;
                
                return dateStr.includes(lowerQuery) || 
                       dataKeys.some(k => (val[k] || '').toLowerCase().includes(lowerQuery)); 
            });
        }
        
        let html = '';
        
        if (filteredRows.length === 0) {
             html += `<tr><td colspan="8" class="text-center p-4 text-gray-500">Tidak ada hasil ditemukan untuk "${query}".</td></tr>`;
        } else {
            for(const [key, val] of filteredRows){
                const tanggal = val.tanggal || '??';
                const bulan = val.bulan || '??';
                const tahun = val.tahun || '????';
                const tanggalStr = `${tanggal}/${bulan}/${tahun}`;

                html += `<tr class="odd:bg-gray-50 even:bg-white text-gray-800" data-key="${key}">`;
                
                // KOLOM 1: Tanggal
                html += `<td class="border-b border-gray-200 px-3 py-2 font-semibold">${tanggalStr}</td>`;
                
                // Kolom Data Lain
                dataKeys.forEach(k => {
                    const data = val[k] || '-';
                    html += `<td class="border-b border-gray-200 px-3 py-2">${data}</td>`; 
                });
                
                // Kolom Aksi
                html += `<td class="border-b border-gray-200 px-3 py-2"><button data-action="delete" class="px-3 py-1 text-xs bg-red-600 text-white rounded-md hover:bg-red-700 transition">Hapus</button></td>`;
                html += `</tr>`;
            }
        }
        
        tablePengunjung.innerHTML = tablePengunjungHeader + `<tbody>${html}</tbody>`;
        
        // Logic Hapus
        tablePengunjung.querySelectorAll('button[data-action="delete"]').forEach(btn=>{
            btn.addEventListener('click', async (e)=>{
                const tr = e.target.closest('tr'); 
                const key = tr.dataset.key; 
                if(!confirm(`Yakin hapus record pengunjung ID ${key.substring(0, 8)}...?`)) return; 
                try{ 
                    await remove(ref(db, `pengunjung/${key}`)); 
                    showLog(`Record ${key.substring(0, 8)}... dihapus.`, false); 
                } catch(e){ 
                    showLog(`Gagal menghapus record: ${e.message}`, true); 
                    console.error(e);
                }
            });
        });
    }

    function loadPengunjung(){ 
        onValue(ref(db,'pengunjung'), (snap)=>{ 
            allPengunjungData = snap.val(); 
            renderPengunjungTable(allPengunjungData, searchPengunjung.value); 
            const count = allPengunjungData ? Object.keys(allPengunjungData).length : 0;
            showLog(`Data Pengunjung terbaru dimuat. (${count} entri)`);
        }, (error) => {
            showLog('Gagal memuat data Pengunjung: '+error.message, true);
        });
    }

    document.getElementById('exportPengunjung').addEventListener('click', ()=>{
        get(child(ref(db), 'pengunjung')).then(snap=>{
            const data = snap.val(); 
            if(!data) return showLog('Tidak ada data pengunjung untuk diekspor.', true);
            
            const rows = Object.entries(data).map(([k,v])=> ({ id: k, ...v }));
            
            const colsSet = new Set(['id']); rows.forEach(r=> Object.keys(r).forEach(c=>colsSet.add(c)));
            const cols = Array.from(colsSet).sort((a, b) => { 
                if (a.toLowerCase() === 'tanggal') return -1;
                if (b.toLowerCase() === 'bulan') return 1;
                if (a.toLowerCase() === 'tahun') return 1;
                if (a === 'id') return -1;
                if (b === 'id') return 1;
                return a.localeCompare(b);
            });

            const csv = [cols.join(';')].concat(rows.map(r=> 
                cols.map(c=>`"${(r[c]||'').toString().replace(/"/g,'""')}"`).join(';')
            )).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'pengunjung_perpustakaan.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
            showLog('Data Pengunjung berhasil diekspor ke CSV.', false);
        }).catch(e=>{
            showLog('Gagal ekspor data: '+e.message, true);
            console.error(e);
        });
    });

    // =========================================================
    // TAB LOGIC (Dipertahankan)
    // =========================================================

    const tabSantri = document.getElementById('tabSantri');
    const tabBuku = document.getElementById('tabBuku');
    const tabPengunjung = document.getElementById('tabPengunjung');
    
    const allTabs = [tabPengunjung, tabSantri, tabBuku];

    function setActiveTabStyle(activeTab) {
        allTabs.forEach(tab => {
            if (tab === activeTab) {
                tab.classList.add('bg-cyan-500', 'text-white', 'shadow-lg');
                tab.classList.remove('text-cyan-200', 'hover:bg-cyan-700/50');
            } else {
                tab.classList.remove('bg-cyan-500', 'text-white', 'shadow-lg');
                tab.classList.add('text-cyan-200', 'hover:bg-cyan-700/50');
            }
        });
    }

    function showTab(name){
      sectionSantri.classList.toggle('hidden', name!=='Santri');
      sectionBuku.classList.toggle('hidden', name!=='Buku');
      sectionPengunjung.classList.toggle('hidden', name!=='Pengunjung');
      
      let activeTabElement;
      if (name === 'Pengunjung') { 
          loadPengunjung(); 
          activeTabElement = tabPengunjung;
      } else if (name === 'Santri') {
          loadSiswa();
          clearSantriForm();
          activeTabElement = tabSantri;
      } else if (name === 'Buku') {
          loadBuku();
          clearBukuForm();
          activeTabElement = tabBuku;
      }
      
      setActiveTabStyle(activeTabElement);
    }
    
    tabPengunjung.onclick = ()=>showTab('Pengunjung');
    tabSantri.onclick = ()=>showTab('Santri'); 
    tabBuku.onclick = ()=>showTab('Buku'); 

    // initial load
    showTab('Pengunjung'); 
    showLog('Sistem siap. Memuat data Pengunjung...', false);
    
  </script>
</body>
</html>
