<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Form Kunjungan Perpustakaan | Garis Input Cyan Super Panjang</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Poppins', 'sans-serif'],
          },
        }
      }
    }
  </script>

  <style>
    /* Latar Belakang Gradasi Dark & Cyan */
    body {
        font-family: 'Poppins', sans-serif;
        background-image: linear-gradient(135deg, #0F172A, #06B6D4); 
        min-height: 100vh;
        display: flex;
        justify-content: center; 
        align-items: flex-start; 
        padding: 40px 20px;
    }
    
    /* Container Utama Form yang Terpusat */
    #single-form-container {
        /* PERUBAHAN AGRESIF: Max-width 1024px di desktop untuk kelonggaran maksimal */
        max-width: 600px; /* Default max-w untuk mobile/tablet */
        width: 100%;
        background-color: #ffffff; 
        padding: 2.5rem; 
        border-radius: 1rem; 
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    }
    @media (min-width: 1024px) {
      #single-form-container {
          max-width: 1024px; /* Lebar 1024px (setara max-w-6xl) di perangkat besar */
      }
    }

    /* GAYA INPUT UTAMA (Wajib Isi & Pencarian) */
    .form-element-main {
      /* Garis bawah minimalis abu-abu */
      @apply w-full px-4 py-2 border-0 border-b-2 border-gray-300 bg-white text-gray-800 placeholder-gray-400 focus:ring-0 focus:border-cyan-700 transition duration-300 ease-in-out;
      margin-bottom: 1rem; 
    }
    .form-element-main.filled {
       /* Ketika terisi, garisnya cyan */
       border-color: #0891B2; 
    }
    .form-element-main:focus {
      outline: none;
      border-width: 3px; 
    }


    /* Styling untuk Fokus Keyboard pada Saran */
    .suggestion-focused {
        @apply bg-cyan-600 text-white shadow-lg transform scale-[1.01] transition duration-150 ease-in-out; 
    }
    .suggestion-focused > div {
        @apply text-white !important; 
    }
    .nisSuggestions li:not(.suggestion-focused):hover, 
    .bukuSuggestions li:not(.suggestion-focused):hover {
        @apply bg-cyan-50; 
    }


    /* Input Detail/Koreksi (Termasuk Select) - Minimalis */
    .review-input, .review-select {
        /* Default: garis bawah abu-abu, background abu-abu, disabled/readonly */
        /* Pastikan memiliki padding horizontal yang sama (px-4) */
        @apply w-full px-4 py-2 border-0 border-b-2 border-gray-300 text-gray-700 transition duration-300 ease-in-out;
    }
    /* Khusus untuk input text (Blok) saat Readonly */
    .review-input[readonly] {
        @apply bg-gray-50;
    }
    /* Khusus untuk Select saat Disabled */
    .review-select[disabled] {
        @apply bg-gray-50;
        cursor: not-allowed;
    }

    /* Saat Fokus/Tidak Readonly/Disabled (Mode Edit) - Garis Cyan */
    .review-input:focus, .review-select:not([disabled]):focus {
        @apply border-cyan-500 bg-white border-b-3;
    }
    .review-input:not([readonly]), .review-select:not([disabled]) {
        /* Jika sudah bisa diedit, garisnya menjadi cyan 600 */
        @apply bg-white text-gray-900 border-cyan-600 border-b-2;
    }
    
    /* Styling untuk error */
    .input-error {
        border-color: #EF4444 !important; 
        border-width: 3px !important;
        box-shadow: 0 0 0 2px #FECACA !important;
    }

    /* TOAST NOTIFICATION STYLES (Tidak Berubah) */
    #toast-container {
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .toast {
        @apply p-4 rounded-lg shadow-xl text-white font-semibold mb-3 transform transition-all duration-500;
        opacity: 0;
        transform: translateY(100px);
    }
    .toast.show {
        opacity: 1;
        transform: translateY(0);
    }
    .toast.success { @apply bg-green-500; }
    .toast.error { @apply bg-red-600; }
  </style>
</head>

<body>
  
  <div id="single-form-container">
    <h1 class="text-3xl lg:text-4xl font-bold text-gray-800 mb-8 border-b-4 border-cyan-500 pb-2">Form Kunjungan Perpustakaan</h1>
    
    <div class="space-y-6">
        
        <h3 class="font-bold text-2xl border-b pb-2 border-gray-300 text-gray-800 pt-4 mb-4">Data Santri</h3>

        <div class="relative">
            <label for="nisSearch" class="block mb-2 font-medium text-lg text-gray-700">Nama & NISN Santri</label>
            <input type="text" id="nisSearch" placeholder="Ketik Nama atau NISN..." class="form-element-main" autocomplete="off" autofocus>
            <ul id="nisSuggestions" class="border bg-white max-h-40 overflow-auto hidden absolute z-10 w-full shadow-lg rounded-lg mt-1 text-sm nisSuggestions"></ul>
        </div>
        
        <div>
            <label for="blok" class="block mb-1 font-medium text-gray-700">Blok / Kamar</label>
            <input type="text" id="blok" class="review-input" readonly>
        </div>
        <div>
            <label for="jenjang" class="block mb-1 font-medium text-gray-700">Jenjang Pendidikan</label>
            <select id="jenjang" class="review-select" disabled>
                <option value="" disabled selected>-- Pilih Jenjang --</option>
                <option value="SLTP">SLTP (MTS Sederajat)</option>
                <option value="SLTA">SLTA (MA Sederajat)</option>
                <option value="PT">PT (Mahasiswa Sederajat)</option>
            </select>
        </div>

        <h3 class="font-bold text-2xl border-b pb-2 border-gray-300 text-gray-800 pt-8 mb-4">Data Buku</h3>

        <div class="relative">
            <label for="kodeBukuSearch" class="block mb-2 font-medium text-lg text-gray-700">Judul & Kode Buku</label>
            <input type="text" id="kodeBukuSearch" placeholder="Ketik Judul atau Kode Buku..." class="form-element-main" autocomplete="off">
            <ul id="bukuSuggestions" class="border bg-white max-h-40 overflow-auto hidden absolute z-10 w-full shadow-lg rounded-lg mt-1 text-sm bukuSuggestions"></ul>
        </div>
        
        <div>
            <label for="kategoriBuku" class="block mb-1 font-medium text-gray-700">Kategori Buku</label>
            <select id="kategoriBuku" class="review-select" disabled>
                <option value="" disabled selected>-- Pilih Kategori --</option>
                <option value="Sejarah dan Geografi">Sejarah dan Geografi</option>
                <option value="Kesusastraan">Kesusastraan</option>
                <option value="Komik">Komik</option>
                <option value="Agama">Agama</option>
                <option value="Filsafat dan Psikologi">Filsafat dan Psikologi</option>
                <option value="Ilmu Murni">Ilmu Murni</option>
                <option value="Ilmu Sosial">Ilmu Sosial</option>
                <option value="Ilmu Bahasa">Ilmu Bahasa</option>
                <option value="Berita">Berita</option>
                <option value="Karya Umum">Karya Umum</option>
                <option value="Majalah">Majalah</option>
            </select>
        </div>
        
        <div class="pt-8">
            <label for="keterangan" class="block mb-2 font-medium text-lg text-gray-700">Keterangan Aktivitas</label>
            <select id="keterangan" class="form-element-main">
                <option value="">-- Pilih --</option>
                <option value="Baca">Baca</option>
                <option value="Pinjam">Pinjam</option>
            </select>
        </div>

        <button type="button" id="btnSubmit" class="w-full py-3 mt-8 bg-cyan-600 text-white rounded-xl font-bold text-xl hover:bg-cyan-700 transition duration-300 shadow-lg shadow-cyan-500/50 hover:shadow-xl">Kirim Data Kunjungan</button>
    </div>
  </div>

  <div id="toast-container"></div>

  <script type="module">
    // --- FIREBASE IMPORTS & CONFIG ---
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getDatabase, ref, set, onValue, push } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';

    // *** GANTI DENGAN CONFIG FIREBASE ASLI ANDA ***
    const firebaseConfig = {
      apiKey: "AIzaSyB6gaVW3ye680YylqzSebZugmQepYRA4g4",
      authDomain: "pengunjung-4489b.firebaseapp.com",
      projectId: "pengunjung-4489b",
      storageBucket: "pengunjung-4489b.firebasestorage.app",
      messagingSenderId: "233634425303",
      appId: "1:233634425303:web:9d45d775e703b94843c392",
      databaseURL: "https://pengunjung-4489b-default-rtdb.firebaseio.com" 
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- DOM ELEMENTS & STATE ---
    const $ = id => document.getElementById(id);

    const nisSearch = $('nisSearch');
    const nisSuggestions = $('nisSuggestions');
    const kodeBukuSearch = $('kodeBukuSearch');
    const bukuSuggestions = $('bukuSuggestions');
    const keteranganSelect = $('keterangan');

    // Input Detail/Koreksi
    const blokInput = $('blok');
    const jenjangSelect = $('jenjang');
    const kategoriBukuSelect = $('kategoriBuku'); 
    
    // Semua input yang perlu divalidasi dan direset
    const allInputs = [nisSearch, kodeBukuSearch, keteranganSelect, blokInput, jenjangSelect, kategoriBukuSelect];

    // Data Santri/Buku yang akan disimpan
    let santriList = [];
    let bukuList = [];
    let selectedSantri = { nis: null, nama: null }; 
    let selectedBuku = { kode: null, judul: null }; 
    
    // --- HELPER FUNCTIONS ---
    
    const VALID_JENJANG = ["SLTP", "SLTA", "PT"];
    const VALID_KATEGORI = [
        "Sejarah dan Geografi", "Kesusastraan", "Komik", "Agama", 
        "Filsafat dan Psikologi", "Ilmu Murni", "Ilmu Sosial", 
        "Ilmu Bahasa", "Berita", "Karya Umum", "Majalah"
    ];

    function showToast(message, type = 'success', duration = 4000) {
        const container = $('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `<div class="flex items-center space-x-2">
                            <span>${message}</span>
                           </div>`;
        container.appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 10);

        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 500); 
        }, duration);
    }

    // Toggle Readonly/Disabled pada input review (memungkinkan koreksi)
    function setReviewEditable(isEditable = false) {
        // Blok (Input Text) menggunakan readonly
        blokInput.readOnly = !isEditable;
        
        // Jenjang dan Kategori Buku (Select) menggunakan disabled
        [jenjangSelect, kategoriBukuSelect].forEach(input => {
             input.disabled = !isEditable;
        });
        
        // Visual feedback (Berlaku untuk semua input/select review)
        [blokInput, jenjangSelect, kategoriBukuSelect].forEach(input => {
            if (isEditable) {
                // Saat editable, background putih, garis cyan-600
                input.classList.remove('bg-gray-50', 'border-gray-300');
                input.classList.add('bg-white', 'text-gray-900', 'border-cyan-600');
            } else {
                // Saat non-editable, background abu-abu, garis abu-abu
                input.classList.remove('bg-white', 'text-gray-900', 'border-cyan-600');
                input.classList.add('bg-gray-50', 'border-gray-300');
            }
            // Pastikan tidak ada class error yang tersisa saat reset
            input.classList.remove('input-error');
        });
    }

    function resetForm() {
        allInputs.forEach(input => {
            // Reset value, termasuk select ke opsi kosong ("")
            input.value = '';
            input.classList.remove('filled', 'input-error');
            
            // Atur kembali properti ReadOnly/Disabled dan visual default
            if (input === blokInput) {
                input.readOnly = true;
                input.classList.remove('bg-white', 'text-gray-900', 'border-cyan-600');
                input.classList.add('bg-gray-50', 'border-gray-300');
            } else if (input === jenjangSelect || input === kategoriBukuSelect) {
                input.disabled = true;
                input.classList.remove('bg-white', 'text-gray-900', 'border-cyan-600');
                input.classList.add('bg-gray-50', 'border-gray-300');
            }
        });
        
        $('nisSuggestions').innerHTML = '';
        $('bukuSuggestions').innerHTML = '';

        selectedSantri = { nis: null, nama: null }; 
        selectedBuku = { kode: null, judul: null };
        setReviewEditable(false); 
        nisSearch.focus(); 
    }
    
    // --- VALIDATION & ERROR HANDLING ---
    function clearErrorMarks() {
        allInputs.forEach(input => {
            input.classList.remove('input-error');
            // Kelola kelas 'filled' untuk visual garis cyan
            if (input === nisSearch || input === kodeBukuSearch) {
                 input.classList.remove('filled');
            } else if (input === keteranganSelect) {
                 input.classList.remove('filled'); 
            }
        });
        
        // Tandai input utama yang sudah terisi
        if (selectedSantri.nis) nisSearch.classList.add('filled');
        if (selectedBuku.kode) kodeBukuSearch.classList.add('filled');
        if (keteranganSelect.value) keteranganSelect.classList.add('filled');
    }

    function markEmptyFields() {
        clearErrorMarks();
        let errorCount = 0;
        
        // 1. Validasi Input Utama (Wajib ada pilihan)
        if (!selectedSantri.nis) { nisSearch.classList.add('input-error'); errorCount++; }
        if (!selectedBuku.kode) { kodeBukuSearch.classList.add('input-error'); errorCount++; }
        if (!keteranganSelect.value) { keteranganSelect.classList.add('input-error'); errorCount++; }
        
        // 2. Validasi Input Detail/Koreksi (Wajib diisi/dipilih)
        if (selectedSantri.nis) {
            if (!blokInput.value.trim()) { blokInput.classList.add('input-error'); errorCount++; }
            if (!jenjangSelect.value) { jenjangSelect.classList.add('input-error'); errorCount++; }
        }
        if (selectedBuku.kode) {
            if (!kategoriBukuSelect.value) { kategoriBukuSelect.classList.add('input-error'); errorCount++; }
        }
        
        return errorCount > 0;
    }
    
    // --- DATA LOADING ---
    onValue(ref(db, 'siswa'), (snap) => {
        const data = snap.val();
        // Pastikan jenjang yang diambil dari master data sudah uppercase
        santriList = data ? Object.entries(data).map(([nis, val]) => ({ nis, nama: val.nama, blok: val.blok, jenjang: val.jenjang ? val.jenjang.toUpperCase() : '' })) : [];
        if(santriList.length === 0) showToast('⚠️ Data Santri kosong, tidak bisa mencari data.', 'error');
    });
    
    onValue(ref(db, 'buku'), (snap) => {
        const data = snap.val();
        // Pastikan kategori yang diambil dari master data sudah sesuai casing
        bukuList = data ? Object.entries(data).map(([kode, val]) => ({ kode, judul: val.judul, kategori: val.kategori || '' })) : [];
        if(bukuList.length === 0) showToast('⚠️ Data Buku kosong, tidak bisa mencari data.', 'error');
    });
    
    // --- KEYBOARD NAVIGATION LOGIC ---

    function selectSuggestion(suggestionsEl, li) {
        if (!li) return;
        
        if (suggestionsEl.id === 'nisSuggestions') {
            selectedSantri.nis = li.dataset.nis;
            selectedSantri.nama = li.dataset.nama; 
            
            blokInput.value = li.dataset.blok || '';
            let jenjangVal = li.dataset.jenjang || '';
            
            // Set nilai ke Jenjang Select
            if (VALID_JENJANG.includes(jenjangVal)) {
                 jenjangSelect.value = jenjangVal;
            } else {
                 jenjangSelect.value = ''; // Set ke opsi kosong
                 if (jenjangVal) {
                    showToast('⚠️ Jenjang dari master tidak valid. Harap pilih yang benar.', 'error', 7000);
                 }
            }
            jenjangSelect.classList.remove('input-error');
            
            nisSearch.value = `${li.dataset.nama} (${li.dataset.nis})`;
            nisSearch.classList.add('filled'); 
            
            // Aktifkan edit untuk Blok dan Jenjang
            blokInput.readOnly = false;
            jenjangSelect.disabled = false;
            setReviewEditable(true); 
            
            showToast('✅ Santri dipilih. Harap cek dan lengkapi detail.', 'success');
            
            // Tentukan fokus setelah pemilihan
            if (!blokInput.value) {
                blokInput.focus();
            } else if (!jenjangSelect.value) {
                jenjangSelect.focus();
            } else {
                kodeBukuSearch.focus(); 
            }

        } else if (suggestionsEl.id === 'bukuSuggestions') {
            selectedBuku.kode = li.dataset.kode;
            selectedBuku.judul = li.dataset.judul;
            
            let kategoriVal = li.dataset.kategori || '';
            
            // Set nilai ke Kategori Select
            if (VALID_KATEGORI.includes(kategoriVal)) {
                 kategoriBukuSelect.value = kategoriVal;
            } else {
                 kategoriBukuSelect.value = ''; // Set ke opsi kosong
                 if (kategoriVal) {
                    showToast('⚠️ Kategori dari master tidak valid. Harap pilih yang benar.', 'error', 7000);
                 }
            }
            kategoriBukuSelect.classList.remove('input-error');
            
            kodeBukuSearch.value = `${li.dataset.judul} (${li.dataset.kode})`;
            
            kodeBukuSearch.classList.add('filled'); 
            // Aktifkan edit untuk Kategori Buku
            kategoriBukuSelect.disabled = false; // Gunakan disabled karena ini select
            setReviewEditable(true); 
            
            showToast('✅ Buku dipilih. Harap cek dan lengkapi detail.', 'success');
            
             // Tentukan fokus setelah pemilihan
            if (!kategoriBukuSelect.value) {
                 kategoriBukuSelect.focus();
            } else {
                 keteranganSelect.focus();
            }
        }
        
        suggestionsEl.classList.add('hidden');
        nisSearch.classList.remove('input-error');
        kodeBukuSearch.classList.remove('input-error');
    }

    // Fungsi handleKeydown (Tidak Berubah)
    function handleKeydown(e, searchInput, suggestionsEl) {
        const items = suggestionsEl.querySelectorAll('li');
        if (items.length === 0) return;

        let currentFocused = suggestionsEl.querySelector('.suggestion-focused');
        let currentIndex = Array.from(items).indexOf(currentFocused);

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            currentIndex = (currentIndex + 1) % items.length;
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            currentIndex = (currentIndex - 1 + items.length) % items.length;
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (currentFocused) {
                selectSuggestion(suggestionsEl, currentFocused);
            }
            return;
        }

        items.forEach(item => item.classList.remove('suggestion-focused'));
        if (items[currentIndex]) {
            items[currentIndex].classList.add('suggestion-focused');
            items[currentIndex].scrollIntoView({ block: "nearest" });
        }
    }

    // --- EVENT LISTENERS TAMBAHAN UNTUK VALIDASI KETAT ---

    // Listener untuk Select Jenjang
    jenjangSelect.addEventListener('change', () => {
        jenjangSelect.classList.remove('input-error');
    });

    // Listener untuk Select Kategori Buku
    kategoriBukuSelect.addEventListener('change', () => {
        kategoriBukuSelect.classList.remove('input-error');
    });

    // Untuk input Blok, pastikan visual error muncul saat dikosongkan
    blokInput.addEventListener('blur', () => {
        if (blokInput.readOnly) return;
        if (!blokInput.value.trim()) {
            blokInput.classList.add('input-error');
        } else {
            blokInput.classList.remove('input-error');
        }
    });

    // --- EVENT LISTENERS NIS (SANTRI) ---
    nisSearch.addEventListener('input', () => {
      // Reset detail santri
      blokInput.value = ''; jenjangSelect.value = ''; selectedSantri = { nis: null, nama: null };
      blokInput.readOnly = true; jenjangSelect.disabled = true; // Kunci input detail santri
      setReviewEditable(false); 
      
      const val = nisSearch.value.toLowerCase();
      if(!val){ nisSuggestions.innerHTML=''; nisSuggestions.classList.add('hidden'); nisSearch.classList.remove('filled'); return; }
      
      const matches = santriList.filter(s => s.nama.toLowerCase().includes(val) || s.nis.includes(val)).slice(0, 10);
      
      nisSuggestions.innerHTML = matches.map(s => `
        <li class="px-3 py-1 hover:bg-cyan-50 cursor-pointer border-b border-gray-100 last:border-b-0" 
            data-nis="${s.nis}" data-nama="${s.nama}" data-blok="${s.blok || ''}" data-jenjang="${s.jenjang || ''}">
          <div class="font-semibold text-gray-800">${s.nama} (${s.nis})</div> 
          <div class="text-xs text-gray-500">Blok: ${s.blok || '-'} | Jenjang: ${s.jenjang || '-'}</div>
        </li>`).join('');
        
      nisSuggestions.classList.toggle('hidden', matches.length === 0);
      
      const firstItem = nisSuggestions.querySelector('li');
      if (firstItem) {
          firstItem.classList.add('suggestion-focused');
      }

      nisSearch.classList.remove('input-error', 'filled');
    });

    nisSearch.addEventListener('keydown', (e) => handleKeydown(e, nisSearch, nisSuggestions));
    nisSuggestions.addEventListener('click', e => {
      const li = e.target.closest('li'); if(!li) return;
      selectSuggestion(nisSuggestions, li);
    });
    
    // --- EVENT LISTENERS BUKU ---
    kodeBukuSearch.addEventListener('input', () => {
      // Reset detail buku
      kategoriBukuSelect.value = ''; selectedBuku = { kode: null, judul: null };
      kategoriBukuSelect.disabled = true; // Kunci input detail buku
      
      const val = kodeBukuSearch.value.toLowerCase();
      const suggestionsEl = $('bukuSuggestions');
      
      if(!val){ suggestionsEl.innerHTML=''; suggestionsEl.classList.add('hidden'); kodeBukuSearch.classList.remove('filled'); return; }
      
      const matches = bukuList.filter(b => b.kode.toLowerCase().includes(val) || b.judul.toLowerCase().includes(val)).slice(0, 10);
      
      suggestionsEl.innerHTML = matches.map(b => `
        <li class="px-3 py-1 hover:bg-cyan-50 cursor-pointer border-b border-gray-100 last:border-b-0" 
            data-kode="${b.kode}" data-judul="${b.judul}" data-kategori="${b.kategori || ''}">
          <div class="font-semibold text-gray-800">${b.judul} (${b.kode})</div>
          <div class="text-xs text-gray-500">Kategori: ${b.kategori || '-'}</div>
        </li>`).join('');
        
      suggestionsEl.classList.toggle('hidden', matches.length === 0);
      
      const firstItem = suggestionsEl.querySelector('li');
      if (firstItem) {
          firstItem.classList.add('suggestion-focused');
      }

      kodeBukuSearch.classList.remove('input-error', 'filled');
    });

    kodeBukuSearch.addEventListener('keydown', (e) => handleKeydown(e, kodeBukuSearch, bukuSuggestions));
    $('bukuSuggestions').addEventListener('click', e => {
      const li = e.target.closest('li'); if(!li) return;
      selectSuggestion(bukuSuggestions, li);
    });

    // Event untuk Keterangan
    keteranganSelect.addEventListener('change', () => {
        keteranganSelect.classList.remove('input-error');
        // Keterangan menggunakan filled class untuk visual garis cyan
        keteranganSelect.classList.toggle('filled', !!keteranganSelect.value);
    });
    
    // Hilangkan suggestions saat klik di luar
    document.addEventListener('click', (e) => {
        if (!nisSearch.contains(e.target) && !nisSuggestions.contains(e.target)) {
            nisSuggestions.classList.add('hidden');
        }
        if (!kodeBukuSearch.contains(e.target) && !bukuSuggestions.contains(e.target)) {
            bukuSuggestions.classList.add('hidden');
        }
    });

    // --- LOGIKA SUBMIT PENGUNJUNG ---
    $('btnSubmit').addEventListener('click', async () => {
      
      const hasErrors = markEmptyFields();
      if(hasErrors) {
        showToast('❌ GAGAL: Harap lengkapi semua kolom yang bergaris merah.', 'error', 5000);
        return;
      }
      
      showToast('⏳ Mengirim data...', 'success');

      const now = new Date();
      
      const finalData = {
        nama: selectedSantri.nama, 
        blok: blokInput.value.trim(),
        jenjang: jenjangSelect.value, 
        judulBuku: selectedBuku.judul, 
        kategoriBuku: kategoriBukuSelect.value, // Ambil nilai dari select
        keterangan: keteranganSelect.value,
      };
      
      const payload = {
        nis: selectedSantri.nis,
        ...finalData,
        kodeBuku: selectedBuku.kode, 
        timestamp: now.getTime(),
        tanggal: String(now.getDate()).padStart(2, '0'),
        bulan: String(now.getMonth() + 1).padStart(2, '0'),
        tahun: now.getFullYear(),
        jam: now.toTimeString().substring(0, 5)
      };
        
      try{
        // 1. UPDATE DATA MASTER SANTRI
        await set(ref(db, `siswa/${selectedSantri.nis}`), { nama: finalData.nama, blok: finalData.blok, jenjang: finalData.jenjang });

        // 2. UPDATE DATA MASTER BUKU 
        await set(ref(db, `buku/${selectedBuku.kode}`), { judul: finalData.judulBuku, kategori: finalData.kategoriBuku });

        // 3. MENGIRIM DATA KUNJUNGAN BARU
        await push(ref(db, `pengunjung`), payload); 
        
        showToast('🎉 SUKSES! Data kunjungan dikirim. Form direset.', 'success', 5000);
        resetForm();
        
      } catch(e){ 
        console.error("Firebase Submit Error:", e); 
        showToast('❌ GAGAL TOTAL: Kesalahan sistem saat kirim data/perbarui master. Cek Konsol.', 'error', 7000);
      }
    });

    // Inisialisasi: pastikan input koreksi dikunci
    setReviewEditable(false);
  </script>
</body>
</html>
