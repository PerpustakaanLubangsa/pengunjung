<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Form Kunjungan Perpustakaan | Final Minimalis & Keyboard Friendly</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Poppins', 'sans-serif'],
          },
        }
      }
    }
  </script>

  <style>
    /* Latar Belakang Gradasi Dark & Cyan */
    body {
        font-family: 'Poppins', sans-serif;
        background-image: linear-gradient(135deg, #0F172A, #06B6D4); 
    }
    
    /* GAYA INPUT UTAMA (Wajib Isi) */
    .form-element-main {
      @apply w-full px-4 py-2 border-0 border-b-4 border-red-400 bg-white text-gray-800 placeholder-gray-400 focus:ring-0 focus:border-cyan-700 transition duration-300 ease-in-out;
    }
    .form-element-main.filled {
       border-color: #10B981; /* emerald-500 */
    }

    /* Styling untuk Fokus Keyboard pada Saran (SANGAT MENCILOK) */
    .suggestion-focused {
        /* Latar Belakang Biru Kuat dan Shadow untuk menonjol */
        @apply bg-blue-600 text-white shadow-lg transform scale-[1.01] transition duration-150 ease-in-out; 
    }
    .suggestion-focused > div {
        @apply text-white !important; /* Memastikan teks di dalamnya juga putih/kontras */
    }
    /* Pastikan hover juga terlihat jelas, tapi fokus lebih jelas */
    .nisSuggestions li:not(.suggestion-focused):hover, 
    .bukuSuggestions li:not(.suggestion-focused):hover {
        @apply bg-blue-100;
    }


    /* Input di bagian Koreksi (Sidebar) */
    .review-input {
        @apply w-full px-4 py-2 border-2 border-gray-200 rounded-lg shadow-inner bg-gray-100 text-gray-700 transition duration-300 ease-in-out;
    }
    .review-input:focus {
        @apply border-cyan-500 bg-white;
    }
    
    /* Styling untuk error pada input utama */
    .input-error {
        border-color: #EF4444 !important;
        border-width: 2px !important;
        box-shadow: 0 0 0 2px #FECACA !important;
    }

    /* TOAST NOTIFICATION STYLES */
    #toast-container {
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .toast {
        @apply p-4 rounded-lg shadow-xl text-white font-semibold mb-3 transform transition-all duration-500;
        opacity: 0;
        transform: translateY(100px);
    }
    .toast.show {
        opacity: 1;
        transform: translateY(0);
    }
    .toast.success { @apply bg-green-500; }
    .toast.error { @apply bg-red-600; }

    /* Layout Custom */
    .main-content {
        width: 66.6666%;
        max-width: 900px;
        min-height: 100vh;
    }
    .sidebar {
        width: 33.3333%;
        @apply fixed right-0 top-0 h-full overflow-y-auto;
    }
    @media (max-width: 1024px) {
        .main-content {
            width: 100%;
            padding-right: 1.5rem;
        }
        .sidebar {
            position: relative;
            width: 100%;
            height: auto;
            margin-top: 2rem;
        }
    }
  </style>
</head>

<body class="flex">
  
  <div class="main-content bg-white p-6 lg:p-10 shadow-xl">
    <h1 class="text-3xl lg:text-4xl font-bold text-gray-800 mb-8 border-b-4 border-cyan-500 pb-2">Form Kunjungan Perpustakaan</h1>
    
    <div class="space-y-10 pr-4">
        
        <div class="relative">
          <label for="nisSearch" class="block mb-2 font-medium text-lg text-gray-700">NISN Santri</label>
          <input type="text" id="nisSearch" placeholder="Ketik NISN atau Nama Santri..." class="form-element-main" autocomplete="off" autofocus>
          <ul id="nisSuggestions" class="border bg-white max-h-40 overflow-auto hidden absolute z-10 w-full shadow-lg rounded-lg mt-1 text-sm nisSuggestions"></ul>
        </div>

        <div class="relative">
          <label for="kodeBukuSearch" class="block mb-2 font-medium text-lg text-gray-700">Kode / Judul Buku</label>
          <input type="text" id="kodeBukuSearch" placeholder="Ketik Kode atau Judul Buku..." class="form-element-main" autocomplete="off">
          <ul id="bukuSuggestions" class="border bg-white max-h-40 overflow-auto hidden absolute z-10 w-full shadow-lg rounded-lg mt-1 text-sm bukuSuggestions"></ul>
        </div>

        <div>
          <label for="keterangan" class="block mb-2 font-medium text-lg text-gray-700">Keterangan Aktivitas</label>
          <select id="keterangan" class="form-element-main">
            <option value="">-- Pilih --</option>
            <option value="Baca">Baca</option>
            <option value="Pinjam">Pinjam</option>
          </select>
        </div>

        <button type="button" id="btnSubmit" class="w-full py-3 mt-12 bg-cyan-600 text-white rounded-xl font-bold text-xl hover:bg-cyan-700 transition duration-300 shadow-lg shadow-cyan-500/50 hover:shadow-xl">Kirim Data Kunjungan</button>
    </div>
  </div>

  <div class="sidebar bg-gray-50 p-6 shadow-2xl border-l border-gray-200">
    <h3 class="font-bold text-2xl border-b pb-2 border-cyan-500 text-gray-800 mb-6">Data Santri & Buku</h3>

    <div class="space-y-5">
        <div>
          <label for="nama" class="block mb-1 font-medium text-gray-700">Nama Santri</label>
          <input type="text" id="nama" class="review-input" placeholder="Nama Santri" readonly>
        </div>
        <div>
          <label for="blok" class="block mb-1 font-medium text-gray-700">Blok / Kamar</label>
          <input type="text" id="blok" class="review-input" placeholder="Blok / Kamar" readonly>
        </div>
        <div>
          <label for="jenjang" class="block mb-1 font-medium text-gray-700">Jenjang Pendidikan</label>
          <input type="text" id="jenjang" class="review-input" placeholder="Jenjang" readonly>
        </div>
        <div>
          <label for="judulBuku" class="block mb-1 font-medium text-gray-700">Judul Buku</label>
          <input type="text" id="judulBuku" class="review-input" placeholder="Judul Buku" readonly>
        </div>
        <div>
          <label for="kategoriBuku" class="block mb-1 font-medium text-gray-700">Kategori Buku</label>
          <input type="text" id="kategoriBuku" class="review-input" placeholder="Kategori Buku" readonly>
        </div>
    </div>
  </div>

  <div id="toast-container"></div>

  <script type="module">
    // --- FIREBASE IMPORTS & CONFIG ---
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getDatabase, ref, set, onValue, push } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyB6gaVW3ye680YylqzSebZugmQepYRA4g4",
      authDomain: "pengunjung-4489b.firebaseapp.com",
      projectId: "pengunjung-4489b",
      storageBucket: "pengunjung-4489b.firebasestorage.app",
      messagingSenderId: "233634425303",
      appId: "1:233634425303:web:9d45d775e703b94843c392",
      databaseURL: "https://pengunjung-4489b-default-rtdb.firebaseio.com" 
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- DOM ELEMENTS & STATE ---
    const $ = id => document.getElementById(id);

    const nisSearch = $('nisSearch');
    const nisSuggestions = $('nisSuggestions');
    const kodeBukuSearch = $('kodeBukuSearch');
    const bukuSuggestions = $('bukuSuggestions');
    const keteranganSelect = $('keterangan');

    const mainInputs = [nisSearch, kodeBukuSearch, keteranganSelect];
    
    // Input Review/Koreksi
    const namaInput = $('nama');
    const blokInput = $('blok');
    const jenjangInput = $('jenjang');
    const judulBukuInput = $('judulBuku');
    const kategoriBukuInput = $('kategoriBuku');
    const reviewInputs = [namaInput, blokInput, jenjangInput, judulBukuInput, kategoriBukuInput];

    let santriList = [];
    let bukuList = [];
    let selectedSantri = {}; 
    let selectedBuku = {};   
    
    // --- HELPER FUNCTIONS ---
    
    // Fungsi Toast Notification
    function showToast(message, type = 'success', duration = 4000) {
        const container = $('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `<div class="flex items-center space-x-2">
                            <span>${message}</span>
                           </div>`;
        container.appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 10);

        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 500); 
        }, duration);
    }

    // Toggle Readonly pada input review (memungkinkan koreksi)
    function setReviewEditable(isEditable = false) {
        reviewInputs.forEach(input => {
            input.readOnly = !isEditable;
        });
    }

    function resetForm() {
        mainInputs.forEach(input => {
            input.value = '';
            input.classList.remove('filled', 'input-error');
        });
        reviewInputs.forEach(input => input.value = '');
        
        $('nisSuggestions').innerHTML = '';
        $('bukuSuggestions').innerHTML = '';

        selectedSantri = {}; 
        selectedBuku = {};
        setReviewEditable(false); 
    }
    
    // --- VALIDATION & ERROR HANDLING ---
    function clearErrorMarks() {
        mainInputs.forEach(input => input.classList.remove('input-error'));
        mainInputs.forEach(input => input.classList.remove('filled'));
        if (selectedSantri.nis) nisSearch.classList.add('filled');
        if (selectedBuku.kode) kodeBukuSearch.classList.add('filled');
        if (keteranganSelect.value) keteranganSelect.classList.add('filled');
    }

    function markEmptyFields() {
        clearErrorMarks();
        let errorCount = 0;
        
        if (!selectedSantri.nis) { nisSearch.classList.add('input-error'); errorCount++; }
        if (!selectedBuku.kode) { kodeBukuSearch.classList.add('input-error'); errorCount++; }
        if (!keteranganSelect.value) { keteranganSelect.classList.add('input-error'); errorCount++; }
        
        return errorCount > 0;
    }
    
    // --- DATA LOADING (Realtime Firebase) ---
    onValue(ref(db, 'siswa'), (snap) => {
        const data = snap.val();
        santriList = data ? Object.entries(data).map(([nis, val]) => ({ nis, nama: val.nama, blok: val.blok, jenjang: val.jenjang })) : [];
        if(santriList.length === 0) showToast('‚ö†Ô∏è Data Santri kosong, tidak bisa mencari data.', 'error');
    });
    
    onValue(ref(db, 'buku'), (snap) => {
        const data = snap.val();
        bukuList = data ? Object.entries(data).map(([kode, val]) => ({ kode, judul: val.judul, kategori: val.kategori })) : [];
        if(bukuList.length === 0) showToast('‚ö†Ô∏è Data Buku kosong, tidak bisa mencari data.', 'error');
    });
    
    // --- KEYBOARD NAVIGATION LOGIC ---

    function selectSuggestion(suggestionsEl, li) {
        if (!li) return;
        
        if (suggestionsEl.id === 'nisSuggestions') {
            selectedSantri = { nis: li.dataset.nis };
            namaInput.value = li.dataset.nama;
            blokInput.value = li.dataset.blok;
            jenjangInput.value = li.dataset.jenjang;
            nisSearch.value = `${li.dataset.nama} (${li.dataset.nis})`;
            
            nisSearch.classList.add('filled'); 
            setReviewEditable(true);
            showToast('‚úÖ Santri dipilih. Lanjut ke Kode Buku.', 'success');

        } else if (suggestionsEl.id === 'bukuSuggestions') {
            selectedBuku = { kode: li.dataset.kode };
            judulBukuInput.value = li.dataset.judul;
            kategoriBukuInput.value = li.dataset.kategori;
            kodeBukuSearch.value = `${li.dataset.judul} (${li.dataset.kode})`;
            
            kodeBukuSearch.classList.add('filled'); 
            setReviewEditable(true);
            showToast('‚úÖ Buku dipilih. Lanjut pilih Keterangan.', 'success');
        }
        
        suggestionsEl.classList.add('hidden');
        nisSearch.classList.remove('input-error');
        kodeBukuSearch.classList.remove('input-error');
    }

    function handleKeydown(e, searchInput, suggestionsEl) {
        const items = suggestionsEl.querySelectorAll('li');
        if (items.length === 0) return;

        let currentFocused = suggestionsEl.querySelector('.suggestion-focused');
        let currentIndex = Array.from(items).indexOf(currentFocused);

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            currentIndex = (currentIndex + 1) % items.length;
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            currentIndex = (currentIndex - 1 + items.length) % items.length;
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (currentFocused) {
                selectSuggestion(suggestionsEl, currentFocused);
            }
            return;
        }

        items.forEach(item => item.classList.remove('suggestion-focused'));
        if (items[currentIndex]) {
            items[currentIndex].classList.add('suggestion-focused');
            items[currentIndex].scrollIntoView({ block: "nearest" });
        }
    }

    // --- EVENT LISTENERS NIS (SANTRI) ---
    nisSearch.addEventListener('input', () => {
      namaInput.value = ''; blokInput.value = ''; jenjangInput.value = ''; selectedSantri = {};
      const val = nisSearch.value.toLowerCase();
      if(!val){ nisSuggestions.innerHTML=''; nisSuggestions.classList.add('hidden'); nisSearch.classList.remove('filled'); return; }
      
      const matches = santriList.filter(s => s.nama.toLowerCase().includes(val) || s.nis.includes(val)).slice(0, 10);
      
      nisSuggestions.innerHTML = matches.map(s => `
        <li class="px-3 py-1 hover:bg-blue-100 cursor-pointer border-b border-gray-100 last:border-b-0" 
            data-nis="${s.nis}" data-nama="${s.nama}" data-blok="${s.blok}" data-jenjang="${s.jenjang}">
          <div class="font-semibold text-gray-800">${s.nama} (${s.nis})</div> 
          <div class="text-xs text-gray-500">Blok: ${s.blok || '-'} | Jenjang: ${s.jenjang || '-'}</div>
        </li>`).join('');
        
      nisSuggestions.classList.toggle('hidden', matches.length === 0);
      
      // *** PERBAIKAN: Fokuskan item pertama segera setelah daftar muncul ***
      const firstItem = nisSuggestions.querySelector('li');
      if (firstItem) {
          firstItem.classList.add('suggestion-focused');
      }

      nisSearch.classList.remove('input-error', 'filled');
    });

    nisSearch.addEventListener('keydown', (e) => handleKeydown(e, nisSearch, nisSuggestions));
    
    nisSuggestions.addEventListener('click', e => {
      const li = e.target.closest('li'); if(!li) return;
      selectSuggestion(nisSuggestions, li);
    });
    
    // --- EVENT LISTENERS BUKU ---
    kodeBukuSearch.addEventListener('input', () => {
      judulBukuInput.value = ''; kategoriBukuInput.value = ''; selectedBuku = {};
      const val = kodeBukuSearch.value.toLowerCase();
      const suggestionsEl = $('bukuSuggestions');
      
      if(!val){ suggestionsEl.innerHTML=''; suggestionsEl.classList.add('hidden'); kodeBukuSearch.classList.remove('filled'); return; }
      
      const matches = bukuList.filter(b => b.kode.toLowerCase().includes(val) || b.judul.toLowerCase().includes(val)).slice(0, 10);
      
      suggestionsEl.innerHTML = matches.map(b => `
        <li class="px-3 py-1 hover:bg-blue-100 cursor-pointer border-b border-gray-100 last:border-b-0" 
            data-kode="${b.kode}" data-judul="${b.judul}" data-kategori="${b.kategori}">
          <div class="font-semibold text-gray-800">${b.judul} (${b.kode})</div>
          <div class="text-xs text-gray-500">Kategori: ${b.kategori || '-'}</div>
        </li>`).join('');
        
      suggestionsEl.classList.toggle('hidden', matches.length === 0);
      
      // *** PERBAIKAN: Fokuskan item pertama segera setelah daftar muncul ***
      const firstItem = suggestionsEl.querySelector('li');
      if (firstItem) {
          firstItem.classList.add('suggestion-focused');
      }

      kodeBukuSearch.classList.remove('input-error', 'filled');
    });

    kodeBukuSearch.addEventListener('keydown', (e) => handleKeydown(e, kodeBukuSearch, bukuSuggestions));

    $('bukuSuggestions').addEventListener('click', e => {
      const li = e.target.closest('li'); if(!li) return;
      selectSuggestion(bukuSuggestions, li);
    });

    // Event untuk Keterangan
    keteranganSelect.addEventListener('change', () => {
        keteranganSelect.classList.remove('input-error');
        keteranganSelect.classList.toggle('filled', !!keteranganSelect.value);
        if (keteranganSelect.value) {
             showToast('‚úÖ Semua data wajib terisi. Siap Kirim!', 'success');
        }
    });
    
    // Hilangkan suggestions saat klik di luar
    document.addEventListener('click', (e) => {
        if (!nisSearch.contains(e.target) && !nisSuggestions.contains(e.target)) {
            nisSuggestions.classList.add('hidden');
        }
        if (!kodeBukuSearch.contains(e.target) && !bukuSuggestions.contains(e.target)) {
            bukuSuggestions.classList.add('hidden');
        }
    });

    // --- LOGIKA SUBMIT PENGUNJUNG ---
    $('btnSubmit').addEventListener('click', async () => {
      
      const hasErrors = markEmptyFields();
      if(hasErrors) {
        showToast('‚ùå GAGAL: Harap lengkapi kolom yang bergaris merah.', 'error', 5000);
        return;
      }
      
      showToast('‚è≥ Mengirim data...', 'success');

      const now = new Date();
      
      // Ambil nilai final dari input Review (setelah dikoreksi)
      const finalData = {
        nama: namaInput.value.trim(),
        blok: blokInput.value.trim(),
        jenjang: jenjangInput.value.trim(),
        judulBuku: judulBukuInput.value.trim(),
        kategoriBuku: kategoriBukuInput.value.trim(),
        keterangan: keteranganSelect.value,
      };
      
      const payload = {
        nis: selectedSantri.nis,
        ...finalData,
        kodeBuku: selectedBuku.kode, 
        timestamp: now.getTime(),
        tanggal: String(now.getDate()).padStart(2, '0'),
        bulan: String(now.getMonth() + 1).padStart(2, '0'),
        tahun: now.getFullYear(),
        jam: now.toTimeString().substring(0, 5)
      };
        
      try{
        // 1. UPDATE DATA MASTER SANTRI
        await set(ref(db, `siswa/${selectedSantri.nis}`), { nama: finalData.nama, blok: finalData.blok, jenjang: finalData.jenjang });

        // 2. UPDATE DATA MASTER BUKU 
        await set(ref(db, `buku/${selectedBuku.kode}`), { judul: finalData.judulBuku, kategori: finalData.kategoriBuku });

        // 3. MENGIRIM DATA KUNJUNGAN BARU
        await push(ref(db, `pengunjung`), payload); 
        
        showToast('üéâ SUKSES! Data kunjungan dikirim. Form direset.', 'success', 5000);
        resetForm();
        
      } catch(e){ 
        console.error("Firebase Submit Error:", e); 
        showToast('‚ùå GAGAL TOTAL: Kesalahan sistem saat kirim data/perbarui master. Cek Konsol.', 'error', 7000);
      }
    });

    setReviewEditable(false);

  </script>
</body>
</html>
