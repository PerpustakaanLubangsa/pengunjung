<!doctype html>
<html lang="id">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Form Kunjungan - Perpustakaan Lubangsa</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
            colors: {
              'gold': '#d4af37',
              'gold-dark': '#b8952d',
              'dark-bg': '#05070a',
              'card-bg': '#11141b',
              'border-muted': '#1e293b'
            }
          }
        }
      }
    </script>

    <style>
      body {
          background-color: #05070a;
          color: #F1F5F9;
          display: flex;
          justify-content: center;
          align-items: center;
          min-height: 100vh;
          margin: 0;
          padding: 15px;
      }

      .custom-dropdown {
          position: absolute;
          top: 100%;
          left: 0;
          right: 0;
          background: #11141b;
          border: 1px solid #d4af37;
          border-radius: 8px;
          margin-top: 4px;
          box-shadow: 0 10px 25px rgba(0,0,0,0.7);
          z-index: 9999;
          max-height: 200px;
          overflow-y: auto;
          display: none;
      }

      .dropdown-item {
          padding: 10px 14px;
          cursor: pointer;
          border-bottom: 1px solid #1e293b;
      }

      .input-field {
          width: 100%;
          background-color: #11141b;
          border: 1px solid #1e293b;
          border-radius: 10px;
          padding: 10px 14px;
          color: white;
          outline: none;
          transition: all 0.2s;
          font-size: 0.9rem;
      }

      .input-field:focus {
          border-color: #d4af37;
          box-shadow: 0 0 8px rgba(212, 175, 55, 0.15);
      }

      .input-error {
          border-color: #EF4444 !important;
          background-color: rgba(239, 68, 68, 0.05) !important;
          animation: shake 0.3s ease;
      }

      @keyframes shake {
          0%, 100% { transform: translateX(0); }
          25% { transform: translateX(3px); }
          75% { transform: translateX(-3px); }
      }

      ::-webkit-scrollbar { width: 3px; }
      ::-webkit-scrollbar-thumb { background: #d4af37; }
    </style>
</head>

<body class="antialiased">
    <div class="max-w-md w-full">
        <div class="bg-card-bg border border-border-muted p-6 rounded-[1.5rem] shadow-2xl relative">
            <header class="mb-6 text-center">
                <div class="inline-flex p-3 rounded-xl bg-gold/10 mb-3 border border-gold/20">
                    <i class="fas fa-book-reader text-xl text-gold"></i>
                </div>
                <h1 class="text-xl font-bold text-white tracking-tight uppercase">Buku Tamu</h1>
                <p id="dataStatus" class="text-[9px] text-gold mt-1 uppercase tracking-widest opacity-70">Menghubungkan...</p>
            </header>

            <form id="logForm" class="space-y-4">
                <div class="relative">
                    <label class="text-[9px] uppercase tracking-widest text-slate-500 ml-1 mb-1 block">Data Pengunjung</label>
                    <input type="text" id="nisSearch" placeholder="Nama / NISN..." class="input-field required-input" autocomplete="off">
                    <ul id="dd-nisSearch" class="custom-dropdown"></ul>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[9px] uppercase tracking-widest text-slate-500 ml-1 mb-1 block">Blok/Kamar</label>
                        <input type="text" id="blok" placeholder="Lokasi" class="input-field required-input">
                    </div>
                    <div>
                        <label class="text-[9px] uppercase tracking-widest text-slate-500 ml-1 mb-1 block">Jenjang</label>
                        <select id="jenjang" class="input-field required-input">
                            <option value="">Pilih</option>
                            <option value="SLTP">SLTP</option>
                            <option value="SLTA">SLTA</option>
                            <option value="PT">PT</option>
                        </select>
                    </div>
                </div>

                <div class="relative">
                    <label class="text-[9px] uppercase tracking-widest text-slate-500 ml-1 mb-1 block">Referensi Buku</label>
                    <input type="text" id="kodeBukuSearch" placeholder="Judul / Kode..." class="input-field required-input" autocomplete="off">
                    <ul id="dd-kodeBukuSearch" class="custom-dropdown"></ul>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[9px] uppercase tracking-widest text-slate-500 ml-1 mb-1 block">Kategori</label>
                        <select id="kategoriBuku" class="input-field required-input text-xs">
                            <option value="">Pilih</option>
                            <option value="Agama">Agama</option>
                            <option value="Filsafat dan Psikologi">Filsafat & Psiko</option>
                            <option value="Ilmu Sosial">Ilmu Sosial</option>
                            <option value="Ilmu Bahasa">Ilmu Bahasa</option>
                            <option value="Ilmu Murni">Ilmu Murni</option>
                            <option value="Kesenian">Kesenian</option>
                            <option value="Kesusastraan">Kesusastraan</option>
                            <option value="Sejarah dan Geografi">Sejarah</option>
                            <option value="Komik">Komik</option>
                            <option value="Managemen">Managemen</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[9px] uppercase tracking-widest text-slate-500 ml-1 mb-1 block">Aktivitas</label>
                        <select id="keterangan" class="input-field required-input text-xs">
                            <option value="">Pilih</option>
                            <option value="Baca">Baca</option>
                            <option value="Pinjam">Pinjam</option>
                        </select>
                    </div>
                </div>

                <button type="button" id="btnSubmit" class="w-full bg-gold hover:bg-gold-dark text-dark-bg font-bold py-3 rounded-lg mt-2 transition shadow-lg uppercase tracking-widest text-xs">
                    Kirim Laporan
                </button>
            </form>
        </div>
    </div>

    <div id="successModal" class="fixed inset-0 bg-dark-bg/90 backdrop-blur-sm hidden items-center justify-center z-[10000] p-4">
        <div class="bg-card-bg p-8 rounded-[1.5rem] max-w-xs w-full text-center border border-gold/30">
            <div class="w-16 h-16 bg-gold/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-gold/20">
                <i class="fas fa-check text-2xl text-gold"></i>
            </div>
            <h2 class="text-lg font-bold text-white mb-1">Berhasil!</h2>
            <p class="text-slate-400 text-xs mb-6">Data kunjungan telah tercatat.</p>
            <button id="closeModalBtn" class="w-full bg-border-muted text-white py-2 rounded-lg font-semibold text-sm">Selesai</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
        import { getDatabase, ref, onValue, push } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyByw2om-sKHqgCWBDcE7FEtONoUoJbn9M",
            authDomain: "traying-29bf4.firebaseapp.com",
            projectId: "traying-29bf4",
            databaseURL: "https://traying-29bf4-default-rtdb.firebaseio.com"
        };
        
        const $ = id => document.getElementById(id);
        const DOM = {
            form: $('logForm'),
            nisSearch: $('nisSearch'),
            kodeBukuSearch: $('kodeBukuSearch'),
            nisDropdown: $('dd-nisSearch'),
            bukuDropdown: $('dd-kodeBukuSearch'),
            blokInput: $('blok'),
            jenjangSelect: $('jenjang'),
            kategoriBukuSelect: $('kategoriBuku'),
            keteranganSelect: $('keterangan'),
            btnSubmit: $('btnSubmit'),
            successModal: $('successModal'),
            closeModalBtn: $('closeModalBtn'),
            dataStatus: $('dataStatus')
        };

        const DATA_PATH = 'log_kunjungan_2025';
        let santriList = [], bukuList = [];

        try {
            const app = initializeApp(firebaseConfig);
            const db = getDatabase(app);

            onValue(ref(db, 'keanggotaan_v2'), (snap) => {
                const data = snap.val();
                santriList = data ? Object.entries(data).map(([nis, v]) => ({ 
                    nis: nis || '', 
                    nama: v.keanggotaan || '', 
                    blok: v.blok || '', 
                    jenjang: v.jenjang || '' 
                })) : [];
                DOM.dataStatus.innerText = "Sistem Siap";
            });

            onValue(ref(db, 'buku_v2'), (snap) => {
                const data = snap.val();
                bukuList = data ? Object.entries(data).map(([kode, v]) => ({ 
                    kode: kode || '', 
                    judul: v.judul || '', 
                    kategori: v.kategori || '' 
                })) : [];
            });

            const handleSearch = (input, dropdown, list, type) => {
                const val = input.value.toLowerCase().trim();
                input.classList.remove('input-error');
                if (!val) { dropdown.style.display = 'none'; return; }
                const matches = list.filter(item => {
                    const name = type === 'user' ? (item.nama || '') : (item.judul || '');
                    const id = type === 'user' ? (item.nis || '') : (item.kode || '');
                    return name.toLowerCase().includes(val) || id.toLowerCase().includes(val);
                }).slice(0, 5);
                dropdown.innerHTML = '';
                matches.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'dropdown-item';
                    li.innerHTML = type === 'user' 
                        ? `<div class="text-xs font-bold text-white">${item.nama}</div><div class="text-[9px] text-gold/60 uppercase">${item.nis}</div>`
                        : `<div class="text-xs font-bold text-white">${item.judul}</div><div class="text-[9px] text-gold/60 uppercase">${item.kode}</div>`;
                    li.onclick = () => {
                        if (type === 'user') {
                            input.value = item.nama;
                            DOM.blokInput.value = item.blok;
                            DOM.jenjangSelect.value = item.jenjang;
                        } else {
                            input.value = item.judul;
                            DOM.kategoriBukuSelect.value = item.kategori;
                        }
                        dropdown.style.display = 'none';
                    };
                    dropdown.appendChild(li);
                });
                dropdown.style.display = matches.length ? 'block' : 'none';
            };

            DOM.nisSearch.addEventListener('input', () => handleSearch(DOM.nisSearch, DOM.nisDropdown, santriList, 'user'));
            DOM.kodeBukuSearch.addEventListener('input', () => handleSearch(DOM.kodeBukuSearch, DOM.bukuDropdown, bukuList, 'buku'));

            DOM.btnSubmit.onclick = async () => {
                const inputs = document.querySelectorAll('.required-input');
                let isValid = true;
                inputs.forEach(input => {
                    if (!input.value.trim()) {
                        input.classList.add('input-error');
                        isValid = false;
                    }
                });
                if (!isValid) return;
                DOM.btnSubmit.disabled = true;
                DOM.btnSubmit.innerText = "Kirim...";
                const now = new Date();
                try {
                    await push(ref(db, DATA_PATH), {
                        nama: DOM.nisSearch.value,
                        nis: DOM.nisSearch.value,
                        blok: DOM.blokInput.value,
                        jenjang: DOM.jenjangSelect.value,
                        judulBuku: DOM.kodeBukuSearch.value,
                        kodeBuku: DOM.kodeBukuSearch.value,
                        kategoriBuku: DOM.kategoriBukuSelect.value,
                        keterangan: DOM.keteranganSelect.value,
                        timestamp: now.getTime(),
                        tanggal: String(now.getDate()).padStart(2, '0'),
                        bulan: String(now.getMonth() + 1).padStart(2, '0'),
                        tahun: now.getFullYear(),
                        jam: now.toTimeString().substring(0, 5)
                    });
                    DOM.successModal.style.display = 'flex';
                    DOM.form.reset();
                } catch (e) { alert("Gagal."); } finally {
                    DOM.btnSubmit.disabled = false;
                    DOM.btnSubmit.innerText = "Kirim Laporan";
                }
            };

            DOM.closeModalBtn.onclick = () => DOM.successModal.style.display = 'none';
            document.addEventListener('click', (e) => {
                if (!DOM.nisSearch.contains(e.target)) DOM.nisDropdown.style.display = 'none';
                if (!DOM.kodeBukuSearch.contains(e.target)) DOM.bukuDropdown.style.display = 'none';
            });
        } catch (e) { console.error(e); }
    </script>
</body>
</html>
