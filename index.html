<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Form Kunjungan Perpustakaan | Kotak Jelas & Pop-up Kustom</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Poppins', 'sans-serif'],
          },
        }
      }
    }
  </script>

  <style>
    /* Latar Belakang Gradasi Dark & Cyan */
    body {
        font-family: 'Poppins', sans-serif;
        background-image: linear-gradient(135deg, #0F172A, #06B6D4); 
        min-height: 100vh;
        display: flex;
        justify-content: center; 
        align-items: flex-start; 
        padding: 40px 20px;
    }
    
    /* Container Utama Form yang Terpusat */
    #single-form-container {
        max-width: 600px; 
        width: 100%;
        background-color: #ffffff; 
        padding: 2.5rem; 
        border-radius: 1rem; 
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    }
    @media (min-width: 1024px) {
      #single-form-container {
          max-width: 1024px; 
      }
    }

    /* GAYA INPUT UTAMA (Kotak Jelas, Panjang, dan Besar) */
    .form-element-main {
      /* Padding besar, border jelas, rounded */
      @apply w-full px-4 py-3 border border-gray-400 bg-white text-gray-800 placeholder-gray-400 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition duration-300 ease-in-out;
      margin-bottom: 1rem; 
    }
    .form-element-main.filled {
       /* Mengubah border menjadi cyan saat terisi */
       border-color: #0891B2; 
    }
    .form-element-main:focus {
      outline: none;
    }

    /* Input Detail/Koreksi (Kotak Jelas, Panjang, dan Besar) */
    .review-input, .review-select {
        /* Padding besar, border jelas, rounded */
        @apply w-full px-4 py-3 border border-gray-400 bg-white text-gray-900 rounded-lg transition duration-300 ease-in-out;
    }
    
    .review-input[readonly], .review-select[disabled] {
        @apply bg-gray-100 border-gray-300; 
        cursor: text; 
    }

    /* Saat Fokus - Ring Cyan */
    .review-input:focus, .review-select:focus {
        @apply border-cyan-500 bg-white ring-2 ring-cyan-500;
    }

    /* Styling untuk error (Kotak Merah) */
    .input-error {
        border-color: #EF4444 !important; 
        border-width: 2px !important;
        box-shadow: 0 0 0 2px #FECACA !important;
    }

    /* Styling untuk Fokus Keyboard pada Saran */
    .suggestion-focused {
        @apply bg-cyan-600 text-white shadow-lg transform scale-[1.01] transition duration-150 ease-in-out; 
    }
    .suggestion-focused > div {
        @apply text-white !important; 
    }
    .nisSuggestions li:not(.suggestion-focused):hover, 
    .bukuSuggestions li:not(.suggestion-focused):hover {
        @apply bg-cyan-50; 
    }

    /* Override Select Box agar proporsional dengan input teks */
    .review-select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%236B7280'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd' /%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 1rem center;
        background-size: 1.5em;
        padding-right: 2.5rem; 
    }

    /* --- CUSTOM MODAL/POP-UP STYLES --- */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: none; /* Default tersembunyi */
        justify-content: center;
        align-items: center;
        z-index: 50; 
        opacity: 0;
        transition: opacity 0.3s ease-out;
    }

    .modal-overlay.active {
        display: flex;
        opacity: 1;
    }

    .modal-content {
        background: white;
        padding: 30px;
        border-radius: 12px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        transform: translateY(-50px);
        transition: transform 0.3s ease-out;
    }

    .modal-overlay.active .modal-content {
        transform: translateY(0);
    }
    
  </style>
</head>

<body>
  
  <div id="single-form-container">
    <h1 class="text-3xl lg:text-4xl font-bold text-gray-800 mb-8 border-b-4 border-cyan-500 pb-2">Form Kunjungan Perpustakaan</h1>
    
    <div class="space-y-6">
        
        <h3 class="font-bold text-2xl border-b pb-2 border-gray-300 text-gray-800 pt-4 mb-4">Data Santri</h3>

        <div class="relative">
            <label for="nisSearch" class="block mb-2 font-medium text-lg text-gray-700">Nama & NISN Santri</label>
            <input type="text" id="nisSearch" placeholder="Ketik Nama atau NISN..." class="form-element-main" autocomplete="off" autofocus>
            <ul id="nisSuggestions" class="border bg-white max-h-40 overflow-auto hidden absolute z-10 w-full shadow-lg rounded-lg mt-1 text-sm nisSuggestions"></ul>
        </div>
        
        <div>
            <label for="blok" class="block mb-1 font-medium text-gray-700">Blok / Kamar</label>
            <input type="text" id="blok" class="review-input uppercase"> 
        </div>
        <div>
            <label for="jenjang" class="block mb-1 font-medium text-gray-700">Jenjang Pendidikan</label>
            <select id="jenjang" class="review-select">
                <option value="" selected>-- Pilih Jenjang --</option>
                <option value="SLTP">SLTP (MTS Sederajat)</option>
                <option value="SLTA">SLTA (MA Sederajat)</option>
                <option value="PT">PT (Mahasiswa Sederajat)</option>
            </select>
        </div>

        <h3 class="font-bold text-2xl border-b pb-2 border-gray-300 text-gray-800 pt-8 mb-4">Data Buku</h3>

        <div class="relative">
            <label for="kodeBukuSearch" class="block mb-2 font-medium text-lg text-gray-700">Judul & Kode Buku</label>
            <input type="text" id="kodeBukuSearch" placeholder="Ketik Judul atau Kode Buku..." class="form-element-main" autocomplete="off">
            <ul id="bukuSuggestions" class="border bg-white max-h-40 overflow-auto hidden absolute z-10 w-full shadow-lg rounded-lg mt-1 text-sm bukuSuggestions"></ul>
        </div>
        
        <div>
            <label for="kategoriBuku" class="block mb-1 font-medium text-gray-700">Kategori Buku</label>
            <select id="kategoriBuku" class="review-select">
                <option value="" selected>-- Pilih Kategori --</option>
                <option value="Sejarah dan Geografi">Sejarah dan Geografi</option>
                <option value="Kesusastraan">Kesusastraan</option>
                <option value="Komik">Komik</option>
                <option value="Agama">Agama</option>
                <option value="Filsafat dan Psikologi">Filsafat dan Psikologi</option>
                <option value="Ilmu Murni">Ilmu Murni</option>
                <option value="Ilmu Sosial">Ilmu Sosial</option>
                <option value="Ilmu Bahasa">Ilmu Bahasa</option>
                <option value="Berita">Berita</option>
                <option value="Karya Umum">Karya Umum</option>
                <option value="Majalah">Majalah</option>
            </select>
        </div>
        
        <div class="pt-8">
            <label for="keterangan" class="block mb-2 font-medium text-lg text-gray-700">Keterangan Aktivitas</label>
            <select id="keterangan" class="form-element-main">
                <option value="">-- Pilih --</option>
                <option value="Baca">Baca</option>
                <option value="Pinjam">Pinjam</option>
            </select>
        </div>

        <button type="button" id="btnSubmit" class="w-full py-3 mt-8 bg-cyan-600 text-white rounded-xl font-bold text-xl hover:bg-cyan-700 transition duration-300 shadow-lg shadow-cyan-500/50 hover:shadow-xl">Kirim Data Kunjungan</button>
    </div>
  </div>

  <div id="successModal" class="modal-overlay">
    <div class="modal-content text-center">
      <div class="text-6xl text-cyan-600 mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </div>
      <h4 class="text-2xl font-bold text-gray-800 mb-2">Data Kunjungan Berhasil Dikirim!</h4>
      <p class="text-gray-600 mb-6">Terima kasih. Data form telah direset dan siap untuk entri berikutnya.</p>
      <button id="closeModalBtn" class="bg-cyan-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-cyan-700 transition">Tutup</button>
    </div>
  </div>


  <script type="module">
    // --- FIREBASE IMPORTS & CONFIG ---
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getDatabase, ref, set, onValue, push } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';

    // *** GANTI DENGAN CONFIG FIREBASE ASLI ANDA ***
    const firebaseConfig = {
      apiKey: "AIzaSyB6gaVW3ye680YylqzSebZugmQepYRA4g4",
      authDomain: "pengunjung-4489b.firebaseapp.com",
      projectId: "pengunjung-4489b",
      storageBucket: "pengunjung-4489b.firebasestorage.app",
      messagingSenderId: "233634425303",
      appId: "1:233634425303:web:9d45d775e703b94843c392",
      databaseURL: "https://pengunjung-4489b-default-rtdb.firebaseio.com" 
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- DOM ELEMENTS & STATE ---
    const $ = id => document.getElementById(id);

    const nisSearch = $('nisSearch');
    const nisSuggestions = $('nisSuggestions');
    const kodeBukuSearch = $('kodeBukuSearch');
    const bukuSuggestions = $('bukuSuggestions');
    const keteranganSelect = $('keterangan');

    // Input Detail/Koreksi
    const blokInput = $('blok');
    const jenjangSelect = $('jenjang');
    const kategoriBukuSelect = $('kategoriBuku'); 
    
    // Elemen Modal
    const successModal = $('successModal');
    const closeModalBtn = $('closeModalBtn');

    // Semua input yang perlu divalidasi dan direset
    const allInputs = [nisSearch, kodeBukuSearch, keteranganSelect, blokInput, jenjangSelect, kategoriBukuSelect];

    let santriList = [];
    let bukuList = [];
    let selectedSantri = { nis: null, nama: null }; 
    let selectedBuku = { kode: null, judul: null }; 
    
    // --- HELPER FUNCTIONS ---
    
    const VALID_JENJANG = ["SLTP", "SLTA", "PT"];
    const VALID_KATEGORI = [
        "Sejarah dan Geografi", "Kesusastraan", "Komik", "Agama", 
        "Filsafat dan Psikologi", "Ilmu Murni", "Ilmu Sosial", 
        "Ilmu Bahasa", "Berita", "Karya Umum", "Majalah"
    ];

    function parseInput(inputElement) {
        const fullValue = inputElement.value.trim();
        const match = fullValue.match(/\(([^)]+)\)$/); 

        if (match) {
            const id = match[1].trim(); 
            const name = fullValue.replace(match[0], '').trim(); 
            return { id: id, name: name || id }; 
        } else {
            return { id: fullValue, name: fullValue }; 
        }
    }

    function showModal() {
        successModal.classList.add('active');
    }

    function hideModal() {
        successModal.classList.remove('active');
    }


    function resetForm() {
        allInputs.forEach(input => {
            input.value = '';
            input.classList.remove('filled', 'input-error');
        });
        
        jenjangSelect.value = '';
        kategoriBukuSelect.value = '';
        
        $('nisSuggestions').innerHTML = '';
        $('bukuSuggestions').innerHTML = '';

        selectedSantri = { nis: null, nama: null }; 
        selectedBuku = { kode: null, judul: null }; 
        
        nisSearch.focus(); 
    }
    
    // --- VALIDATION & ERROR HANDLING ---
    function clearErrorMarks() {
        allInputs.forEach(input => {
            input.classList.remove('input-error');
        });
    }

    function markEmptyFields() {
        clearErrorMarks();
        let errorCount = 0;
        
        // Cek semua input wajib terisi
        if (!nisSearch.value.trim()) { nisSearch.classList.add('input-error'); errorCount++; }
        if (!kodeBukuSearch.value.trim()) { kodeBukuSearch.classList.add('input-error'); errorCount++; }
        if (!keteranganSelect.value) { keteranganSelect.classList.add('input-error'); errorCount++; }
        
        if (!blokInput.value.trim()) { blokInput.classList.add('input-error'); errorCount++; }
        if (!jenjangSelect.value) { jenjangSelect.classList.add('input-error'); errorCount++; }
        if (!kategoriBukuSelect.value) { kategoriBukuSelect.classList.add('input-error'); errorCount++; }
        
        return errorCount > 0;
    }
    
    // --- DATA LOADING (Tidak Berubah) ---
    onValue(ref(db, 'siswa'), (snap) => {
        const data = snap.val();
        santriList = data ? Object.entries(data).map(([nis, val]) => ({ nis, nama: val.nama, blok: val.blok, jenjang: val.jenjang ? val.jenjang.toUpperCase() : '' })) : [];
        if(santriList.length === 0) console.warn('Data Santri kosong, tidak bisa mencari data.');
    });
    
    onValue(ref(db, 'buku'), (snap) => {
        const data = snap.val();
        bukuList = data ? Object.entries(data).map(([kode, val]) => ({ kode, judul: val.judul, kategori: val.kategori || '' })) : [];
        if(bukuList.length === 0) console.warn('Data Buku kosong, tidak bisa mencari data.');
    });
    
    // --- LOGIKA AUTOFILL/SUGGESTION (Tidak Berubah) ---
    function selectSuggestion(suggestionsEl, li) {
        if (!li) return;
        
        if (suggestionsEl.id === 'nisSuggestions') {
            selectedSantri.nis = li.dataset.nis;
            selectedSantri.nama = li.dataset.nama; 
            
            blokInput.value = li.dataset.blok || ''; 
            let jenjangVal = li.dataset.jenjang || '';
            if (VALID_JENJANG.includes(jenjangVal)) {
                 jenjangSelect.value = jenjangVal;
            } else {
                 jenjangSelect.value = ''; 
            }
            
            nisSearch.value = `${li.dataset.nama} (${li.dataset.nis})`;
            nisSearch.classList.add('filled'); 
            
            blokInput.classList.remove('input-error');
            jenjangSelect.classList.remove('input-error');
            nisSearch.classList.remove('input-error');
            
            if (!blokInput.value) {
                blokInput.focus();
            } else if (!jenjangSelect.value) {
                jenjangSelect.focus();
            } else {
                kodeBukuSearch.focus(); 
            }

        } else if (suggestionsEl.id === 'bukuSuggestions') {
            selectedBuku.kode = li.dataset.kode;
            selectedBuku.judul = li.dataset.judul;
            
            let kategoriVal = li.dataset.kategori || '';
            
            if (VALID_KATEGORI.includes(kategoriVal)) {
                 kategoriBukuSelect.value = kategoriVal;
            } else {
                 kategoriBukuSelect.value = ''; 
            }
            
            kodeBukuSearch.value = `${li.dataset.judul} (${li.dataset.kode})`;
            kodeBukuSearch.classList.add('filled'); 
            
            kategoriBukuSelect.classList.remove('input-error');
            kodeBukuSearch.classList.remove('input-error');
            
            if (!kategoriBukuSelect.value) {
                 kategoriBukuSelect.focus();
            } else {
                 keteranganSelect.focus();
            }
        }
        
        suggestionsEl.classList.add('hidden');
    }

    function handleKeydown(e, searchInput, suggestionsEl) {
        const items = suggestionsEl.querySelectorAll('li');
        if (items.length === 0) return;

        let currentFocused = suggestionsEl.querySelector('.suggestion-focused');
        let currentIndex = Array.from(items).indexOf(currentFocused);

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            currentIndex = (currentIndex + 1) % items.length;
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            currentIndex = (currentIndex - 1 + items.length) % items.length;
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (currentFocused) {
                selectSuggestion(suggestionsEl, currentFocused);
            }
            return;
        }

        items.forEach(item => item.classList.remove('suggestion-focused'));
        if (items[currentIndex]) {
            items[currentIndex].classList.add('suggestion-focused');
            items[currentIndex].scrollIntoView({ block: "nearest" });
        }
    }
    
    // --- EVENT LISTENERS: INPUT & MODAL CONTROL ---

    // Event listener untuk input (Tidak berubah, hanya memastikan input-error hilang saat mengetik)
    nisSearch.addEventListener('input', () => {
        // ... (Logika search) ...
        // [Tambahkan logika search santri yang sudah ada di kode sebelumnya di sini]
        
        nisSearch.classList.remove('filled', 'input-error');
        selectedSantri = { nis: null, nama: null }; 
        
        const val = nisSearch.value.toLowerCase();
        if(!val){ nisSuggestions.innerHTML=''; nisSuggestions.classList.add('hidden'); return; }
        
        const matches = santriList.filter(s => s.nama.toLowerCase().includes(val) || s.nis.includes(val)).slice(0, 10);
        
        nisSuggestions.innerHTML = matches.map(s => `
          <li class="px-3 py-1 hover:bg-cyan-50 cursor-pointer border-b border-gray-100 last:border-b-0" 
              data-nis="${s.nis}" data-nama="${s.nama}" data-blok="${s.blok || ''}" data-jenjang="${s.jenjang || ''}">
            <div class="font-semibold text-gray-800">${s.nama} (${s.nis})</div> 
            <div class="text-xs text-gray-500">Blok: ${s.blok || '-'} | Jenjang: ${s.jenjang || '-'}</div>
          </li>`).join('');
          
        nisSuggestions.classList.toggle('hidden', matches.length === 0);
        
        const firstItem = nisSuggestions.querySelector('li');
        if (firstItem) {
            firstItem.classList.add('suggestion-focused');
        }
    });

    kodeBukuSearch.addEventListener('input', () => {
        // ... (Logika search) ...
        // [Tambahkan logika search buku yang sudah ada di kode sebelumnya di sini]

        kodeBukuSearch.classList.remove('filled', 'input-error');
        selectedBuku = { kode: null, judul: null }; 
        
        const val = kodeBukuSearch.value.toLowerCase();
        const suggestionsEl = $('bukuSuggestions');
        
        if(!val){ suggestionsEl.innerHTML=''; suggestionsEl.classList.add('hidden'); return; }
        
        const matches = bukuList.filter(b => b.kode.toLowerCase().includes(val) || b.judul.toLowerCase().includes(val)).slice(0, 10);
        
        suggestionsEl.innerHTML = matches.map(b => `
          <li class="px-3 py-1 hover:bg-cyan-50 cursor-pointer border-b border-gray-100 last:border-b-0" 
              data-kode="${b.kode}" data-judul="${b.judul}" data-kategori="${b.kategori || ''}">
            <div class="font-semibold text-gray-800">${b.judul} (${b.kode})</div>
            <div class="text-xs text-gray-500">Kategori: ${b.kategori || '-'}</div>
          </li>`).join('');
          
        suggestionsEl.classList.toggle('hidden', matches.length === 0);
        
        const firstItem = suggestionsEl.querySelector('li');
        if (firstItem) {
            firstItem.classList.add('suggestion-focused');
        }
    });
    
    blokInput.addEventListener('input', () => { blokInput.value = blokInput.value.toUpperCase(); blokInput.classList.remove('input-error'); });
    jenjangSelect.addEventListener('change', () => { jenjangSelect.classList.remove('input-error'); });
    kategoriBukuSelect.addEventListener('change', () => { kategoriBukuSelect.classList.remove('input-error'); });
    keteranganSelect.addEventListener('change', () => {
        keteranganSelect.classList.remove('input-error');
        keteranganSelect.classList.toggle('filled', !!keteranganSelect.value);
    });

    nisSearch.addEventListener('keydown', (e) => handleKeydown(e, nisSearch, nisSuggestions));
    nisSuggestions.addEventListener('click', e => {
      const li = e.target.closest('li'); if(!li) return;
      selectSuggestion(nisSuggestions, li);
    });
    kodeBukuSearch.addEventListener('keydown', (e) => handleKeydown(e, kodeBukuSearch, bukuSuggestions));
    $('bukuSuggestions').addEventListener('click', e => {
      const li = e.target.closest('li'); if(!li) return;
      selectSuggestion(bukuSuggestions, li);
    });

    document.addEventListener('click', (e) => {
        if (!nisSearch.contains(e.target) && !nisSuggestions.contains(e.target)) {
            nisSuggestions.classList.add('hidden');
        }
        if (!kodeBukuSearch.contains(e.target) && !bukuSuggestions.contains(e.target)) {
            bukuSuggestions.classList.add('hidden');
        }
    });

    // Kontrol Modal
    closeModalBtn.addEventListener('click', hideModal);
    successModal.addEventListener('click', (e) => {
        if (e.target.id === 'successModal') {
            hideModal();
        }
    });

    // --- LOGIKA SUBMIT PENGUNJUNG BARU ---
    $('btnSubmit').addEventListener('click', async () => {
      
      const hasErrors = markEmptyFields();
      if(hasErrors) {
        // PERMINTAAN USER: JIKA ADA ERROR, CUKUP KOTAK MERAH, TIDAK PERLU POP-UP/ALERT
        // Mencari input pertama yang error untuk diberi fokus visual
        const firstError = document.querySelector('.input-error');
        if (firstError) firstError.focus();
        return; 
      }
      
      console.log('Sedang memproses data...');
      
      const santriParsed = parseInput(nisSearch);
      const bukuParsed = parseInput(kodeBukuSearch);

      const now = new Date();
      
      const finalData = {
        nis: santriParsed.id, 
        nama: santriParsed.name, 
        blok: blokInput.value.trim(), 
        jenjang: jenjangSelect.value, 
        kodeBuku: bukuParsed.id,
        judulBuku: bukuParsed.name, 
        kategoriBuku: kategoriBukuSelect.value, 
        keterangan: keteranganSelect.value,
      };
      
      const payload = {
        ...finalData,
        timestamp: now.getTime(),
        tanggal: String(now.getDate()).padStart(2, '0'),
        bulan: String(now.getMonth() + 1).padStart(2, '0'),
        tahun: now.getFullYear(),
        jam: now.toTimeString().substring(0, 5)
      };
        
      try{
        // 1. Update Santri Master
        await set(ref(db, `siswa/${finalData.nis}`), { nama: finalData.nama, blok: finalData.blok, jenjang: finalData.jenjang });

        // 2. Update Buku Master
        await set(ref(db, `buku/${finalData.kodeBuku}`), { judul: finalData.judulBuku, kategori: finalData.kategoriBuku });

        // 3. MENGIRIM DATA KUNJUNGAN BARU
        await push(ref(db, `pengunjung`), payload); 
        
        // JIKA SUKSES: TAMPILKAN POP-UP KUSTOM
        resetForm();
        showModal();
        
      } catch(e){ 
        console.error("Firebase Submit Error:", e); 
        // JIKA GAGAL SISTEM: TETAP TAMPILKAN ALERT/LOG
        alert('GAGAL TOTAL: Kesalahan sistem saat kirim data/perbarui master. Cek Konsol.');
      }
    });

    jenjangSelect.value = '';
    kategoriBukuSelect.value = '';
  </script>
</body>
</html>
