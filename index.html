<!doctype html>
<html lang="id">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Form Kunjungan Perpustakaan | Tema Terang Soft Light</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Poppins', 'sans-serif'],
            },
          }
        }
      }
    </script>

    <style>
      /* ---------------------------------------------------- */
      /* SKEMA WARNA BARU: TEMA TERANG (SOFT LIGHT MODE) DENGAN AKSEN DARK CYAN */
      /* ---------------------------------------------------- */
      :root {
          /* --- Palet Dark Cyan untuk Aksen (Dipertahankan) --- */
          --color-cyan-primary: #00838F;      /* Cyan 800 - Primary/Accent (Darker) */
          --color-cyan-dark: #006064;         /* Cyan 900 - Focus/Dark (Darkest) */
          --color-cyan-light: #4DD0E1;        /* Cyan 400 - Line/Hover */
          
          /* Definisi Palet Terang (Soft Light Mode) */
          --color-light-main-bg: #d0deec;      /* Background Utama (Sangat Terang, off-white) */
          --color-light-container-bg: #FFFFFF; /* Background Kontainer (Putih Bersih) */
          --color-light-border: #D1D5DB;       /* Garis Pembatas (Abu-abu lembut) */
          --color-text-dark: #333333;          /* Teks Utama (Abu-abu gelap lembut) */
          --color-text-secondary: #6B7280;     /* Teks Sekunder/Label (Abu-abu sedang) */
          --color-text-header: #1F2937;        /* Teks Header (Abu-abu ekstra gelap) */

          /* Tambahan untuk Fokus Dropdown Putih Abu */
          --color-soft-gray-focus: #E5E7EB;   /* Gray 200 - Background Fokus Dropdown */
      }

      body {
          font-family: 'Poppins', sans-serif;
          /* Background diubah menjadi Terang */
          background-color: var(--color-light-main-bg); 
          color: var(--color-text-dark);
          display: flex;
          justify-content: center;
          align-items: flex-start;
          min-height: 100vh; 
          padding: 40px 20px;
      }

      #single-form-container {
          max-width: 600px;
          padding: 30px;
          margin: 0 auto;
          /* Container dengan warna terang */
          background: var(--color-light-container-bg); 
          border-radius: 8px; 
          width: 100%;
          /* Tambahkan Shadow lembut untuk kesan "mengambang" */
          box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
          border: 1px solid var(--color-light-border); /* Border lembut */
      }

      h1, .text-3xl {
          color: var(--color-text-header) !important;
          border-color: var(--color-cyan-primary) !important; /* Aksen Cyan tetap */
      }
      
      h3, .text-2xl {
          color: var(--color-text-header) !important;
          border-color: var(--color-light-border) !important; /* Border lembut */
      }

      label {
          display: block;
          margin-top: 20px;
          font-weight: 600;
          color: var(--color-text-secondary); /* Teks label abu-abu */
      }

      /* ---------------------------------------------------- */
      /* GARIS BAWAH CYAN INPUT & DROPDOWN STYLES */
      /* ---------------------------------------------------- */

      .form-group {
          position: relative;
      }

      .input-line-style {
          width: 100%;
          padding: 10px 0;
          margin-top: 5px;
          margin-bottom: 15px;
          border: none;
          outline: none;
          /* Garis default menggunakan Warna Pembatas Terang */
          border-bottom: 2px solid var(--color-light-border); 
          background-color: transparent;
          color: var(--color-text-dark); /* Teks gelap */
          transition: border-bottom-color 0.3s, border-bottom-width 0.3s;
          font-size: 17px;
          box-sizing: border-box;
          appearance: none;

          @apply shadow-none !important;
          border-radius: 0 !important;
      }

      .input-line-style:focus {
          /* Garis focus menggunakan Cyan Primary (Dark Cyan) */
          border-bottom: 3px solid var(--color-cyan-primary);
      }

      /* GAYA ERROR: Garis Merah */
      .input-line-style.input-error {
          border-bottom-color: #EF4444 !important; /* Merah kontras di tema terang */
          border-bottom-width: 3px !important;
          box-shadow: none !important;
      }

      /* Override Select Box */
      #jenjang, #kategoriBuku, #keterangan {
          /* Ganti SVG panah menjadi warna gelap sekunder */
          background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%236B7280'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd' /%3E%3C/svg%3E");
          background-repeat: no-repeat;
          background-position: right 0px center;
          background-size: 1.5em;
          padding-right: 2.5rem;
          background-color: transparent;
          color: var(--color-text-dark);
      }
      
      /* Pastikan option di select terlihat di tema terang */
      select option {
        background-color: var(--color-light-container-bg);
        color: var(--color-text-dark);
      }

      /* ---------------------------------------------------- */
      /* DROPDOWN KUSTOM (SOFT GRAY FOCUS) */
      /* ---------------------------------------------------- */
      .custom-dropdown {
          position: absolute;
          top: calc(100% + 5px);
          left: 0;
          right: 0;
          
          border: 1px solid var(--color-light-border);
          background-color: var(--color-light-container-bg); /* Latar belakang terang */
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); /* Shadow lembut */
          border-radius: 4px;
          
          list-style: none;
          padding: 5px 0;
          margin: 0;
          display: none;
          z-index: 20;
          overflow: hidden;
      }

      .custom-dropdown-item {
          color: var(--color-text-dark); /* Teks gelap default */
          padding: 10px 15px;
          cursor: pointer;
          transition: background-color 0.2s, color 0.2s;
          font-size: 16px;
      }

      /* MODIFIKASI: Fokus menggunakan Putih Abu */
      .custom-dropdown-item:hover,
      .custom-dropdown-item.selected {
          /* Menggunakan warna abu-abu lembut untuk latar belakang */
          background-color: var(--color-soft-gray-focus); 
          /* Mempertahankan warna teks gelap untuk kontras */
          color: var(--color-text-dark); 
      }

      /* Menghapus Efek Stabilo */
      .custom-dropdown-item span.highlight {
          color: inherit; 
          background-color: transparent; 
          font-weight: inherit;
          padding: 0;
          border-radius: 0;
      }

      .custom-dropdown-item.selected span.highlight,
      .custom-dropdown-item:hover span.highlight {
          color: inherit;
          background-color: transparent; 
      }


      /* GAYA TEXT TAMBAHAN DI DROPDOWN ITEM */
      .custom-dropdown-item .text-xs {
          color: var(--color-text-secondary); /* Teks deskripsi abu-abu sekunder */
          margin-top: 2px;
          font-size: 13px;
      }

      .custom-dropdown-item.selected .text-xs,
      .custom-dropdown-item:hover .text-xs {
          /* Teks deskripsi dipertahankan */
          color: var(--color-text-secondary); 
      }

      /* Tombol Submit */
      #btnSubmit {
          /* Warna tombol menggunakan Dark Cyan Primary (Dipertahankan) */
          background-color: var(--color-cyan-primary);
          color: var(--color-light-container-bg); /* Teks Putih */
          padding: 12px 25px;
          border: none;
          border-radius: 6px;
          cursor: pointer;
          margin-top: 30px;
          font-size: 17px;
          font-weight: bold;
          transition: background-color 0.3s, transform 0.1s;
          width: 100%;
          @apply shadow-none hover:shadow-none;
      }
      #btnSubmit:hover {
          /* Warna hover menggunakan Dark Cyan Darker (Dipertahankan) */
          background-color: var(--color-cyan-dark);
          transform: translateY(-1px);
      }

      /* ---------------------------------------------------- */
      /* MODAL (Pop-up Sukses) */
      /* ---------------------------------------------------- */
      .modal-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.4); /* Lebih terang dari sebelumnya (Soft Overlay) */
          display: none;
          justify-content: center;
          align-items: center;
          z-index: 50;
          opacity: 0;
          transition: opacity 0.3s ease-out;
      }

      .modal-overlay.active {
          display: flex;
          opacity: 1;
      }

      .modal-content {
          background: var(--color-light-container-bg); /* Konten modal terang */
          color: var(--color-text-dark);
          padding: 30px;
          border-radius: 12px;
          max-width: 400px;
          width: 90%;
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); /* Shadow lembut */
          transform: translateY(-50px);
          transition: transform 0.3s ease-out;
          border: 1px solid var(--color-cyan-primary); /* Border Dark Cyan */
      }

      /* GAYA TEXT (Tailwind Overrides disesuaikan untuk Light Theme) */
      .text-gray-800 { color: var(--color-text-header); } 
      .text-gray-600 { color: var(--color-text-secondary); } 
      
      /* Mengganti class custom dengan Dark Cyan */
      .border-cyan-500-custom { border-color: var(--color-cyan-primary); }
      
      /* Tambahkan gaya untuk modal icon */
      .text-cyan-500-custom { color: var(--color-cyan-primary); }
      
      /* Tambahkan gaya untuk modal button */
      .bg-cyan-600-custom { 
          background-color: var(--color-cyan-primary);
          color: var(--color-light-container-bg);
          transition: background-color 0.3s;
      }
      .bg-cyan-600-custom:hover {
          background-color: var(--color-cyan-dark);
      }
    </style>
</head>

<body>

    <div id="single-form-container">
      <h1 class="text-3xl font-bold text-gray-800 mb-8 border-b-4 border-cyan-500-custom pb-2">Form Kunjungan Perpustakaan</h1>

      <div class="space-y-6">

          <h3 class="font-bold text-2xl border-b pb-2 text-gray-800 pt-4 mb-4">Data Santri</h3>

          <div class="form-group visible" id="group-santri">
              <label for="nisSearch">Nama, NISN, atau Blok Santri</label>
              <input type="text" id="nisSearch" placeholder="Ketik Nama, NISN, atau Blok..." class="input-line-style" autocomplete="off" autofocus aria-autocomplete="list" aria-controls="dd-nisSearch" data-next-group="group-blok">
              <ul id="dd-nisSearch" class="custom-dropdown" role="listbox"></ul>
          </div>

          <div class="form-group visible" id="group-blok">
              <label for="blok">Blok / Kamar</label>
              <input type="text" id="blok" class="input-line-style" data-next-group="group-jenjang" placeholder="Diisi Otomatis atau Koreksi">
          </div>

          <div class="form-group visible" id="group-jenjang">
              <label for="jenjang">Jenjang Pendidikan</label>
              <select id="jenjang" class="input-line-style" data-next-group="group-bukuSearch">
                  <option value="" selected>-- Pilih Jenjang --</option>
                  <option value="SLTP">SLTP (MTS Sederajat)</option>
                  <option value="SLTA">SLTA (MA Sederajat)</option>
                  <option value="PT">PT (Mahasiswa Sederajat)</option>
              </select>
          </div>

          <h3 class="font-bold text-2xl border-b pb-2 text-gray-800 pt-8 mb-4">Data Buku</h3>

          <div class="form-group visible" id="group-bukuSearch">
              <label for="kodeBukuSearch">Judul & Kode Buku</label>
              <input type="text" id="kodeBukuSearch" placeholder="Ketik Judul atau Kode Buku..." class="input-line-style" autocomplete="off" aria-autocomplete="list" aria-controls="dd-kodeBukuSearch" data-next-group="group-kategoriBuku">
              <ul id="dd-kodeBukuSearch" class="custom-dropdown" role="listbox"></ul>
          </div>

          <div class="form-group visible" id="group-kategoriBuku">
              <label for="kategoriBuku">Kategori Buku</label>
              <select id="kategoriBuku" class="input-line-style" data-next-group="group-keterangan">
                  <option value="" selected>-- Pilih Kategori --</option>
                  <option value="Sejarah dan Geografi">Sejarah dan Geografi</option>
                  <option value="Kesusastraan">Kesusastraan</option>
                  <option value="Komik">Komik</option>
                  <option value="Agama">Agama</option>
                  <option value="Filsafat dan Psikologi">Filsafat dan Psikologi</option>
                  <option value="Ilmu Murni">Ilmu Murni</option>
                  <option value="Ilmu Sosial">Ilmu Sosial</option>
                  <option value="Ilmu Bahasa">Ilmu Bahasa</option>
                  <option value="Berita">Berita</option>
                  <option value="Karya Umum">Karya Umum</option>
                  <option value="Majalah">Majalah</option>
              </select>
          </div>

          <div class="form-group visible" id="group-keterangan">
              <label for="keterangan">Keterangan Aktivitas</label>
              <select id="keterangan" class="input-line-style" data-next-group="group-submit">
                  <option value="">-- Pilih --</option>
                  <option value="Baca">Baca</option>
                  <option value="Pinjam">Pinjam</option>
              </select>
          </div>

          <div class="form-group visible" id="group-submit">
               <button type="button" id="btnSubmit">Kirim Data Kunjungan</button>
          </div>

      </div>
    </div>

    <div id="successModal" class="modal-overlay">
      <div class="modal-content text-center">
        <div class="text-6xl mb-4 text-cyan-500-custom">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <h4 class="text-2xl font-bold text-gray-800 mb-2">Data Kunjungan Berhasil Dikirim!</h4>
        <p class="text-gray-600 mb-6">Terima kasih. Data form telah direset dan siap untuk entri berikutnya.</p>
        <button id="closeModalBtn" class="bg-cyan-600-custom text-white px-6 py-2 rounded-lg font-semibold transition">Tutup</button>
      </div>
    </div>


    <script type="module">
      // --- FIREBASE IMPORTS & CONFIG ---
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
      import { getDatabase, ref, set, onValue, push } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';

      // *** GANTI DENGAN CONFIG FIREBASE ASLI ANDA ***
      const firebaseConfig = {
        apiKey: "AIzaSyB6gaVW3ye680YylqzSebZugmQepYRA4g4", // Ganti
        authDomain: "pengunjung-4489b.firebaseapp.com", // Ganti
        projectId: "pengunjung-4489b", // Ganti
        storageBucket: "pengunjung-4489b.firebasestorage.app", // Ganti
        messagingSenderId: "233634425303", // Ganti
        appId: "1:233634425303:web:9d45d775e703b94843c392", // Ganti
        databaseURL: "https://pengunjung-4489b-default-rtdb.firebaseio.com" // Ganti
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // --- HELPER FUNCTION: TITLE CASE ---
      function titleCase(str) {
          if (!str) return '';
          return str.toLowerCase().split(' ').map(word => {
              if (word.length === 0) return '';
              return (word.charAt(0).toUpperCase() + word.slice(1));
          }).join(' ');
      }
      // -----------------------------------------------------------

      // --- DOM ELEMENTS & STATE ---
      const $ = id => document.getElementById(id);

      const nisSearch = $('nisSearch');
      const kodeBukuSearch = $('kodeBukuSearch');
      const keteranganSelect = $('keterangan');

      // Dropdown Kustom
      const nisDropdown = $('dd-nisSearch');
      const bukuDropdown = $('dd-kodeBukuSearch');

      // Input Detail/Koreksi
      const blokInput = $('blok');
      const jenjangSelect = $('jenjang');
      const kategoriBukuSelect = $('kategoriBuku');

      // Elemen Modal
      const successModal = $('successModal');
      const closeModalBtn = $('closeModalBtn');

      const allInputs = [nisSearch, kodeBukuSearch, keteranganSelect, blokInput, jenjangSelect, kategoriBukuSelect];

      let santriList = [];
      let bukuList = [];
      
      let selectedSantri = { nis: null, nama: null };
      let selectedBuku = { kode: null, judul: null };

      const VALID_JENJANG = ["SLTP", "SLTA", "PT"];
      const VALID_KATEGORI = [
          "Sejarah dan Geografi", "Kesusastraan", "Komik", "Agama",
          "Filsafat dan Psikologi", "Ilmu Murni", "Ilmu Sosial",
          "Ilmu Bahasa", "Berita", "Karya Umum", "Majalah"
      ];

      function parseInput(inputElement) {
          const fullValue = inputElement.value.trim();
          const match = fullValue.match(/\(([^)]+)\)$/);

          if (match) {
              const id = match[1].trim();
              const name = fullValue.replace(match[0], '').trim();
              return { id: id, name: name || id };
          } else {
              return { id: fullValue, name: fullValue };
          }
      }

      function showModal() {
          successModal.classList.add('active');
      }

      function hideModal() {
          successModal.classList.remove('active');
          nisSearch.focus();
      }

      function resetFormDisplay() {
          nisSearch.focus();
      }

      function resetForm() {
          allInputs.forEach(input => {
              input.value = '';
              input.classList.remove('input-error');
              input.setAttribute('aria-expanded', 'false');
          });

          jenjangSelect.value = '';
          kategoriBukuSelect.value = '';

          nisDropdown.innerHTML = '';
          bukuDropdown.innerHTML = '';

          selectedSantri = { nis: null, nama: null };
          selectedBuku = { kode: null, judul: null };
      }

      function markEmptyFields() {
          clearErrorMarks();
          let errorCount = 0;

          if (!nisSearch.value.trim()) { nisSearch.classList.add('input-error'); errorCount++; }
          if (!blokInput.value.trim()) { blokInput.classList.add('input-error'); errorCount++; }
          if (!jenjangSelect.value) { jenjangSelect.classList.add('input-error'); errorCount++; }
          if (!kodeBukuSearch.value.trim()) { kodeBukuSearch.classList.add('input-error'); errorCount++; }
          if (!kategoriBukuSelect.value) { kategoriBukuSelect.classList.add('input-error'); errorCount++; }
          if (!keteranganSelect.value) { keteranganSelect.classList.add('input-error'); errorCount++; }

          return errorCount > 0;
      }

      function clearErrorMarks() {
          allInputs.forEach(input => {
              input.classList.remove('input-error');
          });
      }

      // --- DATA LOADING ---
      
      // 1. Ambil Data Santri
      onValue(ref(db, 'siswa'), (snap) => {
          const data = snap.val();
          santriList = data ? Object.entries(data).map(([nis, val]) => ({ 
              nis, 
              nama: val.nama, 
              blok: val.blok ? titleCase(val.blok) : '', 
              jenjang: val.jenjang ? val.jenjang.toUpperCase() : '' 
          })) : [];
      });

      // 2. Ambil Data Buku
      onValue(ref(db, 'buku'), (snap) => {
          const data = snap.val();
          bukuList = data ? Object.entries(data).map(([kode, val]) => ({ kode, judul: val.judul, kategori: val.kategori || '' })) : [];
      });


      // --- FUNGSI DROPDOWN KUSTOM (Tanpa Riwayat) ---

      function getHighlightedText(fullText, filterText) {
          return fullText;
      }

      function populateCustomDropdown(dropdownEl, matches, keyType, filterText) {
          dropdownEl.innerHTML = '';

          matches.forEach(item => {
              const li = document.createElement('li');
              li.classList.add('custom-dropdown-item');
              li.setAttribute('role', 'option');

              let displayValue;
              let detailsText;

              if (keyType === 'pengunjung') {
                  const namaTitleCase = titleCase(item.nama);
                  displayValue = `${namaTitleCase} (${item.nis})`;
                  detailsText = `Blok: ${item.blok || '-'} | Jenjang: ${item.jenjang || '-'}`;
                  
                  li.setAttribute('data-nis', item.nis);
                  li.setAttribute('data-nama', namaTitleCase); 
                  li.setAttribute('data-blok', item.blok || '');
                  li.setAttribute('data-jenjang', item.jenjang || '');

              } else { // buku
                  const judulTitleCase = titleCase(item.judul);
                  displayValue = `${judulTitleCase} (${item.kode})`;
                  detailsText = `Kategori: ${item.kategori || '-'}`;
                  
                  li.setAttribute('data-kode', item.kode);
                  li.setAttribute('data-judul', judulTitleCase); 
                  li.setAttribute('data-kategori', item.kategori || '');
              }

              li.setAttribute('data-value', displayValue);
              li.setAttribute('data-key-type', keyType);

              // Tampilkan tanpa hitungan riwayat
              li.innerHTML = getHighlightedText(displayValue, filterText) + `<div class="text-xs">${detailsText}</div>`;

              dropdownEl.appendChild(li);
          });

          dropdownEl.style.display = matches.length > 0 ? 'block' : 'none';
          dropdownEl.closest('.form-group').querySelector('input').setAttribute('aria-expanded', matches.length > 0 ? 'true' : 'false');
      }

      // ... (FUNGSI LAINNYA TETAP SAMA) ...

      // Helper untuk menerapkan Title Case dan menjaga kursor
      function applyTitleCaseAndMaintainCursor(inputEl) {
          const start = inputEl.selectionStart;
          const end = inputEl.selectionEnd;
          inputEl.value = titleCase(inputEl.value);
          inputEl.setSelectionRange(start, end);
      }

      function selectSuggestion(inputEl, dropdownEl, li) {
          if (!li) return;

          const keyType = li.getAttribute('data-key-type');
          const selectedValue = li.getAttribute('data-value');

          inputEl.value = selectedValue;
          dropdownEl.style.display = 'none';
          inputEl.setAttribute('aria-expanded', 'false');

          if (keyType === 'pengunjung') {
              selectedSantri.nis = li.dataset.nis;
              selectedSantri.nama = li.dataset.nama; 
              blokInput.value = li.dataset.blok ? titleCase(li.dataset.blok) : '';
              jenjangSelect.value = li.dataset.jenjang || '';

              inputEl.classList.remove('input-error');
              blokInput.classList.remove('input-error');
              jenjangSelect.classList.remove('input-error');

          } else if (keyType === 'buku') {
              selectedBuku.kode = li.dataset.kode;
              selectedBuku.judul = li.dataset.judul; 
              kategoriBukuSelect.value = li.dataset.kategori || '';

              inputEl.classList.remove('input-error');
              kategoriBukuSelect.classList.remove('input-error');
          }

          const nextInput = inputEl.closest('.form-group').nextElementSibling?.querySelector('.input-line-style, button');
          if (nextInput) nextInput.focus();
      }

      function handleKeydown(e, searchInput, dropdownEl) {
          const items = dropdownEl.querySelectorAll('.custom-dropdown-item:not([style*="none"])');
          if (items.length === 0) return;

          let currentFocused = dropdownEl.querySelector('.selected');
          let currentIndex = Array.from(items).indexOf(currentFocused);

          if (e.key === 'ArrowDown') {
              e.preventDefault();
              currentIndex = (currentIndex < items.length - 1) ? currentIndex + 1 : 0;
          } else if (e.key === 'ArrowUp') {
              e.preventDefault();
              currentIndex = (currentIndex > 0) ? currentIndex - 1 : items.length - 1;
          } else if (e.key === 'Enter') {
              e.preventDefault();
              if (currentFocused) {
                  selectSuggestion(searchInput, dropdownEl, currentFocused);
              }
              return;
          } else if (e.key === 'Escape') {
              dropdownEl.style.display = 'none';
              searchInput.setAttribute('aria-expanded', 'false');
              return;
          }

          items.forEach(item => item.classList.remove('selected'));
          if (items[currentIndex]) {
              items[currentIndex].classList.add('selected');
              items[currentIndex].scrollIntoView({ block: "nearest" });
          }
      }

      function handleSearchInput(inputEl, dropdownEl, list, keyType) {
          inputEl.classList.remove('input-error');

          const val = inputEl.value.toLowerCase().trim();

          if (keyType === 'pengunjung') {
              selectedSantri = { nis: null, nama: null };
          } else { 
              selectedBuku = { kode: null, judul: null };
          }

          if(!val){
              dropdownEl.innerHTML='';
              dropdownEl.style.display = 'none';
              inputEl.setAttribute('aria-expanded', 'false');
              return;
          }

          const matches = list.filter(item => {
              const searchField = keyType === 'pengunjung' ? item.nama.toLowerCase() : item.judul.toLowerCase();
              const idField = keyType === 'pengunjung' ? item.nis : item.kode;
              const blockField = (keyType === 'pengunjung' && item.blok) ? item.blok.toLowerCase() : ''; 

              return searchField.includes(val) || idField.includes(val) || blockField.includes(val);
          }).slice(0, 10);

          populateCustomDropdown(dropdownEl, matches, keyType, inputEl.value.trim());

          if (matches.length > 0) {
                const firstItem = dropdownEl.querySelector('.custom-dropdown-item');
                if (firstItem) firstItem.classList.add('selected');
          }
      }


      // Listener Santri
      nisSearch.addEventListener('input', function() {
          applyTitleCaseAndMaintainCursor(this);
          handleSearchInput(this, nisDropdown, santriList, 'pengunjung');
      });
      nisSearch.addEventListener('keydown', (e) => handleKeydown(e, nisSearch, nisDropdown));
      nisDropdown.addEventListener('click', e => {
        const li = e.target.closest('.custom-dropdown-item'); if(!li || li.getAttribute('data-key-type') !== 'pengunjung') return;
        selectSuggestion(nisSearch, nisDropdown, li);
      });

      // Listener Buku
      kodeBukuSearch.addEventListener('input', function() {
          applyTitleCaseAndMaintainCursor(this);
          handleSearchInput(this, bukuDropdown, bukuList, 'buku');
      });
      kodeBukuSearch.addEventListener('keydown', (e) => handleKeydown(e, kodeBukuSearch, bukuDropdown));
      bukuDropdown.addEventListener('click', e => {
        const li = e.target.closest('.custom-dropdown-item'); if(!li || li.getAttribute('data-key-type') !== 'buku') return;
        selectSuggestion(kodeBukuSearch, bukuDropdown, li);
      });

      // Event listener untuk input NON-DROPDOWN
      const nonDropdownInputs = [blokInput, jenjangSelect, kategoriBukuSelect, keteranganSelect];
      nonDropdownInputs.forEach(input => {
          if (input.tagName === 'SELECT') {
              input.addEventListener('change', function() {
                  this.classList.remove('input-error');
                  const nextInput = this.closest('.form-group').nextElementSibling?.querySelector('.input-line-style, button');
                  if (nextInput) nextInput.focus();
              });
          } else { 
              input.addEventListener('keypress', function(e) {
                  if (e.key === 'Enter') {
                      e.preventDefault();
                      this.classList.remove('input-error');
                      const nextInput = this.closest('.form-group').nextElementSibling?.querySelector('.input-line-style, button');
                      if (nextInput) nextInput.focus();
                  }
              });
              input.addEventListener('input', function() {
                  this.classList.remove('input-error');
                  if (this.id === 'blok') {
                      applyTitleCaseAndMaintainCursor(this);
                  }
              });
          }
      });

      // BLUR untuk sembunyikan dropdown
      document.addEventListener('click', (e) => {
          if (!nisSearch.contains(e.target) && !nisDropdown.contains(e.target)) {
              nisDropdown.style.display = 'none';
              nisSearch.setAttribute('aria-expanded', 'false');
          }
          if (!kodeBukuSearch.contains(e.target) && !bukuDropdown.contains(e.target)) {
              bukuDropdown.style.display = 'none';
              kodeBukuSearch.setAttribute('aria-expanded', 'false');
          }
      });

      // Kontrol Modal
      closeModalBtn.addEventListener('click', hideModal);
      successModal.addEventListener('click', (e) => {
          if (e.target.id === 'successModal') {
              hideModal();
          }
      });

      document.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && successModal.classList.contains('active')) {
              e.preventDefault();
              hideModal();
          }
      });
      // ---------------------------------------------------

      // --- LOGIKA SUBMIT PENGUNJUNG BARU ---
      $('btnSubmit').addEventListener('click', async () => {

        const hasErrors = markEmptyFields();
        if(hasErrors) {
          const firstError = document.querySelector('.input-line-style.input-error');
          if (firstError) firstError.focus();
          return;
        }

        const santriParsed = parseInput(nisSearch);
        const bukuParsed = parseInput(kodeBukuSearch);

        const now = new Date();
        const parseDate = (d) => ({
            timestamp: d.getTime(),
            tanggal: String(d.getDate()).padStart(2, '0'),
            bulan: String(d.getMonth() + 1).padStart(2, '0'),
            tahun: d.getFullYear(),
            jam: d.toTimeString().substring(0, 5)
        });

        const finalData = {
          nis: santriParsed.id.trim(), 
          nama: titleCase(santriParsed.name), 
          blok: titleCase(blokInput.value.trim()), 
          jenjang: jenjangSelect.value,
          kodeBuku: bukuParsed.id.trim(), 
          judulBuku: titleCase(bukuParsed.name), 
          kategoriBuku: kategoriBukuSelect.value,
          keterangan: keteranganSelect.value,
        };

        const payload = { ...finalData, ...parseDate(now) };

        try{
          // 1. Update Santri Master 
          await set(ref(db, `siswa/${finalData.nis}`), { nama: finalData.nama, blok: finalData.blok, jenjang: finalData.jenjang });

          // 2. Update Buku Master 
          await set(ref(db, `buku/${finalData.kodeBuku}`), { judul: finalData.judulBuku, kategori: finalData.kategoriBuku });

          // 3. MENGIRIM DATA KUNJUNGAN BARU
          await push(ref(db, `pengunjung`), payload);

          // JIKA SUKSES: Reset form dan tampilkan pop-up
          resetForm();
          showModal();

        } catch(e){
          console.error("Firebase Submit Error:", e);
          alert('GAGAL TOTAL: Kesalahan sistem saat kirim data/perbarui master. Cek Konsol.');
        }
      });
      

      // Init focus & display
      resetFormDisplay();
      nisSearch.focus();
    </script>
</body>
</html>