<!doctype html>
<html lang="id">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Form Kunjungan Perpustakaan</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['Poppins', 'sans-serif'] },
            colors: {
              'primary-indigo': '#4F46E5',
              'accent-cyan': '#06B6D4',
              'dark-bg': '#0F172A',
              'card-bg': '#1E293B',
            }
          }
        }
      }
    </script>

    <style>
      body {
          background-color: #0F172A;
          color: #F1F5F9;
          display: flex;
          justify-content: center;
          padding: 40px 20px;
      }

      .custom-dropdown {
          position: absolute;
          top: 100%;
          left: 0;
          right: 0;
          background: #1E293B;
          border: 1px solid #475569;
          border-radius: 8px;
          margin-top: 4px;
          box-shadow: 0 10px 25px rgba(0,0,0,0.5);
          z-index: 9999;
          max-height: 250px;
          overflow-y: auto;
          display: none;
      }

      .dropdown-item {
          padding: 12px 16px;
          cursor: pointer;
          border-bottom: 1px solid #334155;
      }

      .dropdown-item:hover {
          background-color: #334155;
      }

      .input-field {
          width: 100%;
          background-color: #1E293B;
          border: 1px solid #334155;
          border-radius: 8px;
          padding: 12px;
          color: white;
          outline: none;
          transition: all 0.2s;
          appearance: none;
      }

      /* Fix untuk teks dropdown select di Windows/Chrome */
      select.input-field option {
          background-color: #1E293B;
          color: white;
      }

      .input-field:focus {
          border-color: #06B6D4;
          box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
      }

      /* Perbaikan gaya error agar teks tetap terlihat */
      .input-error {
          border-color: #EF4444 !important;
          background-color: #450a0a !important; /* Latar belakang merah gelap agar teks putih tetap kontras */
          color: #ffffff !important;
          animation: shake 0.2s ease-in-out 0s 2;
      }

      /* Khusus untuk dropdown/select saat error */
      select.input-error option {
          background-color: #1E293B;
          color: white;
      }

      @keyframes shake {
          0% { transform: translateX(0); }
          25% { transform: translateX(5px); }
          50% { transform: translateX(-5px); }
          75% { transform: translateX(5px); }
          100% { transform: translateX(0); }
      }

      ::-webkit-scrollbar { display: none; }
    </style>
</head>

<body class="antialiased">
    <div class="max-w-md w-full mx-auto">
        <div class="bg-card-bg border border-slate-700 p-8 rounded-2xl shadow-2xl">
            <header class="mb-8 text-center">
                <div class="inline-flex p-3 rounded-full bg-primary-indigo/10 mb-4">
                    <svg class="w-8 h-8 text-primary-indigo" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                </div>
                <h1 class="text-2xl font-bold text-white tracking-tight">Kunjungan Perpustakaan</h1>
                <p id="dataStatus" class="text-[10px] text-accent-cyan mt-1 uppercase tracking-widest opacity-70">Menghubungkan Database...</p>
            </header>

            <form id="logForm" class="space-y-4">
                <div class="relative">
                    <input type="text" id="nisSearch" placeholder="Cari Nama / NISN..." class="input-field required-input" autocomplete="off">
                    <ul id="dd-nisSearch" class="custom-dropdown"></ul>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="blok" placeholder="Blok/Kamar" class="input-field required-input">
                    <select id="jenjang" class="input-field required-input">
                        <option value="">Jenjang</option>
                        <option value="SLTP">SLTP</option>
                        <option value="SLTA">SLTA</option>
                        <option value="PT">PT</option>
                    </select>
                </div>

                <div class="relative">
                    <input type="text" id="kodeBukuSearch" placeholder="Cari Judul / Kode Buku..." class="input-field required-input" autocomplete="off">
                    <ul id="dd-kodeBukuSearch" class="custom-dropdown"></ul>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <select id="kategoriBuku" class="input-field required-input text-sm">
                        <option value="">Kategori</option>
                        <option value="Agama">Agama</option>
                        <option value="Filsafat dan Psikologi">Filsafat & Psikologi</option>
                        <option value="Ilmu Sosial">Ilmu Sosial</option>
                        <option value="Ilmu Bahasa">Ilmu Bahasa</option>
                        <option value="Ilmu Murni">Ilmu Murni</option>
                        <option value="Kesenian">Kesenian</option>
                        <option value="Kesusastraan">Kesusastraan</option>
                        <option value="Sejarah dan Geografi">Sejarah & Geografi</option>
                        <option value="Komik">Komik</option>
                        <option value="Managemen">Managemen</option>
                    </select>
                    <select id="keterangan" class="input-field required-input text-sm">
                        <option value="">Aktivitas</option>
                        <option value="Baca">Baca</option>
                        <option value="Pinjam">Pinjam</option>
                    </select>
                </div>

                <button type="button" id="btnSubmit" class="w-full bg-primary-indigo text-white font-bold py-3 rounded-lg mt-2 hover:bg-indigo-700 transition shadow-lg shadow-indigo-500/20">
                    Kirim Laporan
                </button>
            </form>
        </div>
    </div>

    <div id="successModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-[10000]">
        <div class="bg-card-bg p-8 rounded-2xl max-w-xs w-full text-center border border-slate-700">
            <div class="text-accent-cyan text-5xl mb-4">âœ“</div>
            <h2 class="text-xl font-bold text-white mb-6">Data Terkirim</h2>
            <button id="closeModalBtn" class="w-full bg-slate-700 text-white py-2 rounded-lg font-semibold">Tutup</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
        import { getDatabase, ref, onValue, push } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSy_GANTI_INI_DENGAN_KUNCI_API_ASLI",
            authDomain: "traying-29bf4.firebaseapp.com",
            projectId: "traying-29bf4",
            databaseURL: "https://traying-29bf4-default-rtdb.firebaseio.com"
        };
        
        const $ = id => document.getElementById(id);
        const DOM = {
            form: $('logForm'),
            nisSearch: $('nisSearch'),
            kodeBukuSearch: $('kodeBukuSearch'),
            nisDropdown: $('dd-nisSearch'),
            bukuDropdown: $('dd-kodeBukuSearch'),
            blokInput: $('blok'),
            jenjangSelect: $('jenjang'),
            kategoriBukuSelect: $('kategoriBuku'),
            keteranganSelect: $('keterangan'),
            btnSubmit: $('btnSubmit'),
            successModal: $('successModal'),
            closeModalBtn: $('closeModalBtn'),
            dataStatus: $('dataStatus')
        };

        const DATA_PATH = 'log_kunjungan_2025';
        let santriList = [], bukuList = [];

        try {
            const app = initializeApp(firebaseConfig);
            const db = getDatabase(app);

            onValue(ref(db, 'keanggotaan_v2'), (snap) => {
                const data = snap.val();
                santriList = data ? Object.entries(data).map(([nis, v]) => ({ 
                    nis: nis || '', 
                    nama: v.keanggotaan || '', 
                    blok: v.blok || '', 
                    jenjang: v.jenjang || '' 
                })) : [];
                DOM.dataStatus.innerText = "Sistem Siap";
            });

            onValue(ref(db, 'buku_v2'), (snap) => {
                const data = snap.val();
                bukuList = data ? Object.entries(data).map(([kode, v]) => ({ 
                    kode: kode || '', 
                    judul: v.judul || '', 
                    kategori: v.kategori || '' 
                })) : [];
            });

            const handleSearch = (input, dropdown, list, type) => {
                const val = input.value.toLowerCase().trim();
                input.classList.remove('input-error');
                
                if (!val) { dropdown.style.display = 'none'; return; }
                
                const matches = list.filter(item => {
                    const name = type === 'user' ? (item.nama || '') : (item.judul || '');
                    const id = type === 'user' ? (item.nis || '') : (item.kode || '');
                    return name.toLowerCase().includes(val) || id.toLowerCase().includes(val);
                }).slice(0, 5);

                dropdown.innerHTML = '';
                matches.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'dropdown-item';
                    li.innerHTML = type === 'user' 
                        ? `<div class="text-sm font-bold text-white">${item.nama}</div><div class="text-[10px] text-slate-400">${item.nis}</div>`
                        : `<div class="text-sm font-bold text-white">${item.judul}</div><div class="text-[10px] text-slate-400">${item.kode}</div>`;
                    
                    li.onclick = () => {
                        if (type === 'user') {
                            input.value = item.nama;
                            DOM.blokInput.value = item.blok;
                            DOM.jenjangSelect.value = item.jenjang;
                            [DOM.blokInput, DOM.jenjangSelect].forEach(el => el.classList.remove('input-error'));
                        } else {
                            input.value = item.judul;
                            DOM.kategoriBukuSelect.value = item.kategori;
                            DOM.kategoriBukuSelect.classList.remove('input-error');
                        }
                        dropdown.style.display = 'none';
                    };
                    dropdown.appendChild(li);
                });
                dropdown.style.display = matches.length ? 'block' : 'none';
            };

            document.querySelectorAll('.required-input').forEach(el => {
                el.addEventListener('change', () => el.classList.remove('input-error'));
                el.addEventListener('input', () => el.classList.remove('input-error'));
            });

            DOM.nisSearch.addEventListener('input', () => handleSearch(DOM.nisSearch, DOM.nisDropdown, santriList, 'user'));
            DOM.kodeBukuSearch.addEventListener('input', () => handleSearch(DOM.kodeBukuSearch, DOM.bukuDropdown, bukuList, 'buku'));

            DOM.btnSubmit.onclick = async () => {
                const inputs = document.querySelectorAll('.required-input');
                let isValid = true;

                inputs.forEach(input => {
                    if (!input.value.trim()) {
                        input.classList.add('input-error');
                        isValid = false;
                    } else {
                        input.classList.remove('input-error');
                    }
                });

                if (!isValid) return;

                DOM.btnSubmit.disabled = true;
                DOM.btnSubmit.innerText = "Mengirim...";

                const now = new Date();
                const payload = {
                    nama: DOM.nisSearch.value,
                    nis: DOM.nisSearch.value,
                    blok: DOM.blokInput.value,
                    jenjang: DOM.jenjangSelect.value,
                    judulBuku: DOM.kodeBukuSearch.value,
                    kodeBuku: DOM.kodeBukuSearch.value,
                    kategoriBuku: DOM.kategoriBukuSelect.value,
                    keterangan: DOM.keteranganSelect.value,
                    timestamp: now.getTime(),
                    tanggal: String(now.getDate()).padStart(2, '0'),
                    bulan: String(now.getMonth() + 1).padStart(2, '0'),
                    tahun: now.getFullYear(),
                    jam: now.toTimeString().substring(0, 5)
                };

                try {
                    await push(ref(db, DATA_PATH), payload);
                    DOM.successModal.style.display = 'flex';
                    DOM.form.reset();
                } catch (e) { 
                    alert("Gagal menyimpan data."); 
                } finally {
                    DOM.btnSubmit.disabled = false;
                    DOM.btnSubmit.innerText = "Kirim Laporan";
                }
            };

            DOM.closeModalBtn.onclick = () => DOM.successModal.style.display = 'none';
            document.addEventListener('click', (e) => {
                if (!DOM.nisSearch.contains(e.target)) DOM.nisDropdown.style.display = 'none';
                if (!DOM.kodeBukuSearch.contains(e.target)) DOM.bukuDropdown.style.display = 'none';
            });

        } catch (e) { console.error(e); }
    </script>
</body>
</html>
